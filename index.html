<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Adventure Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, .tab-btn, .dice-btn, button {
            font-family: 'MedievalSharp', cursive;
        }
        #app-container, #adventure-detail-view, #player-view-container, #auth-container, .tab-content { display: none; }
        #app-container.active, #adventure-detail-view.active, #player-view-container.active, .tab-content.active { display: block; }
        #auth-container.active { display: flex; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .node-link {
            color: #f87171;
            cursor: pointer;
            text-decoration: underline;
        }
        .node-link:hover {
            color: #fca5a5;
        }
        #character-sheet-modal .cs-main-container {
            background-color: #f5f5dc;
            color: #000000;
        }
        .cs-box {
            background-color: rgba(0,0,0,0.05);
            @apply border border-gray-400 rounded-lg p-2;
        }
        .cs-label {
            @apply block text-xs text-gray-600 uppercase tracking-wider font-bold mb-1;
        }
        .cs-input, .cs-select {
            @apply bg-white w-full text-black text-lg focus:outline-none rounded px-2 py-1 border border-gray-300;
        }
        .cs-stat-box {
            @apply text-white;
            background-color: #d6b885;
        }
        .cs-stat-input {
            @apply bg-transparent w-full text-white text-4xl text-center font-bold focus:outline-none;
        }
        .cs-stat-mod {
            @apply bg-gray-800 rounded-md w-12 h-8 flex items-center justify-center text-lg mx-auto;
        }
        .cs-textarea {
            @apply bg-white w-full h-full text-black text-sm focus:outline-none p-2 rounded-md border border-gray-300;
        }
        details > summary {
            cursor: pointer;
        }
        #character-sheet-modal details > summary {
            color: #991b1b;
        }
        #nodes-panel, #combat-tracker-panel {
            position: sticky;
            top: 1.5rem;
            align-self: start;
            max-height: calc(100vh - 3rem);
            overflow-y: auto;
        }
        .compendium-section summary::-webkit-details-marker { display: none; }
        .compendium-section summary { list-style: none; }
        .compendium-section summary::before {
            content: '►';
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.2s;
        }
        .compendium-section[open] > summary::before { transform: rotate(90deg); }
        .search-highlight {
            background-color: #facc15;
            color: #1f2937;
            padding: 0 2px;
            border-radius: 2px;
        }
        .combatant-item.current-turn {
            background-color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="initial-loader" class="min-h-screen flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <div id="auth-container" class="min-h-screen items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-gray-800 shadow-lg rounded-lg p-8">
                <h1 class="text-3xl font-bold text-center text-red-500 mb-6 tracking-wider">D&D Adventure Manager</h1>
                <form id="login-form">
                    <h2 class="text-2xl text-center mb-4">Accedi</h2>
                    <div class="mb-4"><label for="login-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label><input type="email" id="login-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <div class="mb-6"><label for="login-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label><input type="password" id="login-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Accedi</button>
                    <p class="text-center text-gray-500 text-xs mt-4 font-sans">Non hai un account? <a href="#" id="show-register" class="text-red-400 hover:text-red-300">Registrati</a></p>
                </form>
                <form id="register-form" style="display: none;">
                    <h2 class="text-2xl text-center mb-4">Crea un Account</h2>
                    <div class="mb-4"><label for="register-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label><input type="email" id="register-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <div class="mb-6"><label for="register-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label><input type="password" id="register-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Registrati</button>
                    <p class="text-center text-gray-500 text-xs mt-4 font-sans">Hai già un account? <a href="#" id="show-login" class="text-red-400 hover:text-red-300">Accedi</a></p>
                </form>
                <p id="auth-error" class="text-red-500 text-center text-sm mt-4 font-sans"></p>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex justify-between items-center mb-8">
                <div><h1 class="text-4xl md:text-5xl font-bold text-red-500 tracking-wider">D&D Adventure Manager</h1><p class="text-gray-400 mt-2 font-sans">Il tuo compagno digitale per avventure indimenticabili.</p></div>
                <div id="user-info" class="text-right"><p id="user-email" class="text-gray-300 font-sans"></p><button id="logout-btn" class="text-lg text-red-400 hover:text-red-300">Logout</button></div>
            </header>
            <div class="mb-8"><div class="border-b border-gray-700">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button class="tab-btn active text-red-400 border-red-400 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="dice-roller">Tira Dadi</button>
                    <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="ai-generator">Generatore AI</button>
                    <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="adventures">Le Mie Avventure</button>
                    <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="gm-compendium">Compendio del GM</button>
                    <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="spell-grimoire">Grimorio Incantesimi</button>
                    <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="player-view-master">Vista Giocatore</button>
                </nav>
            </div></div>
            <main>
                <div id="dice-roller" class="tab-content active"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Lancia i Dadi</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6"><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="4">d4</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="6">d6</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="8">d8</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="10">d10</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="12">d12</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="20">d20</button></div><div class="flex flex-wrap items-center gap-4 mb-6 font-sans"><div class="flex items-center gap-2"><label for="dice-count">Numero dadi:</label><input type="number" id="dice-count" value="1" min="1" max="100" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24"></div><div class="flex items-center gap-2"><label for="dice-modifier">Modificatore:</label><input type="number" id="dice-modifier" value="0" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24"></div></div><div id="dice-results-container" class="mt-4 p-4 bg-gray-900 rounded-lg min-h-[100px] flex items-center justify-center font-sans"><span class="text-gray-500">I risultati appariranno qui...</span></div></div></div>
                <div id="ai-generator" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Generatore di Contenuti AI</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><div class="mb-4"><label for="generator-type" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Cosa vuoi generare?</label><select id="generator-type" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans"><option value="PNG">PNG</option><option value="Mostro">Mostro</option><option value="Ambientazione">Ambientazione</option><option value="Mappa">Mappa</option><option value="Tesoro">Tesoro</option></select></div><div class="mb-4"><label for="generator-prompt" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Descrivi la tua idea</label><textarea id="generator-prompt" rows="4" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" placeholder="es. un oste nano brontolone..."></textarea></div><button id="generate-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Genera</button></div><div class="bg-gray-900 p-4 rounded-lg min-h-[250px] flex flex-col items-center justify-center"><div id="generator-result-container" class="flex-grow overflow-y-auto font-sans w-full flex items-center justify-center"><p class="text-gray-500 text-center">I contenuti generati appariranno qui.</p></div><button id="save-to-adventure-btn" class="hidden mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Salva in Avventura</button></div></div></div></div>
                <div id="adventures" class="tab-content"><div id="adventure-list-view" class="active"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Le Mie Avventure</h2><form id="add-adventure-form" class="flex gap-4 mb-6"><div class="flex-grow relative"><input type="text" id="adventure-title-input" placeholder="Titolo della nuova avventura" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500 font-sans pr-16" required><button type="button" class="open-grimoire-btn absolute top-1/2 right-3 -translate-y-1/2 text-yellow-400 hover:text-yellow-300 text-xs font-bold" data-target="#adventure-title-input">📚 SCEGLI</button></div><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi</button></form><div id="adventures-list" class="space-y-3"></div></div></div><div id="adventure-detail-view" style="display: none;"><button id="back-to-list-btn" class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-lg">&larr; Torna alla lista</button><div class="grid grid-cols-1 md:grid-cols-5 gap-6"><aside id="nodes-panel" class="md:col-span-1 bg-gray-800 p-4 rounded-lg space-y-4 h-fit"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Ambienti</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="environments">Nuovo Ambiente</button><div id="environments-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">PNG</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="pngs">Nuovo PNG</button><div id="pngs-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Mappe</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="maps">Nuova Mappa</button><div id="maps-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Tesori</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="treasures">Nuovo Tesoro</button><div id="treasures-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Mostri</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="monsters">Nuovo Mostro</button><div id="monsters-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Immagini</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="images">Nuova Immagine</button><div id="images-list" class="space-y-2"></div></div></aside><section class="md:col-span-2 bg-gray-800 p-6 rounded-lg"><h2 id="adventure-detail-title" class="text-3xl font-bold text-red-400 mb-4"></h2><div id="dm-notes-container" class="mb-6"><h3 class="text-2xl font-bold text-gray-300 mb-4">Appunti Rapidi del DM (salvataggio automatico)</h3><div class="bg-gray-700 rounded-lg p-1"><textarea id="dm-notes-textarea" class="w-full h-48 bg-gray-700 border-none rounded-lg p-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" placeholder="Scrivi qui gli eventi inaspettati, le idee, il bottino trovato, le decisioni dei giocatori..."></textarea></div></div><h3 class="text-2xl font-bold text-gray-300 mb-4">Background / Capitoli</h3><div id="chapters-container" class="space-y-4"></div><button id="add-chapter-btn" class="mt-6 w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi Capitolo</button></section><aside id="combat-tracker-panel" class="md:col-span-2 bg-gray-800 p-4 rounded-lg"><h2 class="text-3xl font-bold text-red-400 mb-4">Tracciatore Combattimento</h2><div id="combat-tracker-content"></div></aside></div></div></div>
                <div id="gm-compendium" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Compendio del GM</h2><div class="mb-6"><input type="search" id="compendium-search" placeholder="Cerca una regola..." class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-red-500 font-sans text-lg"></div><div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700 mb-6"><h3 class="text-2xl text-red-400 font-bold mb-3">Le Tue Avventure Personali</h3><div id="custom-lists-manager" class="space-y-4"></div><div class="mt-4 pt-4 border-t border-gray-600"><form id="add-new-list-form" class="flex gap-2"><input type="text" id="new-list-name-input" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans" placeholder="Nome nuova lista..." required><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg">Crea Lista</button></form></div></div><div id="compendium-sections" class="space-y-3 font-sans"></div></div></div>
                <div id="spell-grimoire" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h2 class="text-3xl font-bold text-red-400">Grimorio degli Incantesimi</h2><button id="add-new-spell-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi Nuovo Incantesimo</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-900/50 p-4 rounded-lg"><input type="search" id="spell-search-input" placeholder="Cerca per nome..." class="bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans"><select id="spell-class-filter" class="bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans"><option value="">Tutte le Classi</option></select><select id="spell-level-filter" class="bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans"><option value="">Tutti i Livelli</option><option value="0">Trucchetti</option><option value="1">Livello 1</option><option value="2">Livello 2</option><option value="3">Livello 3</option><option value="4">Livello 4</option><option value="5">Livello 5</option><option value="6">Livello 6</option><option value="7">Livello 7</option><option value="8">Livello 8</option><option value="9">Livello 9</option></select></div><div id="spell-list-container" class="space-y-2"><p class="text-gray-500 text-center">Caricamento incantesimi...</p></div></div></div>
                <div id="player-view-master" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Condividi con i Giocatori</h2><div id="player-share-content"><p class="text-gray-400 font-sans mb-4">Apri un'avventura per gestire i giocatori.</p></div><div id="master-dice-log-container" class="mt-8 hidden"><h3 class="text-2xl font-bold mb-4 text-gray-300">Registro Tiri in Tempo Reale</h3><div id="master-dice-log" class="p-4 bg-gray-900 rounded-lg min-h-[200px] max-h-[400px] overflow-y-auto font-sans"><span class="text-gray-500">I tiri dei giocatori appariranno qui...</span></div></div></div></div>
            </main>
        </div>
    </div>

    <div id="player-view-container" class="p-4 md:p-8">
        </div>

    <div id="grimoire-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[70]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl border border-red-500 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-3xl font-bold text-red-400">Scegli dalle Tue Avventure Personali</h2>
                <button id="grimoire-modal-close-btn" class="text-3xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="grimoire-modal-content" class="overflow-y-auto font-sans text-gray-300"></div>
        </div>
    </div>
    <div id="spell-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[80]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl border border-red-500 max-h-[90vh] flex flex-col">
            <h2 id="spell-editor-title" class="text-3xl font-bold text-red-400 mb-4 flex-shrink-0">Aggiungi Nuovo Incantesimo</h2>
            <form id="spell-editor-form" class="space-y-2 overflow-y-auto pr-2 flex-grow text-sm font-sans">
                <input type="hidden" id="spell-editor-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div class="md:col-span-2"><label class="block font-bold text-gray-300">Nome Incantesimo</label><input type="text" id="spell-editor-name" class="bg-gray-700 w-full rounded p-2" required></div>
                    <div><label class="block font-bold text-gray-300">Livello</label><select id="spell-editor-level" class="bg-gray-700 w-full rounded p-2"><option value="0">Trucchetto</option><option value="1">1° Livello</option><option value="2">2° Livello</option><option value="3">3° Livello</option><option value="4">4° Livello</option><option value="5">5° Livello</option><option value="6">6° Livello</option><option value="7">7° Livello</option><option value="8">8° Livello</option><option value="9">9° Livello</option></select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div><label class="block font-bold text-gray-300">Scuola di Magia</label><select id="spell-editor-school" class="bg-gray-700 w-full rounded p-2"><option>Abiurazione</option><option>Ammaliamento</option><option>Divinazione</option><option>Evocazione</option><option>Illusione</option><option>Invocazione</option><option>Necromanzia</option><option>Trasmutazione</option></select></div>
                    <div><label class="block font-bold text-gray-300">Tempo di Lancio</label><input type="text" id="spell-editor-casting-time" class="bg-gray-700 w-full rounded p-2" value="1 azione"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div><label class="block font-bold text-gray-300">Gittata</label><input type="text" id="spell-editor-range" class="bg-gray-700 w-full rounded p-2" value="18 metri"></div>
                    <div><label class="block font-bold text-gray-300">Durata</label><input type="text" id="spell-editor-duration" class="bg-gray-700 w-full rounded p-2" value="Istantanea"></div>
                </div>
                <div>
                    <label class="block font-bold text-gray-300">Componenti</label>
                    <div class="flex items-center gap-4 bg-gray-700 p-2 rounded">
                        <label class="flex items-center gap-2"><input type="checkbox" id="spell-editor-comp-v" class="w-4 h-4"> Verbale</label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="spell-editor-comp-s" class="w-4 h-4"> Somatico</label>
                        <div class="flex items-center gap-2 flex-grow"><input type="checkbox" id="spell-editor-comp-m" class="w-4 h-4"><input type="text" id="spell-editor-comp-m-details" class="bg-gray-600 rounded p-1 text-xs w-full" placeholder="Dettagli Materiale..."></div>
                        <label class="flex items-center gap-2 border-l border-gray-500 pl-4"><input type="checkbox" id="spell-editor-concentration" class="w-4 h-4"> Concentrazione</label>
                    </div>
                </div>
                <div><label class="block font-bold text-gray-300">Descrizione</label><textarea id="spell-editor-description" class="bg-gray-700 w-full rounded p-2 h-24"></textarea></div>
                <div><label class="block font-bold text-gray-300">A Livelli Superiori (opzionale)</label><textarea id="spell-editor-higher-levels" class="bg-gray-700 w-full rounded p-2 h-16"></textarea></div>
                <div><label class="block font-bold text-gray-300 mb-1">Classi che possono lanciare questo incantesimo</label><div id="spell-editor-classes" class="grid grid-cols-3 sm:grid-cols-4 gap-2 bg-gray-700 p-2 rounded"></div></div>
                <div class="flex justify-end gap-4 pt-2 flex-shrink-0">
                    <button type="button" id="spell-editor-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Annulla</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salva Incantesimo</button>
                </div>
            </form>
        </div>
    </div>
    <div id="spell-selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[90]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl border border-red-500 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 id="spell-selector-title" class="text-3xl font-bold text-red-400">Aggiungi Incantesimo</h2>
                <button id="spell-selector-close-btn" class="text-3xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 flex-shrink-0">
                <input type="search" id="selector-search-input" placeholder="Cerca..." class="bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans">
                <select id="selector-class-filter" class="bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans"></select>
                <select id="selector-level-filter" class="bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans"></select>
            </div>
            <div id="spell-selector-content" class="overflow-y-auto font-sans text-gray-300 flex-grow"></div>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// --- CONFIGURAZIONE FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyABn9aXZ5jOj2mVftCqiKL2TDZe9cY50dY",
    authDomain: "avventure-dnd.firebaseapp.com",
    projectId: "avventure-dnd",
    storageBucket: "avventure-dnd.appspot.com",
    messagingSenderId: "943269894603",
    appId: "1:943269894603:web:b8851c9862d76486603e4e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- VARIABILI GLOBALI DI STATO ---
let currentUserId = null;
let currentAdventureId = null;
let currentAdventureData = {};
let currentAdventureUnsubscribe = null;
let characterSheetUpdateTimeout = null;
let combatTrackerUpdateTimeout = null;
let dmNotesUpdateTimeout = null;
let userCustomLists = {};
let grimoireTargetInput = null;
let allSpells = [];

// --- GESTIONE URL E VISTA GIOCATORE ---
const urlParams = new URLSearchParams(window.location.search);
const playerViewId = urlParams.get('player_view');
const playerToken = urlParams.get('token');
let playerViewInitialized = false;

// --- COSTANTI DI GIOCO ---
const DND_CLASSES = ["Artefice", "Barbaro", "Bardo", "Chierico", "Druido", "Guerriero", "Ladro", "Mago", "Monaco", "Paladino", "Ranger", "Stregone", "Warlock"];
const DND_RACES = ["Aasimar (Protettore)", "Aasimar (Flagello)", "Aasimar (Caduto)", "Bugbear", "Cangiante", "Centauro", "Dragonide", "Nano (Delle Colline)", "Nano (Delle Montagne)", "Nano (Duergar)", "Elfo (Alto)", "Elfo (Dei Boschi)", "Elfo (Drow)", "Elfo (Shadar-kai)", "Firbolg", "Genasi (Acqua)", "Genasi (Aria)", "Genasi (Fuoco)", "Genasi (Terra)", "Gith (Githyanki)", "Gith (Githzerai)", "Gnomo (Delle Foreste)", "Gnomo (Delle Rocce)", "Goblin", "Goliath", "Halfling (Piedelesto)", "Halfling (Tozzo)", "Hobgoblin", "Kalashtar", "Kenku", "Koboldo", "Leonin", "Lizardfolk", "Loxodon", "Mezzelfo", "Mezzorco", "Minotauro", "Orco", "Satiro", "Shifter", "Simic Hybrid", "Tabaxi", "Tiefling", "Tritone", "Tortle", "Umano", "Umano (Variant)", "Vedalken", "Warforged", "Yuan-ti"];
const DND_SKILLS = { "Acrobazia": "dexterity", "Addestrare Animali": "wisdom", "Arcano": "intelligence", "Atletica": "strength", "Furtività": "dexterity", "Indagare": "intelligence", "Inganno": "charisma", "Intimidire": "charisma", "Intrattenere": "charisma", "Intuizione": "wisdom", "Medicina": "wisdom", "Natura": "intelligence", "Percezione": "wisdom", "Persuasione": "charisma", "Rapidità di Mano": "dexterity", "Religione": "intelligence", "Sopravvivenza": "wisdom", "Storia": "intelligence" };
const DND_SAVES = { "Forza": "strength", "Destrezza": "dexterity", "Costituzione": "constitution", "Intelligenza": "intelligence", "Saggezza": "wisdom", "Carisma": "charisma" };
const SPELL_SCHOOLS = ["Abiurazione", "Ammaliamento", "Divinazione", "Evocazione", "Illusione", "Invocazione", "Necromanzia", "Trasmutazione"];

// --- INIZIALIZZAZIONE E AUTENTICAZIONE ---
onAuthStateChanged(auth, user => {
    document.getElementById('initial-loader').style.display = 'none';
    if (playerViewId && playerToken) {
        if (playerViewInitialized) return;
        playerViewInitialized = true;
        (async () => {
            try {
                if (!auth.currentUser) { await signInAnonymously(auth); }
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('player-view-container').classList.add('active');
                loadPlayerView(playerViewId, playerToken);
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                const container = document.getElementById('player-view-container');
                container.innerHTML = `<div class="text-center p-8"><p class="text-red-500 text-2xl">Impossibile connettersi.</p></div>`;
                container.classList.add('active');
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
            }
        })();
    } else if (user) {
        document.getElementById('auth-container').classList.remove('active');
        document.getElementById('app-container').classList.add('active');
        document.getElementById('player-view-container').style.display = 'none';
        document.getElementById('user-email').textContent = user.email;
        currentUserId = user.uid;
        loadAdventures(user.uid);
        loadUserLists();
        loadAllSpells();
    } else {
        document.getElementById('app-container').classList.remove('active');
        document.getElementById('player-view-container').style.display = 'none';
        document.getElementById('auth-container').classList.add('active');
        currentUserId = null;
    }
});
// --- LOGICA DI BASE E FUNZIONI UTILI ---

function renderDiceLog(containerEl, rolls = []) {
    if (!containerEl) return;
    containerEl.innerHTML = '';
    if (!rolls || rolls.length === 0) {
        containerEl.innerHTML = `<span class="text-gray-500">Nessun tiro ancora effettuato.</span>`;
        return;
    }
    const sortedRolls = [...rolls].sort((a, b) => b.timestamp - a.timestamp);
    sortedRolls.forEach(roll => {
        const rollEl = document.createElement('div');
        rollEl.className = 'p-2 border-b border-gray-700';
        rollEl.innerHTML = `<p class="text-lg"><span class="font-bold text-red-400">${roll.playerName}</span> ha tirato ${roll.rollNotation}: <span class="font-bold text-2xl text-white">${roll.result}</span></p><p class="text-sm text-gray-400">${roll.details}</p>`;
        containerEl.appendChild(rollEl);
    });
}

async function addAndTrimDiceRoll(adventureId, rollData) {
    if (!adventureId) { console.error("ID Avventura non trovato per il tiro."); return; }
    const adventureRef = doc(db, 'publicAdventures', adventureId);
    try {
        const adventureSnap = await getDoc(adventureRef);
        if (adventureSnap.exists()) {
            let diceRolls = adventureSnap.data().diceRolls || [];
            diceRolls.push(rollData);
            if (diceRolls.length > 30) {
                diceRolls = diceRolls.slice(-30);
            }
            await updateDoc(adventureRef, { diceRolls: diceRolls });
        }
    } catch (error) {
        console.error("Errore nell'invio del tiro al log:", error);
    }
}

// --- GESTIONE VISTA GIOCATORE ---
document.getElementById('player-view-container')?.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('player-dice-btn')) return;
    e.preventDefault();
    if (!playerViewId || !playerToken || !currentAdventureData.players) return;
    const btn = e.target;
    const currentPlayer = currentAdventureData.players.find(p => p.token === playerToken);
    if (!currentPlayer) return;
    const sides = parseInt(btn.dataset.sides);
    const modifier = parseInt(document.getElementById('player-dice-modifier').value) || 0;
    const rollResult = Math.floor(Math.random() * sides) + 1;
    const total = rollResult + modifier;
    const rollData = { id: crypto.randomUUID(), playerName: currentPlayer.name, rollNotation: `1d${sides}${modifier !== 0 ? (modifier > 0 ? `+${modifier}` : modifier) : ''}`, result: total, details: `[${rollResult}]${modifier !== 0 ? (modifier > 0 ? ` + ${modifier}` : ` - ${Math.abs(modifier)}`) : ''}`, timestamp: Date.now() };
    await addAndTrimDiceRoll(playerViewId, rollData);
});

function loadPlayerView(adventureId, token) {
    const publicAdventureRef = doc(db, 'publicAdventures', adventureId);
    onSnapshot(publicAdventureRef, (doc) => {
        if (doc.exists()) {
            const data = doc.data();
            currentAdventureData = data;
            const players = data.players || [];
            const currentPlayer = players.find(p => p.token === token);
            if (!currentPlayer) { document.getElementById('player-adventure-title').textContent = "Accesso Negato"; document.getElementById('player-shared-items').innerHTML = '<p class="text-red-500 text-center col-span-full">Questo link non è valido o è scaduto.</p>'; return; }
            document.getElementById('player-adventure-title').textContent = data.title || "Avventura";
            document.getElementById('player-open-sheet-btn').addEventListener('click', () => { openCharacterSheetModal(token, true); });
            const diceLogContainer = document.getElementById('player-dice-log');
            renderDiceLog(diceLogContainer, data.diceRolls);
            const container = document.getElementById('player-shared-items');
            container.innerHTML = '';
            const allSharedItems = data.sharedItems || [];
            const visibleItems = allSharedItems.filter(item => item.sharedWith && (item.sharedWith.includes(token) || item.sharedWith.includes('all')));
            const sharedChapters = visibleItems.filter(item => item.isChapter).sort((a, b) => a.order - b.order);
            const otherItems = visibleItems.filter(item => !item.isChapter);
            if (sharedChapters.length > 0) { sharedChapters.forEach(chapter => { const chapterEl = document.createElement('div'); chapterEl.className = 'bg-gray-800 rounded-lg shadow-lg p-6'; chapterEl.innerHTML = `<h3 class="text-2xl font-bold text-red-400 mb-4">${chapter.title}</h3><p class="text-gray-300 font-sans leading-relaxed">${(chapter.publicContent || '').replace(/\n/g, '<br>')}</p>`; container.appendChild(chapterEl); }); }
            if (otherItems.length > 0) { const otherItemsContainer = document.createElement('div'); otherItemsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8'; otherItems.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'bg-gray-800 rounded-lg shadow-lg p-6'; const imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" class="mb-4 rounded-lg w-full h-auto object-cover" onerror="this.style.display='none'"/>` : ''; itemEl.innerHTML = `<h3 class="text-2xl font-bold text-red-400 mb-2">${item.title}</h3>${imageHtml}<p class="text-gray-300 font-sans">${(item.publicContent || '').replace(/\n/g, '<br>')}</p>`; otherItemsContainer.appendChild(itemEl); }); container.appendChild(otherItemsContainer); }
            if (visibleItems.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center col-span-full">Il Master non ha ancora condiviso nulla con te.</p>'; }
        } else { document.getElementById('player-adventure-title').textContent = "Avventura non trovata"; document.getElementById('player-shared-items').innerHTML = '<p class="text-red-500 text-center col-span-full">Questo link non è valido.</p>'; }
    });
}

// --- GESTIONE FORM DI ACCESSO ---
document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').style.display = 'none'; document.getElementById('register-form').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; createUserWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; signInWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

// --- GESTIONE TAB E DICE ROLLER ---
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const diceButtons = document.querySelectorAll('.dice-btn');
const resultsContainer = document.getElementById('dice-results-container');
const diceCountInput = document.getElementById('dice-count');
const diceModifierInput = document.getElementById('dice-modifier');

tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => { btn.classList.remove('active', 'text-red-400', 'border-red-400'); btn.classList.add('text-gray-400', 'hover:text-white', 'hover:border-gray-300'); }); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active', 'text-red-400', 'border-red-400'); button.classList.remove('text-gray-400'); document.getElementById(button.dataset.tab).classList.add('active'); }); });
diceButtons.forEach(button => button.addEventListener('click', () => { const sides = parseInt(button.dataset.sides); const count = parseInt(diceCountInput.value) || 1; rollDice(sides, count); }));
function rollDice(sides, count) { const modifier = parseInt(diceModifierInput.value) || 0; resultsContainer.innerHTML = ''; let total = 0; let rolls = []; for (let i = 0; i < count; i++) { const result = Math.floor(Math.random() * sides) + 1; rolls.push(result); total += result; } const finalTotal = total + modifier; const resultWrapper = document.createElement('div'); resultWrapper.className = 'text-center'; if (count > 1) { resultWrapper.innerHTML += `<p class="text-lg text-gray-300">Tiri: [${rolls.join(', ')}]</p>`; } const totalText = document.createElement('p'); totalText.className = 'text-4xl font-bold mt-2'; if (modifier !== 0) { const sign = modifier > 0 ? '+' : '-'; totalText.innerHTML = `${total} <span class="text-2xl text-red-400">${sign} ${Math.abs(modifier)}</span> = ${finalTotal}`; } else { totalText.textContent = finalTotal; } resultWrapper.appendChild(totalText); resultsContainer.appendChild(resultWrapper); }

// --- LOGICA GENERATORE AI ---
const GEMINI_API_KEY = "AIzaSyCT74c7GLPJA2E8MsB26s68XgdSosC3bcw";
const generateBtn = document.getElementById('generate-btn');
const generatorType = document.getElementById('generator-type');
const generatorPrompt = document.getElementById('generator-prompt');
const resultContainer = document.getElementById('generator-result-container');
const saveToAdventureBtn = document.getElementById('save-to-adventure-btn');

generateBtn.addEventListener('click', async () => {
    const type = generatorType.value;
    const prompt = generatorPrompt.value.trim();
    if (!prompt) { resultContainer.innerHTML = '<p class="text-yellow-400 text-center">Inserisci una descrizione.</p>'; return; }
    resultContainer.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
    saveToAdventureBtn.style.display = 'none';
    await generateText(type, prompt);
});

async function generateText(type, prompt) {
    let fullPrompt = '';
    if (type === 'Mappa') {
        fullPrompt = `Sei un DM di D&D 5e. Genera la descrizione testuale per un dungeon o una mappa basandoti su questa idea: "${prompt}". Rispondi SOLO con la descrizione. Inizia la risposta direttamente con il nome del luogo in grassetto. Descrivi l'aspetto generale e poi elenca le stanze o le aree principali con un titolo (es. **1. Ingresso**, **2. Sala del Trono**, ecc.) e una breve descrizione per ciascuna. Questa è la parte pubblica. Poi, aggiungi una sezione separata per le note del master che inizia ESATTAMENTE con "---NOTE MASTER---" e che include segreti, trappole, tesori o mostri. Non aggiungere introduzioni o testo extra. Formatta tutto in markdown.`;
    } else {
        fullPrompt = `Sei un DM di D&D 5e. Rispondi SOLO con la descrizione del ${type}. Inizia la risposta direttamente con il nome in grassetto. Basati su questa idea: "${prompt}". Crea prima una descrizione pubblica (aspetto, personalità, ecc.). Poi, aggiungi una sezione separata per le note del master che inizia ESATTAMENTE con "---NOTE MASTER---" e che include segreti, statistiche o spunti di trama. Non aggiungere introduzioni o testo extra. Formatta tutto in markdown.`;
    }
    try {
        const payload = { contents: [{ role: "user", parts: [{ text: fullPrompt }] }] };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`Errore API Testo: ${response.statusText}`);
        const result = await response.json();
        if (result.candidates && result.candidates.length > 0) {
            const text = result.candidates[0].content.parts[0].text;
            resultContainer.innerHTML = `<textarea class="w-full h-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans">${text}</textarea>`;
            saveToAdventureBtn.dataset.type = type;
            saveToAdventureBtn.style.display = 'block';
        } else { throw new Error("Nessun contenuto valido ricevuto dall'API."); }
    } catch (error) { console.error("Errore generazione testo:", error); resultContainer.innerHTML = `<p class="text-red-500 text-center">Si è verificato un errore. Riprova.</p>`; }
}

saveToAdventureBtn.addEventListener('click', async () => {
    if (!currentAdventureId) { alert("Devi prima aprire un'avventura per poter salvare un contenuto."); return; }
    const editTextArea = resultContainer.querySelector('textarea');
    if (!editTextArea) { alert("Nessun contenuto da salvare."); return; }
    const fullContent = editTextArea.value;
    const separator = '---NOTE MASTER---';
    let publicContent = fullContent;
    let masterContent = '';
    if (fullContent.includes(separator)) { const parts = fullContent.split(separator); publicContent = parts[0].trim(); masterContent = parts[1].trim(); }
    const title = (publicContent.split('\n')[0] || "Nuovo Contenuto").replace(/\*|#/g, '').trim();
    const group = prompt(`In quale gruppo vuoi salvare "${title}"?`, "Senza Gruppo");
    if (group === null) return;
    const imageUrl = prompt("URL dell'immagine (opzionale):");
    const newNode = { title, publicContent, masterContent, group, imageUrl: imageUrl || "" };
    const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
    try {
        const type = saveToAdventureBtn.dataset.type;
        const fieldMap = { 'Ambientazione': 'environments', 'Tesoro': 'treasures', 'Mappa': 'maps', 'PNG': 'pngs', 'Mostro': 'monsters' };
        const field = fieldMap[type] || 'environments';
        await updateDoc(adventureRef, { [field]: arrayUnion(newNode) });
        saveToAdventureBtn.textContent = 'Salvato!';
        setTimeout(() => { saveToAdventureBtn.textContent = 'Salva in Avventura'; }, 2000);
    } catch (error) { console.error("Errore salvataggio:", error); alert("Errore durante il salvataggio."); }
});
// --- LOGICA GESTIONE AVVENTURE ---
const addAdventureForm = document.getElementById('add-adventure-form');
const adventureTitleInput = document.getElementById('adventure-title-input');
const adventuresList = document.getElementById('adventures-list');
const adventureListView = document.getElementById('adventure-list-view');
const adventureDetailView = document.getElementById('adventure-detail-view');
const backToListBtn = document.getElementById('back-to-list-btn');

addAdventureForm.addEventListener('submit', async e => {
    e.preventDefault();
    const title = adventureTitleInput.value.trim();
    if (title && currentUserId) {
        const newAdvRef = doc(collection(db, `users/${currentUserId}/adventures`));
        await setDoc(newAdvRef, {
            title,
            ownerId: currentUserId,
            dmNotes: "",
            background: [],
            environments: [],
            pngs: [],
            maps: [],
            treasures: [],
            monsters: [],
            images: [],
            players: [],
            sharedItems: [],
            combatState: createEmptyCombatState(),
            createdAt: serverTimestamp()
        });
        await setDoc(doc(db, 'publicAdventures', newAdvRef.id), {
            title,
            ownerId: currentUserId,
            players: [],
            sharedItems: [],
            diceRolls: []
        });
        adventureTitleInput.value = '';
    }
});

function loadAdventures(userId) {
    const q = query(collection(db, `users/${userId}/adventures`));
    onSnapshot(q, snapshot => {
        if (!adventuresList) return;
        adventuresList.innerHTML = '';
        if (snapshot.empty) {
            adventuresList.innerHTML = '<p class="text-gray-500 text-center font-sans">Nessuna avventura.</p>';
            return;
        }
        snapshot.forEach(doc => {
            const adventure = doc.data();
            const el = document.createElement('div');
            el.className = 'adventure-item bg-gray-700 p-3 rounded-lg flex justify-between items-center';
            el.innerHTML = `<button data-id="${doc.id}" class="adventure-link text-left text-xl flex-grow">${adventure.title}</button><button data-id="${doc.id}" class="delete-btn text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>`;
            adventuresList.appendChild(el);
        });
    });
}

adventuresList.addEventListener('click', async e => {
    const btn = e.target.closest('button[data-id]');
    if (!btn || !btn.dataset.id || !currentUserId) return;
    const docId = btn.dataset.id;
    if (btn.classList.contains('adventure-link')) {
        openAdventureDetail(currentUserId, docId);
    } else if (btn.classList.contains('delete-btn')) {
        if (confirm('Sei sicuro di voler eliminare questa avventura?')) {
            try {
                await deleteDoc(doc(db, `users/${currentUserId}/adventures`, docId));
                await deleteDoc(doc(db, 'publicAdventures', docId));
            } catch (error) {
                console.error("Errore eliminazione: ", error);
            }
        }
    }
});

backToListBtn.addEventListener('click', () => {
    adventureDetailView.style.display = 'none';
    adventureListView.style.display = 'block';
    currentAdventureId = null;
    if (currentAdventureUnsubscribe) { currentAdventureUnsubscribe(); currentAdventureUnsubscribe = null; }
    document.getElementById('player-share-content').innerHTML = '<p class="text-gray-400 font-sans mb-4">Apri un\'avventura per gestire i giocatori.</p>';
    document.getElementById('master-dice-log-container').style.display = 'none';
});

function openAdventureDetail(userId, docId) {
    adventureListView.style.display = 'none';
    adventureDetailView.style.display = 'block';
    currentAdventureId = docId;
    if (currentAdventureUnsubscribe) currentAdventureUnsubscribe();

    const adventureRef = doc(db, `users/${userId}/adventures`, docId);
    const publicAdventureRef = doc(db, 'publicAdventures', docId);
    let privateDataCache = {};

    const privateUnsubscribe = onSnapshot(adventureRef, (doc) => {
        if (!doc.exists()) { backToListBtn.click(); return; }
        privateDataCache = doc.data();
        currentAdventureData = { ...privateDataCache, ...currentAdventureData };
        document.getElementById('adventure-detail-title').textContent = currentAdventureData.title;
        document.getElementById('dm-notes-textarea').value = currentAdventureData.dmNotes || "";
        renderChaptersUI(currentAdventureData.background || []);
        renderGroupedNodes('environments', currentAdventureData.environments || []);
        renderGroupedNodes('pngs', currentAdventureData.pngs || []);
        renderGroupedNodes('maps', currentAdventureData.maps || []);
        renderGroupedNodes('treasures', currentAdventureData.treasures || []);
        renderGroupedNodes('monsters', currentAdventureData.monsters || []);
        renderGroupedNodes('images', currentAdventureData.images || []);
        renderCombatTrackerUI(currentAdventureData.combatState || createEmptyCombatState());
    });

    const publicUnsubscribe = onSnapshot(publicAdventureRef, (publicDoc) => {
        if (!publicDoc.exists()) return;
        const publicData = publicDoc.data();
        currentAdventureData.players = publicData.players || [];
        currentAdventureData.diceRolls = publicData.diceRolls || [];
        if (JSON.stringify(privateDataCache.players) !== JSON.stringify(publicData.players)) {
            updateDoc(adventureRef, { players: publicData.players || [] }).catch(err => console.error("Failed to sync players back to master doc:", err));
        }
        renderPlayerManagementUI(docId, currentAdventureData.players);
        document.getElementById('master-dice-log-container').style.display = 'block';
        renderDiceLog(document.getElementById('master-dice-log'), currentAdventureData.diceRolls);
    });

    currentAdventureUnsubscribe = () => {
        privateUnsubscribe();
        publicUnsubscribe();
    };
}
        // --- LOGICA DI VISUALIZZAZIONE DETTAGLIO AVVENTURA ---

function renderGroupedNodes(type, nodes) {
    const listEl = document.getElementById(`${type}-list`);
    if (!listEl) return;
    listEl.innerHTML = '';
    const typeNameMap = { pngs: 'PNG', maps: 'mappa', environments: 'ambiente', treasures: 'tesoro', monsters: 'mostro', images: 'immagine' };
    const typeName = typeNameMap[type] || 'elemento';
    if (!nodes || nodes.length === 0) {
        listEl.innerHTML = `<p class="text-gray-500 text-sm font-sans">Nessun ${typeName}.</p>`;
        return;
    }
    const groups = nodes.reduce((acc, node) => {
        (acc[node.group || 'Senza Gruppo'] = acc[node.group || 'Senza Gruppo'] || []).push(node);
        return acc;
    }, {});
    for (const groupName in groups) {
        const groupDetails = document.createElement('details');
        groupDetails.className = 'bg-gray-700 rounded-lg';
        let nodesHtml = groups[groupName].map(node => {
            const sharedWith = currentAdventureData.sharedItems?.find(item => item.id === node.title)?.sharedWith || [];
            const shareStatus = sharedWith.length === 0 ? 'Condividi' : (sharedWith.includes('all') ? 'Condiviso con tutti' : `Condiviso con ${sharedWith.length}`);
            const imageHtml = node.imageUrl ? `<img src="${node.imageUrl}" class="my-2 rounded-lg max-w-full h-auto" onerror="this.style.display='none'"/>` : '';
            const masterNotesHtml = node.masterContent ? `<div class="mt-2 pt-2 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-sm">Note Master</h4><div class="text-gray-400 font-sans text-sm">${(node.masterContent).replace(/\n/g, '<br>')}</div></div>` : '';
            return `<div class="p-2 border-t border-gray-600 node-container" data-node-id="${node.title}" data-node-type="${type}"><div class="node-view-mode"><details><summary class="cursor-pointer text-base flex justify-between items-center"><span>${node.title}</span><div class="flex-shrink-0"><button class="edit-node-btn text-gray-400 hover:text-green-500 font-bold px-1">✎</button><button class="delete-node-btn text-gray-400 hover:text-red-500 font-bold px-1">&times;</button></div></summary><div class="node-content-view p-2 mt-2 border-t border-gray-500 font-sans text-sm">${imageHtml}<div>${(node.publicContent || '').replace(/\n/g, '<br>')}</div>${masterNotesHtml}<button class="open-share-modal-btn w-full mt-2 p-1 rounded-lg text-sm bg-blue-600 hover:bg-blue-700">${shareStatus}</button></div></details></div><div class="node-edit-mode hidden p-2 space-y-2"><input type="text" class="node-image-url-edit w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" value="${node.imageUrl || ''}" placeholder="URL Immagine (opzionale)"><div><label class="font-bold text-xs text-gray-400">Descrizione Pubblica</label><textarea class="node-public-content-edit w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans">${node.publicContent || ''}</textarea></div><div><label class="font-bold text-xs text-yellow-400">Note Master (Private)</label><textarea class="node-master-content-edit w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans">${node.masterContent || ''}</textarea></div><div class="flex gap-2 mt-2"><button class="save-node-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base">Salva</button><button class="cancel-edit-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-1 text-base">Annulla</button></div></div></div>`;
        }).join('');
        groupDetails.innerHTML = `<summary class="p-2 cursor-pointer text-lg flex justify-between items-center"><span>${groupName}</span>${groupName !== 'Senza Gruppo' ? `<button class="delete-group-btn text-gray-500 hover:text-red-500 font-bold text-xl px-2" data-group-name="${groupName}" data-node-type="${type}">&times;</button>` : ''}</summary>${nodesHtml}`;
        listEl.appendChild(groupDetails);
    }
}

function renderTextWithLinks(text) {
    const allNodes = [...(currentAdventureData.environments || []), ...(currentAdventureData.pngs || []), ...(currentAdventureData.maps || []), ...(currentAdventureData.treasures || []), ...(currentAdventureData.monsters || []), ...(currentAdventureData.images || [])];
    return (text || '').replace(/\[\[(.*?)\]\]/g, (match, nodeName) => {
        const nodeExists = allNodes.some(node => node.title.toLowerCase() === nodeName.toLowerCase());
        return nodeExists ? `<a href="#" class="node-link" data-node-name="${nodeName}">${nodeName}</a>` : `[[${nodeName}]]`;
    }).replace(/\n/g, '<br>');
}

const nodeModal = document.getElementById('node-modal');
const modalTitle = document.getElementById('modal-title');
const modalContent = document.getElementById('modal-content');
const modalCloseBtn = document.getElementById('modal-close-btn');

document.getElementById('adventure-detail-view')?.addEventListener('click', e => {
    if (e.target.classList.contains('node-link')) {
        e.preventDefault();
        const nodeName = e.target.dataset.nodeName;
        const allNodes = [...(currentAdventureData.environments || []), ...(currentAdventureData.pngs || []), ...(currentAdventureData.maps || []), ...(currentAdventureData.treasures || []), ...(currentAdventureData.monsters || []), ...(currentAdventureData.images || [])];
        const nodeData = allNodes.find(node => node.title.toLowerCase() === nodeName.toLowerCase());
        if (nodeData) {
            modalTitle.textContent = nodeData.title;
            const imageHtml = nodeData.imageUrl ? `<img src="${nodeData.imageUrl}" class="mb-4 rounded-lg max-w-full h-auto" onerror="this.style.display='none'"/>` : '';
            const masterNotesHtml = nodeData.masterContent ? `<div class="mt-4 pt-4 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-lg">Note Master</h4><div class="text-gray-300">${(nodeData.masterContent).replace(/\n/g, '<br>')}</div></div>` : '';
            modalContent.innerHTML = `${imageHtml}${(nodeData.publicContent || '').replace(/\n/g, '<br>')}${masterNotesHtml}`;
            nodeModal.classList.remove('hidden');
        }
    }
});
modalCloseBtn.addEventListener('click', () => nodeModal.classList.add('hidden'));
nodeModal.addEventListener('click', (e) => { if (e.target === nodeModal) nodeModal.classList.add('hidden'); });

document.getElementById('adventure-detail-view')?.addEventListener('click', (e) => {
    if (e.target.classList.contains('node-add-btn')) {
        if (!currentAdventureId) return;
        const type = e.target.dataset.type;
        const typeNameMap = { pngs: 'PNG', maps: 'Mappa', environments: 'Ambiente', treasures: 'Tesoro', monsters: 'Mostro', images: 'Immagine' };
        const typeName = typeNameMap[type];
        if (document.querySelector('.new-node-form-container')) return;
        const listEl = document.getElementById(`${type}-list`);
        const formContainer = document.createElement('div');
        formContainer.className = 'p-2 mb-2 new-node-form-container';
        let formHtml = `<div class="p-3 space-y-2 bg-gray-700 rounded-lg border border-green-500"><h4 class="text-lg text-green-400">Nuovo ${typeName}</h4><input type="text" class="new-node-title w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Titolo" required><input type="text" class="new-node-group w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Gruppo (opzionale)" value="Senza Gruppo"><div class="flex gap-2 mt-2"><button class="save-new-node-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base">Salva</button><button class="cancel-new-node-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-1 text-base">Annulla</button></div></div>`;
        if (type === 'maps' || type === 'images') { formHtml = `<div class="p-3 space-y-2 bg-gray-700 rounded-lg border border-green-500"><h4 class="text-lg text-green-400">Nuova ${typeName}</h4><input type="text" class="new-node-title w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Titolo" required><input type="text" class="new-node-image-url w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="URL Immagine"><textarea class="new-node-public-content w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Descrizione pubblica..."></textarea><textarea class="new-node-master-content w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Note master..."></textarea><input type="text" class="new-node-group w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Gruppo" value="Senza Gruppo"><div class="flex gap-2 mt-2"><button class="save-new-node-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base">Salva ${typeName}</button><button class="cancel-new-node-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-1 text-base">Annulla</button></div></div>`; }
        formContainer.innerHTML = formHtml;
        listEl.prepend(formContainer);
        formContainer.querySelector('.cancel-new-node-btn').addEventListener('click', () => formContainer.remove());
        formContainer.querySelector('.save-new-node-btn').addEventListener('click', async () => {
            const title = formContainer.querySelector('.new-node-title').value.trim();
            if (!title) { alert('Il titolo è obbligatorio.'); return; }
            let newNode = { title, group: formContainer.querySelector('.new-node-group').value.trim() || "Senza Gruppo", publicContent: "", masterContent: "", imageUrl: "" };
            if (type === 'maps' || type === 'images') { newNode.imageUrl = formContainer.querySelector('.new-node-image-url')?.value.trim() || ""; newNode.publicContent = formContainer.querySelector('.new-node-public-content')?.value.trim() || ""; newNode.masterContent = formContainer.querySelector('.new-node-master-content')?.value.trim() || ""; }
            try { await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), { [type]: arrayUnion(newNode) }); formContainer.remove(); } catch (error) { console.error(`Errore aggiunta ${typeName}:`, error); }
        });
    }
});

document.getElementById('adventure-detail-view')?.addEventListener('click', async (e) => {
    const target = e.target;
    const container = target.closest('.node-container');
    if (!currentAdventureId) return;
    const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
    
    if (target.classList.contains('delete-group-btn')) {
        const groupName = target.dataset.groupName;
        const type = target.dataset.nodeType;
        if (!confirm(`Sei sicuro di voler eliminare il gruppo "${groupName}" e tutti i suoi contenuti?`)) return;
        const adventureSnap = await getDoc(adventureRef);
        if (adventureSnap.exists()) {
            const adventureData = adventureSnap.data();
            const nodes = adventureData[type] || [];
            const nodesToDelete = nodes.filter(n => n.group === groupName);
            const nodesToKeep = nodes.filter(n => n.group !== groupName);
            const titlesToDelete = nodesToDelete.map(n => n.title);
            const sharedItemsToKeep = (adventureData.sharedItems || []).filter(item => !titlesToDelete.includes(item.id));
            await updateDoc(adventureRef, { [type]: nodesToKeep, sharedItems: sharedItemsToKeep });
        }
    } else if (container) {
        const nodeId = container.dataset.nodeId;
        const type = container.dataset.nodeType;
        if (target.classList.contains('delete-node-btn')) {
            e.preventDefault();
            if (!confirm(`Sei sicuro di voler eliminare "${nodeId}"?`)) return;
            const adventureSnap = await getDoc(adventureRef);
            if (adventureSnap.exists()) {
                const nodes = adventureSnap.data()[type] || [];
                const nodeToDelete = nodes.find(n => n.title === nodeId);
                const sharedItems = adventureSnap.data().sharedItems || [];
                const sharedItemToDelete = sharedItems.find(item => item.id === nodeId);
                const updatePayload = { [type]: arrayRemove(nodeToDelete) };
                if (sharedItemToDelete) updatePayload.sharedItems = arrayRemove(sharedItemToDelete);
                await updateDoc(adventureRef, updatePayload);
            }
        } else if (target.classList.contains('edit-node-btn')) {
            e.preventDefault();
            container.querySelector('.node-view-mode').classList.add('hidden');
            container.querySelector('.node-edit-mode').classList.remove('hidden');
        } else if (target.classList.contains('cancel-edit-btn')) {
            container.querySelector('.node-view-mode').classList.remove('hidden');
            container.querySelector('.node-edit-mode').classList.add('hidden');
        } else if (target.classList.contains('save-node-btn')) {
            const adventureSnap = await getDoc(adventureRef);
            if (adventureSnap.exists()) {
                const nodes = adventureSnap.data()[type] || [];
                const nodeIndex = nodes.findIndex(n => n.title === nodeId);
                if (nodeIndex !== -1) {
                    const updatedNodes = [...nodes];
                    const newNodeData = { ...updatedNodes[nodeIndex], publicContent: container.querySelector('.node-public-content-edit').value, masterContent: container.querySelector('.node-master-content-edit').value, imageUrl: container.querySelector('.node-image-url-edit').value };
                    updatedNodes[nodeIndex] = newNodeData;
                    const sharedItems = adventureSnap.data().sharedItems || [];
                    const sharedItemIndex = sharedItems.findIndex(item => item.id === nodeId);
                    const updatePayload = { [type]: updatedNodes };
                    let updatedSharedItemsCache = null;
                    if (sharedItemIndex > -1) { 
                        const updatedSharedItems = [...sharedItems]; 
                        updatedSharedItems[sharedItemIndex] = { ...updatedSharedItems[sharedItemIndex], ...newNodeData }; 
                        updatePayload.sharedItems = updatedSharedItems;
                        updatedSharedItemsCache = updatedSharedItems;
                    }
                    await updateDoc(adventureRef, updatePayload);
                    currentAdventureData[type] = updatedNodes;
                    if (updatedSharedItemsCache) {
                        currentAdventureData.sharedItems = updatedSharedItemsCache;
                    }
                    renderGroupedNodes(type, updatedNodes);
                }
            }
        }
    }
});

function renderChaptersUI(chapters = []) {
    const container = document.getElementById('chapters-container');
    if(!container) return;
    container.innerHTML = '';
    if (chapters.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center font-sans p-4">Nessun capitolo. Aggiungine uno!</p>'; return; }
    chapters.forEach(chapter => {
        const sharedWith = currentAdventureData.sharedItems?.find(item => item.id === chapter.id)?.sharedWith || [];
        const shareStatus = sharedWith.length === 0 ? 'Condividi' : (sharedWith.includes('all') ? 'Condiviso con tutti' : `Condiviso con ${sharedWith.length}`);
        const chapterEl = document.createElement('div');
        chapterEl.className = 'chapter-container bg-gray-700 rounded-lg';
        chapterEl.dataset.chapterId = chapter.id;
        chapterEl.innerHTML = `<div class="chapter-view-mode p-4"><div class="flex justify-between items-center mb-2"><h4 class="text-2xl font-bold text-red-400">${chapter.title}</h4><div class="flex items-center gap-2"><button class="open-share-modal-btn text-sm font-bold py-1 px-3 rounded-lg bg-blue-600 hover:bg-blue-700">${shareStatus}</button><button class="edit-chapter-btn text-gray-400 hover:text-green-500 font-bold p-1 text-lg">✎</button><button class="delete-chapter-btn text-gray-400 hover:text-red-500 font-bold p-1 text-xl">&times;</button></div></div><div class="font-sans text-gray-300 border-t border-gray-600 pt-2">${renderTextWithLinks(chapter.publicContent)}</div><div class="mt-2 pt-2 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-sm">Note Master</h4><div class="text-gray-400 font-sans text-sm">${renderTextWithLinks(chapter.masterContent)}</div></div></div><div class="chapter-edit-mode hidden p-4 space-y-2"><label class="font-bold text-sm text-gray-400">Titolo Capitolo</label><input type="text" class="chapter-title-edit w-full bg-gray-600 rounded-lg p-2 font-sans" value="${chapter.title}"><label class="font-bold text-sm text-gray-400">Contenuto Pubblico (per i giocatori)</label><textarea class="chapter-public-content-edit w-full h-32 bg-gray-600 rounded-lg p-2 font-sans">${chapter.publicContent || ''}</textarea><label class="font-bold text-sm text-yellow-400">Note Master (private)</label><textarea class="chapter-master-content-edit w-full h-32 bg-gray-600 rounded-lg p-2 font-sans">${chapter.masterContent || ''}</textarea><div class="flex gap-2 mt-2"><button class="save-chapter-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base">Salva</button><button class="cancel-edit-chapter-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-2 text-base">Annulla</button></div></div>`;
        container.appendChild(chapterEl);
    });
}

document.getElementById('add-chapter-btn')?.addEventListener('click', async () => { if (!currentAdventureId) return; const title = prompt("Titolo del nuovo capitolo:", "Nuovo Capitolo"); if (!title) return; const newChapter = { id: crypto.randomUUID(), title, publicContent: "", masterContent: "", order: (currentAdventureData.background?.length || 0) }; await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), { background: arrayUnion(newChapter) }); });

document.getElementById('chapters-container')?.addEventListener('click', async e => {
    const container = e.target.closest('.chapter-container');
    if (!container) return;
    const chapterId = container.dataset.chapterId;
    const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
    if (e.target.classList.contains('edit-chapter-btn')) { container.querySelector('.chapter-view-mode').classList.add('hidden'); container.querySelector('.chapter-edit-mode').classList.remove('hidden'); } 
    else if (e.target.classList.contains('cancel-edit-chapter-btn')) { container.querySelector('.chapter-view-mode').classList.remove('hidden'); container.querySelector('.chapter-edit-mode').classList.add('hidden'); } 
    else if (e.target.classList.contains('delete-chapter-btn')) { if (!confirm("Sei sicuro di voler eliminare questo capitolo?")) return; const chapterToDelete = currentAdventureData.background.find(c => c.id === chapterId); const sharedItemToDelete = currentAdventureData.sharedItems.find(item => item.id === chapterId); const updatePayload = { background: arrayRemove(chapterToDelete) }; if (sharedItemToDelete) updatePayload.sharedItems = arrayRemove(sharedItemToDelete); await updateDoc(adventureRef, updatePayload); } 
    else if (e.target.classList.contains('save-chapter-btn')) { const newTitle = container.querySelector('.chapter-title-edit').value; const newPublicContent = container.querySelector('.chapter-public-content-edit').value; const newMasterContent = container.querySelector('.chapter-master-content-edit').value; const updatedChapters = currentAdventureData.background.map(c => c.id === chapterId ? { ...c, title: newTitle, publicContent: newPublicContent, masterContent: newMasterContent } : c); const updatedSharedItems = currentAdventureData.sharedItems.map(item => item.id === chapterId ? { ...item, title: newTitle, publicContent: newPublicContent } : item); await updateDoc(adventureRef, { background: updatedChapters, sharedItems: updatedSharedItems }); }
});

function renderPlayerManagementUI(adventureId, players = []) {
    const shareContainer = document.getElementById('player-share-content');
    if (!shareContainer) return;
    const baseUrl = window.location.href.split('?')[0];
    let playerListHtml = players.map(player => `<div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg"><span class="font-sans font-medium text-gray-200">${player.name}</span><div class="flex items-center gap-2"><button class="view-sheet-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm" data-token="${player.token}">Vedi Scheda</button><input type="text" value="${baseUrl}?player_view=${adventureId}&token=${player.token}" class="bg-gray-600 border border-gray-500 rounded-lg p-1 text-sm w-40 md:w-56 font-sans" readonly><button class="copy-player-link-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm" data-link="${baseUrl}?player_view=${adventureId}&token=${player.token}">Copia</button><button class="delete-player-btn text-red-400 hover:text-red-300 font-bold text-xl" data-token="${player.token}">&times;</button></div></div>`).join('');
    shareContainer.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-gray-300">Gestisci Giocatori</h3><form id="add-player-form" class="flex gap-2 mb-4"><input type="text" id="player-name-input" placeholder="Nome del giocatore" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans" required><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Aggiungi</button></form><div id="player-links-list" class="space-y-2">${playerListHtml || '<p class="text-gray-500 font-sans">Nessun giocatore aggiunto.</p>'}</div>`;
    document.getElementById('add-player-form').addEventListener('submit', handleAddPlayer);
    shareContainer.addEventListener('click', (e) => { if (e.target.classList.contains('copy-player-link-btn')) handleCopyLink(e); if (e.target.classList.contains('delete-player-btn')) handleDeletePlayer(e); if (e.target.classList.contains('view-sheet-btn')) openCharacterSheetModal(e.target.dataset.token); });
}

async function handleAddPlayer(e) { e.preventDefault(); if (!currentAdventureId || !currentUserId) return; const nameInput = document.getElementById('player-name-input'); const playerName = nameInput.value.trim(); if (!playerName) return; const newPlayer = { name: playerName, token: crypto.randomUUID(), characterSheet: createEmptyCharacterSheet() }; const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId); const publicAdventureRef = doc(db, 'publicAdventures', currentAdventureId); try { await updateDoc(adventureRef, { players: arrayUnion(newPlayer) }); await updateDoc(publicAdventureRef, { players: arrayUnion(newPlayer) }); nameInput.value = ''; } catch (error) { console.error("Errore aggiunta giocatore:", error); } }
function handleCopyLink(e) { const button = e.target; const link = button.dataset.link; navigator.clipboard.writeText(link).then(() => { button.textContent = 'Copiato!'; button.classList.replace('bg-blue-600', 'bg-green-600'); setTimeout(() => { button.textContent = 'Copia'; button.classList.replace('bg-green-600', 'bg-blue-600'); }, 2000); }); }
async function handleDeletePlayer(e) { if (!currentAdventureId || !currentUserId) return; const tokenToDelete = e.target.dataset.token; if (!confirm("Sei sicuro di voler rimuovere questo giocatore?")) return; const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId); const publicAdventureRef = doc(db, 'publicAdventures', currentAdventureId); const adventureSnap = await getDoc(adventureRef); if (adventureSnap.exists()) { const playerToDelete = (adventureSnap.data().players || []).find(p => p.token === tokenToDelete); if (playerToDelete) { try { await updateDoc(adventureRef, { players: arrayRemove(playerToDelete) }); await updateDoc(publicAdventureRef, { players: arrayRemove(playerToDelete) }); } catch (error) { console.error("Errore rimozione giocatore:", error); } } } }

// --- LOGICA CONDIVISIONE ---
const shareModal = document.getElementById('share-modal');
const shareModalTitle = document.getElementById('share-modal-title');
const sharePlayerList = document.getElementById('share-player-list');
let currentSharingItem = { id: null, type: null };

document.getElementById('adventure-detail-view').addEventListener('click', (e) => {
    if (e.target.classList.contains('open-share-modal-btn')) {
        const chapterContainer = e.target.closest('.chapter-container');
        const nodeContainer = e.target.closest('.node-container');
        if (chapterContainer) { currentSharingItem.id = chapterContainer.dataset.chapterId; currentSharingItem.type = 'chapter'; } 
        else if (nodeContainer) { currentSharingItem.id = nodeContainer.dataset.nodeId; currentSharingItem.type = 'node'; }
        openShareModal();
    }
});
        
        function openShareModal() {
    const players = currentAdventureData.players || [];
    if (players.length === 0) { alert("Aggiungi almeno un giocatore prima di poter condividere."); return; }
    const sharedItem = currentAdventureData.sharedItems?.find(item => item.id === currentSharingItem.id);
    const sharedWith = sharedItem?.sharedWith || [];
    shareModalTitle.textContent = `Condividi "${currentSharingItem.id}"`;
    sharePlayerList.innerHTML = `<div class="flex items-center"><input type="checkbox" id="share-all-players" class="w-4 h-4" ${sharedWith.includes('all') ? 'checked' : ''}><label for="share-all-players" class="ml-2">Tutti i giocatori</label></div><hr class="border-gray-600 my-2">${players.map(p => `<div class="flex items-center"><input type="checkbox" id="share-${p.token}" data-token="${p.token}" class="w-4 h-4 player-checkbox" ${sharedWith.includes(p.token) ? 'checked' : ''}><label for="share-${p.token}" class="ml-2">${p.name}</label></div>`).join('')}`;
    const allPlayersCheckbox = document.getElementById('share-all-players');
    const playerCheckboxes = sharePlayerList.querySelectorAll('.player-checkbox');
    allPlayersCheckbox.addEventListener('change', () => { playerCheckboxes.forEach(cb => { cb.checked = allPlayersCheckbox.checked; cb.disabled = allPlayersCheckbox.checked; }); });
    if (allPlayersCheckbox.checked) { playerCheckboxes.forEach(cb => { cb.disabled = true; }); }
    shareModal.classList.remove('hidden');
}

document.getElementById('share-modal-cancel').addEventListener('click', () => shareModal.classList.add('hidden'));
document.getElementById('share-modal-save').addEventListener('click', async () => {
    const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
    const publicAdventureRef = doc(db, 'publicAdventures', currentAdventureId);
    let sharedWith = [];
    if (document.getElementById('share-all-players').checked) { sharedWith.push('all'); } else { sharePlayerList.querySelectorAll('.player-checkbox:checked').forEach(cb => sharedWith.push(cb.dataset.token)); }
    let sharedItems = [...(currentAdventureData.sharedItems || [])];
    let itemIndex = sharedItems.findIndex(item => item.id === currentSharingItem.id);
    if (sharedWith.length > 0) {
        if (itemIndex > -1) { sharedItems[itemIndex].sharedWith = sharedWith; } else {
            let sourceItem;
            if (currentSharingItem.type === 'chapter') {
                sourceItem = currentAdventureData.background.find(c => c.id === currentSharingItem.id);
                if (sourceItem) sharedItems.push({ ...sourceItem, isChapter: true, sharedWith });
            } else {
                const allNodes = [...(currentAdventureData.environments || []), ...(currentAdventureData.pngs || []), ...(currentAdventureData.maps || []), ...(currentAdventureData.treasures || []), ...(currentAdventureData.monsters || [])];
                sourceItem = allNodes.find(n => n.title === currentSharingItem.id);
                if (sourceItem) sharedItems.push({ ...sourceItem, id: sourceItem.title, isChapter: false, sharedWith });
            }
        }
    } else { if (itemIndex > -1) sharedItems.splice(itemIndex, 1); }
    try {
        await updateDoc(adventureRef, { sharedItems });
        const publicSharedItems = sharedItems.map(item => { const { masterContent, ...publicItem } = item; return publicItem; });
        await updateDoc(publicAdventureRef, { sharedItems: publicSharedItems });
        shareModal.classList.add('hidden');
    } catch (error) { console.error("Errore durante la condivisione:", error); alert("Si è verificato un errore."); }
});

// --- LOGICA SCHEDA PERSONAGGIO ---
const csModal = document.getElementById('character-sheet-modal');
const csModalContent = document.getElementById('cs-modal-content');

function createEmptyCharacterSheet() {
    return {
        characterName: "",
        classes: [{ id: crypto.randomUUID(), name: "Guerriero", level: 1 }],
        background: "", race: "Umano",
        stats: { strength: 10, dexterity: 10, constitution: 10, intelligence: 10, wisdom: 10, charisma: 10 },
        proficiencyBonus: 2, initiativeBonus: 0, speedModifier: "",
        hp: { max: 10, current: 10 }, hitDice: "",
        deathSaves: { successes: [false, false, false], failures: [false, false, false] },
        features: [],
        personalityTraits: "", ideals: "", bonds: "", flaws: "",
        proficiencies: { saves: [], skills: [] },
        defenses: [], weapons: [], equipment: [], companions: [],
        treasure: { cp: 0, sp: 0, gp: 0, pp: 0, other: [] },
        otherProficiencies: "", languages: "",
        senses: { passivePerception: 10, other: "" },
        spellcasting: {
            class: "", ability: "intelligence", saveDC: 0, attackBonus: "+0",
            slots: { 1: {total:0, used:0}, 2: {total:0, used:0}, 3: {total:0, used:0}, 4: {total:0, used:0}, 5: {total:0, used:0}, 6: {total:0, used:0}, 7: {total:0, used:0}, 8: {total:0, used:0}, 9: {total:0, used:0} },
            spells: { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [] }
        }
    };
}
// scheda vecchia
        




// --- INIZIO LOGICA GRIMORIO INCANTESIMI ---

// Costanti e Variabili
const SPELL_SCHOOLS = ["Abiurazione", "Ammaliamento", "Divinazione", "Evocazione", "Illusione", "Invocazione", "Necromanzia", "Trasmutazione"];
const spellEditorModal = document.getElementById('spell-editor-modal');
const spellEditorForm = document.getElementById('spell-editor-form');
const spellSelectorModal = document.getElementById('spell-selector-modal');

// Funzioni Principali
function loadAllSpells() {
    if (!currentUserId) return;
    const spellsRef = collection(db, `users/${currentUserId}/spells`);
    onSnapshot(query(spellsRef), (snapshot) => {
        allSpells = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allSpells.sort((a, b) => a.nome.localeCompare(b.nome));
        populateClassFilter();
        renderGrimorioUI();
    });
}

function populateClassFilter() {
    const allClasses = DND_CLASSES.sort();
    const classFilter = document.getElementById('spell-class-filter');
    const selectorClassFilter = document.getElementById('selector-class-filter');
    const editorClassesContainer = document.getElementById('spell-editor-classes');

    classFilter.innerHTML = '<option value="">Tutte le Classi</option>';
    selectorClassFilter.innerHTML = '<option value="">Tutte le Classi</option>';
    editorClassesContainer.innerHTML = '';

    allClasses.forEach(c => {
        classFilter.innerHTML += `<option value="${c}">${c}</option>`;
        selectorClassFilter.innerHTML += `<option value="${c}">${c}</option>`;
        editorClassesContainer.innerHTML += `<label class="flex items-center gap-2 text-gray-300"><input type="checkbox" value="${c}" class="spell-editor-class-cb w-4 h-4">${c}</label>`;
    });
}

function renderGrimorioUI() {
    const container = document.getElementById('spell-list-container');
    if (!container) return;
    const search = document.getElementById('spell-search-input').value.toLowerCase();
    const className = document.getElementById('spell-class-filter').value;
    const level = document.getElementById('spell-level-filter').value;
    const filteredSpells = allSpells.filter(s => {
        const nameMatch = s.nome.toLowerCase().includes(search);
        const classMatch = !className || (s.classi && s.classi.includes(className));
        const levelMatch = level === "" || s.livello == level;
        return nameMatch && classMatch && levelMatch;
    });
    if (filteredSpells.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Nessun incantesimo trovato con questi filtri.</p>';
        return;
    }
    container.innerHTML = filteredSpells.map(spell => `
        <details class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
            <summary class="flex justify-between items-center cursor-pointer">
                <div><span class="text-xl text-red-400 font-bold">${spell.nome}</span><span class="text-sm text-gray-400 ml-2">(${spell.livello == 0 ? 'Trucchetto' : 'Liv. ' + spell.livello} ${spell.scuola || ''})</span></div>
                <div><button class="edit-spell-btn bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded" data-id="${spell.id}">Modifica</button><button class="delete-spell-btn bg-red-800 text-white text-xs font-bold py-1 px-2 rounded ml-2" data-id="${spell.id}">Elimina</button></div>
            </summary>
            <div class="mt-3 pt-3 border-t border-gray-600 text-gray-300 space-y-1 text-sm">
                <p><strong>Tempo di Lancio:</strong> ${spell.tempo_lancio || ''}</p>
                <p><strong>Gittata:</strong> ${spell.gittata || ''}</p>
                <p><strong>Componenti:</strong> ${[spell.componenti?.v ? 'V' : '', spell.componenti?.s ? 'S' : '', spell.componenti?.m ? `M (${spell.componenti.m_details})` : ''].filter(Boolean).join(', ')}</p>
                <p><strong>Durata:</strong> ${spell.durata || ''} ${spell.concentrazione ? '(Concentrazione)' : ''}</p>
                <p class="mt-2">${(spell.descrizione || '').replace(/\n/g, '<br>')}</p>
                ${spell.livelli_superiori ? `<p class="mt-2"><strong>A Livelli Superiori:</strong> ${(spell.livelli_superiori).replace(/\n/g, '<br>')}</p>` : ''}
                <p class="mt-2 text-xs text-gray-500"><strong>Classi:</strong> ${(spell.classi || []).join(', ')}</p>
            </div>
        </details>`).join('');
}

// Event Listeners per i filtri del Grimorio
document.getElementById('spell-search-input')?.addEventListener('input', renderGrimorioUI);
document.getElementById('spell-class-filter')?.addEventListener('input', renderGrimorioUI);
document.getElementById('spell-level-filter')?.addEventListener('input', renderGrimorioUI);

// Gestione dell'Editor Incantesimi
document.getElementById('add-new-spell-btn')?.addEventListener('click', () => openSpellEditor());
document.getElementById('spell-list-container')?.addEventListener('click', e => {
    if (e.target.classList.contains('edit-spell-btn')) {
        const spell = allSpells.find(s => s.id === e.target.dataset.id);
        if(spell) openSpellEditor(spell);
    }
    if (e.target.classList.contains('delete-spell-btn')) {
        if(confirm('Sei sicuro di voler eliminare questo incantesimo?')) {
            deleteSpell(e.target.dataset.id);
        }
    }
});

function openSpellEditor(spell = null) {
    spellEditorForm.reset();
    document.getElementById('spell-editor-id').value = spell ? spell.id : '';
    document.getElementById('spell-editor-title').textContent = spell ? "Modifica Incantesimo" : "Aggiungi Nuovo Incantesimo";

    if (spell) {
        document.getElementById('spell-editor-name').value = spell.nome || '';
        document.getElementById('spell-editor-level').value = spell.livello || 0;
        document.getElementById('spell-editor-school').value = spell.scuola || 'Invocazione';
        document.getElementById('spell-editor-casting-time').value = spell.tempo_lancio || '';
        document.getElementById('spell-editor-range').value = spell.gittata || '';
        document.getElementById('spell-editor-duration').value = spell.durata || '';
        document.getElementById('spell-editor-comp-v').checked = spell.componenti?.v || false;
        document.getElementById('spell-editor-comp-s').checked = spell.componenti?.s || false;
        document.getElementById('spell-editor-comp-m').checked = spell.componenti?.m || false;
        document.getElementById('spell-editor-comp-m-details').value = spell.componenti?.m_details || '';
        document.getElementById('spell-editor-description').value = spell.descrizione || '';
        document.getElementById('spell-editor-higher-levels').value = spell.livelli_superiori || '';
        document.querySelectorAll('.spell-editor-class-cb').forEach(cb => {
            cb.checked = (spell.classi || []).includes(cb.value);
        });
    }

    spellEditorModal.classList.remove('hidden');
}

spellEditorForm.addEventListener('submit', async e => {
    e.preventDefault();
    const spellId = document.getElementById('spell-editor-id').value;
    const selectedClasses = Array.from(document.querySelectorAll('.spell-editor-class-cb:checked')).map(cb => cb.value);

    const spellData = {
        nome: document.getElementById('spell-editor-name').value,
        livello: parseInt(document.getElementById('spell-editor-level').value),
        scuola: document.getElementById('spell-editor-school').value,
        tempo_lancio: document.getElementById('spell-editor-casting-time').value,
        gittata: document.getElementById('spell-editor-range').value,
        durata: document.getElementById('spell-editor-duration').value,
        componenti: {
            v: document.getElementById('spell-editor-comp-v').checked,
            s: document.getElementById('spell-editor-comp-s').checked,
            m: document.getElementById('spell-editor-comp-m').checked,
            m_details: document.getElementById('spell-editor-comp-m-details').value
        },
        descrizione: document.getElementById('spell-editor-description').value,
        livelli_superiori: document.getElementById('spell-editor-higher-levels').value,
        classi: selectedClasses
    };

    if (spellId) {
        await updateDoc(doc(db, `users/${currentUserId}/spells`, spellId), spellData);
    } else {
        await addDoc(collection(db, `users/${currentUserId}/spells`), spellData);
    }
    spellEditorModal.classList.add('hidden');
});

async function deleteSpell(spellId) {
    await deleteDoc(doc(db, `users/${currentUserId}/spells`, spellId));
}
document.getElementById('spell-editor-cancel-btn')?.addEventListener('click', () => spellEditorModal.classList.add('hidden'));

// Integrazione con la Scheda Personaggio
function openSpellSelectorForCharacter(level) {
    const token = csModal.dataset.currentToken;
    if (!token) return;
    const player = currentAdventureData.players.find(p => p.token === token);
    if (!player) return;

    const spellcastingClass = player.characterSheet?.spellcasting?.class || '';
    document.getElementById('selector-level-filter').innerHTML = Array.from({length: 10}, (_, i) => `<option value="${i}" ${i == level ? 'selected' : ''}>${i === 0 ? 'Trucchetti' : `Livello ${i}`}</option>`).join('');
    document.getElementById('selector-class-filter').value = spellcastingClass;

    renderSpellSelector();
    spellSelectorModal.classList.remove('hidden');
}

function renderSpellSelector() {
    const container = document.getElementById('spell-selector-content');
    const search = document.getElementById('selector-search-input').value.toLowerCase();
    const className = document.getElementById('selector-class-filter').value;
    const level = document.getElementById('selector-level-filter').value;

    const filteredSpells = allSpells.filter(s => {
        const nameMatch = s.nome.toLowerCase().includes(search);
        const classMatch = !className || (s.classi && s.classi.includes(className));
        const levelMatch = level === "" || s.livello == level;
        return nameMatch && classMatch && levelMatch;
    });

    if (filteredSpells.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Nessun incantesimo trovato.</p>'; return;
    }

    container.innerHTML = filteredSpells.map(spell => `
        <div class="flex justify-between items-center p-2 border-b border-gray-700">
            <div>
                <p class="font-bold text-red-400">${spell.nome}</p>
                <p class="text-xs text-gray-400">${spell.scuola}</p>
            </div>
            <button class="add-spell-to-sheet-btn bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded" data-spell-id="${spell.id}">Aggiungi</button>
        </div>
    `).join('');
}

document.getElementById('selector-search-input')?.addEventListener('input', renderSpellSelector);
document.getElementById('selector-class-filter')?.addEventListener('input', renderSpellSelector);
document.getElementById('selector-level-filter')?.addEventListener('input', renderSpellSelector);

document.getElementById('spell-selector-content').addEventListener('click', async e => {
    if (e.target.classList.contains('add-spell-to-sheet-btn')) {
        const spellId = e.target.dataset.spellId;
        const spellToAdd = allSpells.find(s => s.id === spellId);
        if (!spellToAdd) return;

        const token = csModal.dataset.currentToken;
        let sheetData = window.currentSheetData;

        const newSpellData = {
            id: spellToAdd.id,
            name: spellToAdd.nome,
            castingTime: spellToAdd.tempo_lancio,
            range: spellToAdd.gittata,
            duration: spellToAdd.durata,
            concentration: spellToAdd.concentrazione,
            components: spellToAdd.componenti,
            description: spellToAdd.descrizione,
            prepared: false
        };

        if (!sheetData.spellcasting.spells[spellToAdd.livello]) {
            sheetData.spellcasting.spells[spellToAdd.livello] = [];
        }
        sheetData.spellcasting.spells[spellToAdd.livello].push(newSpellData);

        await saveCharacterSheet(token, sheetData);
        populateCharacterSheet(sheetData);
        spellSelectorModal.classList.add('hidden');
    }
});

document.getElementById('spell-selector-close-btn')?.addEventListener('click', () => spellSelectorModal.classList.add('hidden'));
// --- FINE LOGICA GRIMORIO INCANTESIMI ---




        
    </script>
</body>
</html>
