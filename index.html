<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Adventure Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, .tab-btn, .dice-btn, button {
             font-family: 'MedievalSharp', cursive;
        }
        .tab-content, #app-container, #adventure-detail-view {
            display: none;
        }
        .tab-content.active, #app-container.active, #adventure-detail-view.active {
            display: block;
        }
        .dice-result {
            animation: roll 0.5s ease-out;
        }
        @keyframes roll {
            0% { transform: scale(0.5) rotate(0deg); opacity: 0; }
            60% { transform: scale(1.2) rotate(360deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); }
        }
        .adventure-item {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Stile per l'indicatore di caricamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Contenitore Autenticazione -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-gray-800 shadow-lg rounded-lg p-8">
                <h1 class="text-3xl font-bold text-center text-red-500 mb-6 tracking-wider">D&D Adventure Manager</h1>
                <form id="login-form">
                    <h2 class="text-2xl text-center mb-4">Accedi</h2>
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label>
                        <input type="email" id="login-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label>
                        <input type="password" id="login-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Accedi</button>
                    <p class="text-center text-gray-500 text-xs mt-4 font-sans">Non hai un account? <a href="#" id="show-register" class="text-red-400 hover:text-red-300">Registrati</a></p>
                </form>
                <form id="register-form" style="display: none;">
                    <h2 class="text-2xl text-center mb-4">Crea un Account</h2>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label>
                        <input type="email" id="register-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label>
                        <input type="password" id="register-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Registrati</button>
                    <p class="text-center text-gray-500 text-xs mt-4 font-sans">Hai gi√† un account? <a href="#" id="show-login" class="text-red-400 hover:text-red-300">Accedi</a></p>
                </form>
                <p id="auth-error" class="text-red-500 text-center text-sm mt-4 font-sans"></p>
            </div>
        </div>
    </div>

    <!-- Contenitore App Principale -->
    <div id="app-container">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex justify-between items-center mb-8">
                <div>
                   <h1 class="text-4xl md:text-5xl font-bold text-red-500 tracking-wider">D&D Adventure Manager</h1>
                   <p class="text-gray-400 mt-2 font-sans">Il tuo compagno digitale per avventure indimenticabili.</p>
                </div>
                <div id="user-info" class="text-right">
                    <p id="user-email" class="text-gray-300 font-sans"></p>
                    <button id="logout-btn" class="text-lg text-red-400 hover:text-red-300">Logout</button>
                </div>
            </header>

            <!-- Navigazione a Tab -->
            <div class="mb-8">
                <div class="border-b border-gray-700">
                    <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button class="tab-btn active text-red-400 border-red-400 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="dice-roller">Tira Dadi</button>
                        <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="ai-generator">Generatore AI</button>
                        <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="adventures">Le Mie Avventure</button>
                        <button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="player-view">Vista Giocatore</button>
                    </nav>
                </div>
            </div>

            <!-- Contenuto delle Sezioni -->
            <main>
                <div id="dice-roller" class="tab-content active">...</div>
                <div id="ai-generator" class="tab-content">...</div>

                <!-- Sezione Le Mie Avventure -->
                <div id="adventures" class="tab-content">
                    <!-- Vista Lista Avventure -->
                    <div id="adventure-list-view" class="active">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-3xl font-bold mb-4 text-red-400">Le Mie Avventure</h2>
                            <form id="add-adventure-form" class="flex gap-4 mb-6">
                                <input type="text" id="adventure-title-input" placeholder="Titolo della nuova avventura" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required>
                                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi</button>
                            </form>
                            <div id="adventures-list" class="space-y-3">
                                <p class="text-gray-500 text-center font-sans">Nessuna avventura.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Vista Dettaglio Avventura -->
                    <div id="adventure-detail-view">
                        <button id="back-to-list-btn" class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-lg">&larr; Torna alla lista</button>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Colonna Sinistra: Ambienti -->
                            <aside class="md:col-span-1 bg-gray-800 p-4 rounded-lg">
                                <h3 class="text-2xl font-bold text-red-400 mb-4">Ambienti</h3>
                                <div id="environments-list" class="space-y-2">
                                    <!-- Esempio di ambiente -->
                                    <details class="bg-gray-700 rounded-lg">
                                        <summary class="p-2 cursor-pointer text-lg">Taverna del Drago Assopito</summary>
                                        <div class="p-2 border-t border-gray-600 font-sans">
                                            <p>Contenuto della taverna...</p>
                                        </div>
                                    </details>
                                    <p class="text-gray-500 text-sm font-sans">Aggiungi nuovi ambienti...</p>
                                </div>
                            </aside>
                            <!-- Colonna Destra: Contenuto Principale -->
                            <section class="md:col-span-3 bg-gray-800 p-6 rounded-lg">
                                <h2 id="adventure-detail-title" class="text-3xl font-bold text-red-400 mb-4">Titolo Avventura</h2>
                                <h3 class="text-2xl font-bold text-gray-300 mb-2">Background</h3>
                                <textarea id="adventure-background-textarea" class="w-full h-96 bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" placeholder="Scrivi qui il background dell'avventura..."></textarea>
                                <p id="save-status" class="text-sm text-gray-500 mt-2 h-4 font-sans"></p>
                            </section>
                        </div>
                    </div>
                </div>

                 <div id="player-view" class="tab-content">...</div>
            </main>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, orderBy, serverTimestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configurazione del tuo progetto Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABn9aXZ5jOj2mVftCqiKL2TDZe9cY50dY",
            authDomain: "avventure-dnd.firebaseapp.com",
            projectId: "avventure-dnd",
            storageBucket: "avventure-dnd.appspot.com",
            messagingSenderId: "943269894603",
            appId: "1:943269894603:web:b8851c9862d76486603e4e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Elementi DOM ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        let currentUserId = null;
        
        // --- Logica di Autenticazione ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authContainer.style.display = 'none';
                appContainer.classList.add('active');
                document.getElementById('user-email').textContent = user.email;
                currentUserId = user.uid;
                loadAdventures(user.uid);
            } else {
                appContainer.classList.remove('active');
                authContainer.style.display = 'flex';
                currentUserId = null;
            }
        });
        // (listeners per login, register, logout omessi per brevit√†, sono invariati)
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').style.display = 'none'; document.getElementById('register-form').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
        document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; createUserWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; signInWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

        // --- Logica UI Tabs ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-red-400', 'border-red-400');
                    btn.classList.add('text-gray-400', 'hover:text-white', 'hover:border-gray-300');
                });
                tabContents.forEach(content => content.classList.remove('active'));
                
                button.classList.add('active', 'text-red-400', 'border-red-400');
                button.classList.remove('text-gray-400');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // --- Logica Avventure ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const addAdventureForm = document.getElementById('add-adventure-form');
        const adventureTitleInput = document.getElementById('adventure-title-input');
        const adventuresList = document.getElementById('adventures-list');
        const adventureListView = document.getElementById('adventure-list-view');
        const adventureDetailView = document.getElementById('adventure-detail-view');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const adventureDetailTitle = document.getElementById('adventure-detail-title');
        const backgroundTextarea = document.getElementById('adventure-background-textarea');
        const saveStatus = document.getElementById('save-status');
        let backgroundSaveTimeout;

        // Salva una nuova avventura
        addAdventureForm.addEventListener('submit', e => {
            e.preventDefault();
            const title = adventureTitleInput.value.trim();
            if (title && currentUserId) saveNewAdventure(currentUserId, title);
            adventureTitleInput.value = '';
        });
        async function saveNewAdventure(userId, title) {
            const collectionPath = `/artifacts/${appId}/users/${userId}/adventures`;
            try { await addDoc(collection(db, collectionPath), { 
                title, 
                background: "", // Aggiunge campo background vuoto
                environments: [], // Aggiunge campo ambienti vuoto
                createdAt: serverTimestamp() 
            }); } 
            catch (e) { console.error("Errore salvataggio: ", e); }
        }

        // Carica la lista delle avventure
        function loadAdventures(userId) {
            const collectionPath = `/artifacts/${appId}/users/${userId}/adventures`;
            const q = query(collection(db, collectionPath), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                adventuresList.innerHTML = '';
                if (snapshot.empty) { adventuresList.innerHTML = '<p class="text-gray-500 text-center font-sans">Nessuna avventura.</p>'; return; }
                snapshot.forEach(doc => {
                    const adventure = doc.data();
                    const el = document.createElement('div');
                    el.className = 'adventure-item bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                    el.innerHTML = `<button data-id="${doc.id}" class="adventure-link text-left text-xl flex-grow">${adventure.title}</button>
                                    <button data-id="${doc.id}" class="delete-btn text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>`;
                    adventuresList.appendChild(el);
                });
            });
        }
        
        // Gestisce i click nella lista (apri o cancella)
        adventuresList.addEventListener('click', async e => {
            const target = e.target;
            const docId = target.dataset.id;
            if (!docId || !currentUserId) return;

            if (target.classList.contains('adventure-link')) {
                openAdventureDetail(currentUserId, docId);
            } else if (target.classList.contains('delete-btn')) {
                const docPath = `/artifacts/${appId}/users/${currentUserId}/adventures/${docId}`;
                if (confirm('Sei sicuro di voler eliminare questa avventura?')) {
                    try { await deleteDoc(doc(db, docPath)); } 
                    catch (error) { console.error("Errore eliminazione: ", error); }
                }
            }
        });

        // Apre la vista di dettaglio
        async function openAdventureDetail(userId, docId) {
            adventureListView.classList.remove('active');
            adventureDetailView.classList.add('active');
            
            const docPath = `/artifacts/${appId}/users/${userId}/adventures/${docId}`;
            const docSnap = await getDoc(doc(db, docPath));

            if (docSnap.exists()) {
                const adventure = docSnap.data();
                adventureDetailTitle.textContent = adventure.title;
                backgroundTextarea.value = adventure.background || "";
                backgroundTextarea.dataset.docPath = docPath; // Salva il path per usi futuri
                // Qui popoleremo la lista degli ambienti
            } else {
                console.error("Avventura non trovata!");
            }
        }

        // Salva le modifiche al background
        backgroundTextarea.addEventListener('keyup', () => {
            clearTimeout(backgroundSaveTimeout);
            saveStatus.textContent = 'Sto scrivendo...';
            backgroundSaveTimeout = setTimeout(async () => {
                saveStatus.textContent = 'Salvataggio...';
                const docPath = backgroundTextarea.dataset.docPath;
                if (docPath) {
                    await updateDoc(doc(db, docPath), {
                        background: backgroundTextarea.value
                    });
                    saveStatus.textContent = 'Salvato!';
                    setTimeout(() => saveStatus.textContent = '', 2000);
                }
            }, 1000); // Salva 1 secondo dopo che l'utente smette di scrivere
        });

        // Torna alla lista
        backToListBtn.addEventListener('click', () => {
            adventureDetailView.classList.remove('active');
            adventureListView.classList.add('active');
        });

        // (Logica Tira Dadi e Generatore AI omessa per brevit√†, √® invariata)

    </script>
</body>
</html>
