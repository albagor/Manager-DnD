<!DOCTYPE html>
<html lang="it" class="bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Adventure Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, .tab-btn, .dice-btn, button {
             font-family: 'MedievalSharp', cursive;
        }
        #app-container, #adventure-detail-view, #player-view-container, #auth-container, .tab-content { display: none; }
        #app-container.active, #adventure-detail-view.active, #player-view-container.active, .tab-content.active { display: block; }
        #auth-container.active { display: flex; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .node-link {
            color: #f87171; /* text-red-400 */
            cursor: pointer;
            text-decoration: underline;
        }
        .node-link:hover {
            color: #fca5a5; /* text-red-300 */
        }
        /* Stili per la scheda del personaggio */
        #character-sheet-modal .cs-main-container {
            background-color: #f5f5dc; /* Beige */
            color: #000000; /* Nero */
        }
        .cs-box {
            background-color: rgba(0,0,0,0.05);
            @apply border border-gray-400 rounded-lg p-2;
        }
        .cs-label {
            @apply block text-xs text-gray-600 uppercase tracking-wider font-bold mb-1;
        }
        .cs-input, .cs-select {
            @apply bg-white w-full text-black text-lg focus:outline-none rounded px-2 py-1 border border-gray-300;
        }
        .cs-stat-box {
            @apply text-white;
            background-color: #d6b885; /* beige naturale per contrasto */
        }
        .cs-stat-input {
            @apply bg-transparent w-full text-white text-4xl text-center font-bold focus:outline-none;
        }
        .cs-stat-mod {
            @apply bg-gray-800 rounded-md w-12 h-8 flex items-center justify-center text-lg mx-auto;
        }
        .cs-textarea {
            @apply bg-white w-full h-full text-black text-sm focus:outline-none p-2 rounded-md border border-gray-300;
        }
        details > summary {
            cursor: pointer;
        }
        #character-sheet-modal details > summary {
            color: #991b1b; /* text-red-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

<!-- Initial Loading Indicator -->
<div id="initial-loader" class="min-h-screen flex items-center justify-center">
    <div class="loader"></div>
</div>

<!-- Contenitore Autenticazione -->
<div id="auth-container" class="min-h-screen items-center justify-center p-4">
    <div class="w-full max-w-md">
        <div class="bg-gray-800 shadow-lg rounded-lg p-8">
            <h1 class="text-3xl font-bold text-center text-red-500 mb-6 tracking-wider">D&D Adventure Manager</h1>
            <form id="login-form">
                <h2 class="text-2xl text-center mb-4">Accedi</h2>
                <div class="mb-4"><label for="login-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label><input type="email" id="login-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                <div class="mb-6"><label for="login-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label><input type="password" id="login-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Accedi</button>
                <p class="text-center text-gray-500 text-xs mt-4 font-sans">Non hai un account? <a href="#" id="show-register" class="text-red-400 hover:text-red-300">Registrati</a></p>
            </form>
            <form id="register-form" style="display: none;">
                <h2 class="text-2xl text-center mb-4">Crea un Account</h2>
                <div class="mb-4"><label for="register-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label><input type="email" id="register-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                <div class="mb-6"><label for="register-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label><input type="password" id="register-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Registrati</button>
                <p class="text-center text-gray-500 text-xs mt-4 font-sans">Hai gi√† un account? <a href="#" id="show-login" class="text-red-400 hover:text-red-300">Accedi</a></p>
            </form>
            <p id="auth-error" class="text-red-500 text-center text-sm mt-4 font-sans"></p>
        </div>
    </div>
</div>

<!-- Contenitore App Principale (per il Master) -->
<div id="app-container">
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <div><h1 class="text-4xl md:text-5xl font-bold text-red-500 tracking-wider">D&D Adventure Manager</h1><p class="text-gray-400 mt-2 font-sans">Il tuo compagno digitale per avventure indimenticabili.</p></div>
            <div id="user-info" class="text-right"><p id="user-email" class="text-gray-300 font-sans"></p><button id="logout-btn" class="text-lg text-red-400 hover:text-red-300">Logout</button></div>
        </header>
        <div class="mb-8"><div class="border-b border-gray-700"><nav class="flex flex-wrap -mb-px" aria-label="Tabs"><button class="tab-btn active text-red-400 border-red-400 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="dice-roller">Tira Dadi</button><button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="ai-generator">Generatore AI</button><button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="adventures">Le Mie Avventure</button><button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="player-view-master">Vista Giocatore</button></nav></div></div>
        <main>
            <div id="dice-roller" class="tab-content active"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Lancia i Dadi</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6"><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="4">d4</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="6">d6</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="8">d8</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="10">d10</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="12">d12</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="20">d20</button></div><div class="flex flex-wrap items-center gap-4 mb-6 font-sans"><div class="flex items-center gap-2"><label for="dice-count">Numero dadi:</label><input type="number" id="dice-count" value="1" min="1" max="100" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24"></div><div class="flex items-center gap-2"><label for="dice-modifier">Modificatore:</label><input type="number" id="dice-modifier" value="0" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24"></div></div><div id="dice-results-container" class="mt-4 p-4 bg-gray-900 rounded-lg min-h-[100px] flex items-center justify-center font-sans"><span class="text-gray-500">I risultati appariranno qui...</span></div></div></div>
            <div id="ai-generator" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Generatore di Contenuti AI</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><div class="mb-4"><label for="generator-type" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Cosa vuoi generare?</label><select id="generator-type" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans"><option value="PNG">PNG</option><option value="Mostro">Mostro</option><option value="Ambientazione">Ambientazione</option><option value="Mappa">Mappa</option><option value="Tesoro">Tesoro</option></select></div><div class="mb-4"><label for="generator-prompt" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Descrivi la tua idea</label><textarea id="generator-prompt" rows="4" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" placeholder="es. un oste nano brontolone..."></textarea></div><button id="generate-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Genera</button></div><div class="bg-gray-900 p-4 rounded-lg min-h-[250px] flex flex-col items-center justify-center"><div id="generator-result-container" class="flex-grow overflow-y-auto font-sans w-full flex items-center justify-center"><p class="text-gray-500 text-center">I contenuti generati appariranno qui.</p></div><button id="save-to-adventure-btn" class="hidden mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Salva in Avventura</button></div></div></div></div>
            <div id="adventures" class="tab-content"><div id="adventure-list-view" class="active"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Le Mie Avventure</h2><form id="add-adventure-form" class="flex gap-4 mb-6"><input type="text" id="adventure-title-input" placeholder="Titolo della nuova avventura" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi</button></form><div id="adventures-list" class="space-y-3"></div></div></div>
                <div id="adventure-detail-view" style="display: none;">
                    <button id="back-to-list-btn" class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-lg">&larr; Torna alla lista</button>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <aside class="lg:col-span-1 bg-gray-800 p-4 rounded-lg space-y-4 self-start">
                            <div><h3 class="text-2xl font-bold text-red-400 mb-2">Ambienti</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="environments">Nuovo Ambiente</button><div id="environments-list" class="space-y-2"></div></div><hr class="border-gray-600">
                            <div><h3 class="text-2xl font-bold text-red-400 mb-2">PNG</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="pngs">Nuovo PNG</button><div id="pngs-list" class="space-y-2"></div></div><hr class="border-gray-600">
                            <div><h3 class="text-2xl font-bold text-red-400 mb-2">Mappe</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="maps">Nuova Mappa</button><div id="maps-list" class="space-y-2"></div></div><hr class="border-gray-600">
                            <div><h3 class="text-2xl font-bold text-red-400 mb-2">Tesori</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="treasures">Nuovo Tesoro</button><div id="treasures-list" class="space-y-2"></div></div><hr class="border-gray-600">
                            <div><h3 class="text-2xl font-bold text-red-400 mb-2">Mostri</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="monsters">Nuovo Mostro</button><div id="monsters-list" class="space-y-2"></div></div><hr class="border-gray-600">
                            <div><h3 class="text-2xl font-bold text-red-400 mb-2">Immagini</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="images">Nuova Immagine</button><div id="images-list" class="space-y-2"></div></div>
                        </aside>
                        <section class="lg:col-span-3 bg-gray-800 p-6 rounded-lg">
                            <h2 id="adventure-detail-title" class="text-3xl font-bold text-red-400 mb-4"></h2>
                            <h3 class="text-2xl font-bold text-gray-300 mb-4">Background / Capitoli</h3>
                            <div id="chapters-container" class="space-y-4"></div>
                            <button id="add-chapter-btn" class="mt-6 w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi Capitolo</button>
                        </section>
                        <div id="dm-dashboard" class="lg:col-span-1 space-y-4 lg:sticky top-6 self-start">
                            <!-- DM Dashboard Content -->
                        </div>
                    </div>
                </div>
            </div>
            <div id="player-view-master" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Condividi con i Giocatori</h2><div id="player-share-content"><p class="text-gray-400 font-sans mb-4">Apri un'avventura per gestire i giocatori.</p></div><div id="master-dice-log-container" class="mt-8 hidden"><h3 class="text-2xl font-bold mb-4 text-gray-300">Registro Tiri in Tempo Reale</h3><div id="master-dice-log" class="p-4 bg-gray-900 rounded-lg min-h-[200px] max-h-[400px] overflow-y-auto font-sans"><span class="text-gray-500">I tiri dei giocatori appariranno qui...</span></div></div></div></div>
        </main>
    </div>
</div>

<!-- Contenitore Vista Giocatore -->
<div id="player-view-container" class="p-4 md:p-8">
    <div class="flex justify-between items-center mb-8">
        <h1 id="player-adventure-title" class="text-4xl md:text-5xl font-bold text-red-500 tracking-wider"></h1>
        <button id="player-open-sheet-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">La Mia Scheda</button>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-8"><h2 class="text-3xl font-bold mb-4 text-red-400">Lancia i Dadi</h2><div class="grid grid-cols-3 sm:grid-cols-6 gap-4 mb-4"><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="4">d4</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="6">d6</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="8">d8</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="10">d10</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="12">d12</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="20">d20</button></div><div class="flex items-center gap-2 mb-4 font-sans"><label for="player-dice-modifier">Modificatore:</label><input type="number" id="player-dice-modifier" value="0" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24 text-white"></div><div id="player-dice-log" class="mt-4 p-4 bg-gray-900 rounded-lg min-h-[150px] max-h-[300px] overflow-y-auto font-sans"><span class="text-gray-500">I tiri dei dadi appariranno qui...</span></div></div>
    <div id="player-shared-items" class="space-y-8"></div>
</div>

<!-- Finestra Modale per i Nodi -->
<div id="node-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl border border-red-500"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-3xl font-bold text-red-400"></h2><button id="modal-close-btn" class="text-3xl text-gray-400 hover:text-white">&times;</button></div><div id="modal-content" class="font-sans text-gray-300 max-h-[70vh] overflow-y-auto"></div></div></div>
<!-- Finestra Modale per la Condivisione -->
<div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md border border-red-500"><h2 id="share-modal-title" class="text-3xl font-bold text-red-400 mb-4">Condividi Contenuto</h2><div id="share-player-list" class="space-y-2 mb-6 font-sans"></div><div class="flex gap-4"><button id="share-modal-save" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Salva</button><button id="share-modal-cancel" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-lg">Annulla</button></div></div></div>
<!-- Finestra Modale per Iniziativa -->
<div id="initiative-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg border border-red-500"><h2 class="text-3xl font-bold text-red-400 mb-4">Imposta Iniziativa</h2><div id="initiative-modal-list" class="space-y-2 max-h-[60vh] overflow-y-auto font-sans"></div><div class="flex gap-4 mt-6"><button id="confirm-initiative-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Inizia Combattimento</button><button id="cancel-initiative-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-lg">Annulla</button></div></div></div>
<!-- Finestra Modale Scheda Personaggio -->
<div id="character-sheet-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-50">
    <div class="cs-main-container rounded-lg shadow-xl w-full max-w-6xl h-[95vh] border-2 border-red-800 flex flex-col">
        <div class="flex justify-between items-center p-3 border-b border-gray-400 flex-shrink-0">
            <h2 id="cs-modal-title" class="text-2xl font-bold text-red-800">Scheda Personaggio</h2>
            <button id="cs-modal-close-btn" class="text-3xl text-gray-600 hover:text-black">&times;</button>
        </div>
        <div id="cs-modal-content" class="p-2 sm:p-4 overflow-y-auto flex-grow font-sans">
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400" open>
                <summary class="text-2xl text-red-800 font-bold">Anagrafica & Background</summary>
                <div class="mt-2 pt-2 border-t border-gray-400">
                    <div class="grid grid-cols-1 md:grid-cols-10 gap-2 mb-2">
                        <div class="cs-box md:col-span-4"><label class="cs-label">Nome Personaggio</label><input type="text" class="cs-input text-2xl" data-field="characterName"></div>
                        <div class="cs-box md:col-span-2" id="cs-race-container"><label class="cs-label">Razza</label></div>
                        <div class="cs-box md:col-span-2"><label class="cs-label">Background</label><input type="text" class="cs-input" data-field="background"></div>
                        <div class="cs-box md:col-span-2 text-center"><label class="cs-label">Livello Totale</label><input type="number" id="cs-total-level" class="cs-input text-3xl text-center max-w-[80px] mx-auto" readonly></div>
                    </div>
                    <div class="cs-box mb-2"><label class="cs-label">Classi & Livelli</label><div id="cs-classes-list" class="space-y-1 mt-1"></div><button id="cs-add-class-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Classe</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                        <div class="cs-box h-32"><label class="cs-label">Tratti Personali</label><textarea class="cs-textarea" data-field="personalityTraits"></textarea></div>
                        <div class="cs-box h-32"><label class="cs-label">Ideali</label><textarea class="cs-textarea" data-field="ideals"></textarea></div>
                        <div class="cs-box h-32"><label class="cs-label">Legami</label><textarea class="cs-textarea" data-field="bonds"></textarea></div>
                        <div class="cs-box h-32"><label class="cs-label">Difetti</label><textarea class="cs-textarea" data-field="flaws"></textarea></div>
                    </div>
                </div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400" open>
                <summary class="text-2xl text-red-800 font-bold">Caratteristiche & Combattimento</summary>
                <div class="mt-2 pt-2 border-t border-gray-400 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <div class="cs-stat-box"><label class="cs-label">Forza</label><input type="number" class="cs-stat-input" data-field="stats.strength"><div class="cs-stat-mod" data-mod="strength">+0</div></div>
                            <div class="cs-stat-box"><label class="cs-label">Destrezza</label><input type="number" class="cs-stat-input" data-field="stats.dexterity"><div class="cs-stat-mod" data-mod="dexterity">+0</div></div>
                            <div class="cs-stat-box"><label class="cs-label">Costituzione</label><input type="number" class="cs-stat-input" data-field="stats.constitution"><div class="cs-stat-mod" data-mod="constitution">+0</div></div>
                            <div class="cs-stat-box"><label class="cs-label">Intelligenza</label><input type="number" class="cs-stat-input" data-field="stats.intelligence"><div class="cs-stat-mod" data-mod="intelligence">+0</div></div>
                            <div class="cs-stat-box"><label class="cs-label">Saggezza</label><input type="number" class="cs-stat-input" data-field="stats.wisdom"><div class="cs-stat-mod" data-mod="wisdom">+0</div></div>
                            <div class="cs-stat-box"><label class="cs-label">Carisma</label><input type="number" class="cs-stat-input" data-field="stats.charisma"><div class="cs-stat-mod" data-mod="charisma">+0</div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="cs-box"><label class="cs-label">Bonus Competenza</label><input type="text" class="cs-input text-center" data-field="proficiencyBonus" readonly></div>
                            <div class="cs-box"><label class="cs-label">Percezione Passiva</label><input type="text" class="cs-input text-center" data-field="senses.passivePerception" readonly></div>
                        </div>
                        <div class="cs-box mt-2" id="saving-throws-list"></div><div class="cs-box mt-2" id="skills-list"></div>
                    </div>
                    <div class="space-y-2">
                         <div class="grid grid-cols-2 gap-2">
                            <div class="cs-box text-center"><label class="cs-label">Classe Armatura</label><input type="number" class="cs-input text-3xl text-center max-w-[90px]" data-field="armorClass" readonly></div>
                           <div class="cs-box text-center"><label class="cs-label">Iniziativa</label><div class="flex items-center justify-center"><input type="text" id="cs-initiative-total" class="cs-input text-3xl text-center max-w-[80px] mx-auto" readonly><input type="number" data-field="initiativeBonus" class="cs-input text-sm w-20 ml-2 max-w-[70px]" placeholder="Bonus"></div></div>
                        </div>
                        <div class="cs-box"><label class="cs-label">Velocit√†</label><div class="flex gap-2 items-center"><input type="text" id="cs-speed-auto" class="cs-input text-center max-w-[80px]" readonly><input type="text" data-field="speedModifier" id="cs-speed-modifier" class="cs-input text-center max-w-[100px]" placeholder="Bonus/Malus"></div><small class="text-xs text-gray-500 font-sans">Velocit√† base calcolata da razza/classe.</small></div>
                        <div class="cs-box"><label class="cs-label">Punti Ferita</label><div class="grid grid-cols-2 gap-2"><div><label class="text-xs">Massimi</label><input type="number" class="cs-input" data-field="hp.max"></div><div><label class="text-xs">Attuali</label><input type="number" class="cs-input" data-field="hp.current"></div></div></div>
                        <div class="cs-box"><label class="cs-label">Dadi Vita</label><input type="text" class="cs-input" data-field="hitDice"></div>
                        <div class="cs-box" id="cs-death-saves">
                            <label class="cs-label">Tiri Salvezza contro Morte</label>
                            <div class="flex justify-around items-center mt-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm">Successi</span>
                                    <input type="checkbox" data-death-save-success="0" class="w-5 h-5">
                                    <input type="checkbox" data-death-save-success="1" class="w-5 h-5">
                                    <input type="checkbox" data-death-save-success="2" class="w-5 h-5">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm">Fallimenti</span>
                                    <input type="checkbox" data-death-save-failure="0" class="w-5 h-5">
                                    <input type="checkbox" data-death-save-failure="1" class="w-5 h-5">
                                    <input type="checkbox" data-death-save-failure="2" class="w-5 h-5">
                                </div>
                            </div>
                        </div>
                        <div class="cs-box"><label class="cs-label mb-2">Difese</label><div id="cs-defenses-list" class="space-y-1"></div><button id="cs-add-defense-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Difesa</button></div>
                    </div>
                </div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400" open>
              <summary class="text-2xl text-red-800 font-bold">Armi & Attacchi</summary>
              <div class="mt-2 pt-2 border-t border-gray-400"><div id="weapons-list-container" class="space-y-2"></div><button id="add-weapon-btn" class="mt-2 bg-green-700 hover:bg-green-800 rounded p-2 text-white">Aggiungi Arma</button></div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                <summary class="text-2xl text-red-800 font-bold">Privilegi & Tratti</summary>
                <div class="mt-2 pt-2 border-t border-gray-400">
                    <div class="cs-box h-[32rem] flex flex-col">
                        <div id="cs-features-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
                        <button id="cs-add-feature-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Privilegio / Tratto</button>
                    </div>
                </div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                <summary class="text-2xl text-red-800 font-bold">Altre Competenze & Linguaggi</summary>
                <div class="mt-2 pt-2 border-t border-gray-400 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="cs-box h-48"><label class="cs-label">Competenze (Armature, Armi, Strumenti)</label><textarea class="cs-textarea" data-field="otherProficiencies"></textarea></div>
                    <div class="cs-box h-48"><label class="cs-label">Linguaggi</label><textarea class="cs-textarea" data-field="languages"></textarea></div>
                </div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                <summary class="text-2xl text-red-800 font-bold">Equipaggiamento & Tesoro</summary>
                <div class="mt-2 pt-2 border-t border-gray-400 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="cs-box h-96 flex flex-col"><label class="cs-label">Equipaggiamento</label><div id="cs-equipment-list" class="flex-grow overflow-y-auto pr-2 space-y-1"></div><button id="cs-add-equipment-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Oggetto</button></div>
                    </div>
                    <div>
                        <div class="flex gap-4 h-full">
                            <div class="cs-box w-32 flex-shrink-0">
                                <div class="space-y-3">
                                    <div class="text-center"><label class="cs-label">MR</label><input type="number" class="cs-input text-center" data-field="treasure.cp"></div>
                                    <div class="text-center"><label class="cs-label">MA</label><input type="number" class="cs-input text-center" data-field="treasure.sp"></div>
                                    <div class="text-center"><label class="cs-label">MO</label><input type="number" class="cs-input text-center" data-field="treasure.gp"></div>
                                    <div class="text-center"><label class="cs-label">MP</label><input type="number" class="cs-input text-center" data-field="treasure.pp"></div>
                                </div>
                            </div>
                            <div class="cs-box flex-grow h-[384px] flex flex-col">
                                <label class="cs-label">Altri Tesori</label>
                                <div id="cs-other-treasures-list" class="flex-grow overflow-y-auto pr-2 space-y-1"></div>
                                <button id="cs-add-treasure-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Tesoro</button>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                <summary class="text-2xl text-red-800 font-bold">Compagni & Gregari</summary>
                <div class="mt-2 pt-2 border-t border-gray-400">
                    <div id="cs-companions-list" class="space-y-3"></div>
                    <button id="cs-add-companion-btn" class="mt-3 w-full bg-green-700 hover:bg-green-800 rounded p-2 text-white">Aggiungi Compagno / Gregario</button>
                </div>
            </details>
            <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                <summary class="text-2xl text-red-800 font-bold">Incantesimi</summary>
                <div class="mt-2 pt-2 border-t border-gray-400">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
                        <div class="cs-box"><label class="cs-label">Classe da Incantatore</label><input type="text" class="cs-input" data-field="spellcasting.class"></div>
                        <div class="cs-box"><label class="cs-label">Caratteristica</label><select class="cs-select" data-field="spellcasting.ability"><option value="strength">Forza</option><option value="dexterity">Destrezza</option><option value="constitution">Costituzione</option><option value="intelligence">Intelligenza</option><option value="wisdom">Saggezza</option><option value="charisma">Carisma</option></select></div>
                        <div class="cs-box"><label class="cs-label">CD Tiro Salvezza</label><input type="number" class="cs-input text-center" data-field="spellcasting.saveDC" readonly></div>
                        <div class="cs-box"><label class="cs-label">Bonus Attacco Inc.</label><input type="text" class="cs-input text-center" data-field="spellcasting.attackBonus" readonly></div>
                    </div>
                    <div id="cs-spell-levels-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                </div>
            </details>
        </div>
    </div>
</div>

<!-- === MODALI SCHEDA PERSONAGGIO === -->
<div id="weapon-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-2" id="weapon-modal-title">Aggiungi/Modifica Arma</h3><form id="weapon-form" class="space-y-2"><input type="hidden" id="weapon-index" value=""><div><label class="block text-xs font-bold mb-1">Nome Arma</label><input type="text" id="weapon-name" class="cs-input" required></div><div><label class="block text-xs font-bold mb-1">Tipo</label><select id="weapon-type" class="cs-select"><option value="mischia">Mischia</option><option value="distanza">Distanza</option><option value="altro">Altro</option></select></div><div id="weapon-ammo-container" class="hidden"><label class="block text-xs font-bold mb-1">Tipo Munizione (es. Frecce)</label><input type="text" id="weapon-ammunition-type" class="cs-input"></div><div><label class="block text-xs font-bold mb-1">Caratteristica per l'Attacco (Override)</label><select id="weapon-override-stat" class="cs-select"><option value="default">Default</option><option value="strength">Forza</option><option value="dexterity">Destrezza</option><option value="constitution">Costituzione</option><option value="intelligence">Intelligenza</option><option value="wisdom">Saggezza</option><option value="charisma">Carisma</option></select></div><div><label class="block text-xs font-bold mb-1">Danno (es: 1d8)</label><input type="text" id="weapon-damage" class="cs-input" required></div><div class="flex items-center gap-2 mt-1"><input type="checkbox" id="weapon-versatile-checkbox"><label for="weapon-versatile-checkbox" class="text-xs font-bold">Versatile?</label></div><div id="weapon-versatile-container" class="hidden"><label class="block text-xs font-bold mb-1">Danno Versatile (es: 1d10)</label><input type="text" id="weapon-versatile-damage" class="cs-input"></div><div><label class="block text-xs font-bold mb-1">Tipo Danno</label><input type="text" id="weapon-damage-type" class="cs-input" placeholder="tagliente, contundente..."></div><div><label class="block text-xs font-bold mb-1">Propriet√† (es. accurata)</label><input type="text" id="weapon-properties" class="cs-input" placeholder="leggera, versatile, accurata..."></div><div><label class="block text-xs font-bold mb-1">Competenza?</label><input type="checkbox" id="weapon-proficient"></div><div><label class="block text-xs font-bold mb-1">Bonus/Malus Attacco</label><input type="number" id="weapon-attack-bonus" class="cs-input" value="0"></div><div><label class="block text-xs font-bold mb-1">Bonus/Malus Danni</label><input type="number" id="weapon-damage-bonus" class="cs-input" value="0"></div><div class="flex gap-2 mt-2"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base text-white">Salva</button><button type="button" id="weapon-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-1 text-base text-white">Annulla</button></div></form></div></div>
<div id="equipment-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4" id="equipment-modal-title">Oggetto</h3><form id="equipment-form" class="space-y-3"><input type="hidden" id="equipment-id"><div><label class="block text-sm font-bold mb-1">Nome Oggetto</label><input type="text" id="equipment-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Quantit√†</label><input type="number" id="equipment-quantity" class="cs-input" value="1"></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="equipment-description" class="cs-textarea h-24"></textarea></div><div class="flex items-center gap-2 mt-1"><input type="checkbox" id="equipment-is-ammo"><label for="equipment-is-ammo" class="text-sm font-bold">Questo √® un tipo di munizione?</label></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva Oggetto</button><button type="button" id="equipment-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
<div id="spell-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-lg w-full"><h3 class="text-xl font-bold mb-4" id="spell-modal-title">Incantesimo</h3><form id="spell-form" class="space-y-3"><input type="hidden" id="spell-id"><input type="hidden" id="spell-level"><div><label class="block text-sm font-bold mb-1">Nome Incantesimo</label><input type="text" id="spell-name" class="cs-input" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-1">Tempo di Lancio</label><input type="text" id="spell-casting-time" class="cs-input text-sm"></div><div><label class="block text-sm font-bold mb-1">Gittata</label><input type="text" id="spell-range" class="cs-input text-sm"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-1">Durata</label><input type="text" id="spell-duration" class="cs-input text-sm"></div><div class="flex items-center gap-2 pt-6"><input type="checkbox" id="spell-concentration" class="w-4 h-4"><label for="spell-concentration" class="text-sm font-bold">Concentrazione?</label></div></div><div><label class="block text-sm font-bold mb-1">Componenti</label><div class="flex items-center gap-4" id="spell-components"><label><input type="checkbox" id="spell-comp-v" class="w-4 h-4"> V</label><label><input type="checkbox" id="spell-comp-s" class="w-4 h-4"> S</label><label><input type="checkbox" id="spell-comp-m" class="w-4 h-4"> M</label></div></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="spell-description" class="cs-textarea h-24"></textarea></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva Incantesimo</button><button type="button" id="spell-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
<div id="feature-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4" id="feature-modal-title">Privilegio / Tratto</h3><form id="feature-form" class="space-y-3"><input type="hidden" id="feature-id"><div><label class="block text-sm font-bold mb-1">Nome</label><input type="text" id="feature-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Tipo</label><select id="feature-type" class="cs-select"><option value="Razziale">Razziale</option><option value="Classe">Classe</option><option value="Background">Background</option><option value="Privilegio">Privilegio</option><option value="Altro">Altro</option></select></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="feature-description" class="cs-textarea h-32"></textarea></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva</button><button type="button" id="feature-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
<div id="treasure-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4" id="treasure-modal-title">Tesoro</h3><form id="treasure-form" class="space-y-3"><input type="hidden" id="treasure-id"><div><label class="block text-sm font-bold mb-1">Nome</label><input type="text" id="treasure-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Valore (es. 100 MO)</label><input type="text" id="treasure-value" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="treasure-description" class="cs-textarea h-32"></textarea></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva</button><button type="button" id="treasure-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
<div id="companion-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] flex flex-col"><h3 class="text-xl font-bold mb-4 flex-shrink-0" id="companion-modal-title">Compagno / Gregario</h3><form id="companion-form" class="space-y-3 overflow-y-auto pr-2 flex-grow"><input type="hidden" id="companion-id"><div class="grid grid-cols-1 md:grid-cols-3 gap-2"><div class="md:col-span-2"><label class="block text-sm font-bold mb-1">Nome</label><input type="text" id="companion-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Tipo</label><select id="companion-type" class="cs-select"><option value="Famiglio">Famiglio</option><option value="Compagno Animale">Compagno Animale</option><option value="Costrutto">Costrutto</option><option value="Gregario">Gregario</option><option value="Altro">Altro</option></select></div></div><div><label class="block text-sm font-bold mb-1">Tipo di Creatura / Razza</label><input type="text" id="companion-creature-type" class="cs-input" placeholder="Es. Bestia, Costrutto, Mastino Infernale..."></div><div class="grid grid-cols-2 md:grid-cols-4 gap-2"><div><label class="block text-sm font-bold mb-1">CA</label><input type="number" id="companion-ac" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">PF Massimi</label><input type="number" id="companion-hp-max" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">PF Attuali</label><input type="number" id="companion-hp-current" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">Velocit√†</label><input type="text" id="companion-speed" class="cs-input" placeholder="9m, 12m volo"></div></div><div class="grid grid-cols-3 md:grid-cols-6 gap-2"><div class="text-center"><label class="block text-sm font-bold mb-1">FOR</label><input type="number" id="companion-stat-str" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">DES</label><input type="number" id="companion-stat-dex" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">COS</label><input type="number" id="companion-stat-con" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">INT</label><input type="number" id="companion-stat-int" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">SAG</label><input type="number" id="companion-stat-wis" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">CAR</label><input type="number" id="companion-stat-cha" class="cs-input text-center"></div></div><div><label class="block text-sm font-bold mb-1">Abilit√† e Tiri Salvezza</label><textarea id="companion-skills" class="cs-textarea h-20" placeholder="Es. Furtivit√† +4, Percezione +3, TS DES +4..."></textarea></div><div><label class="block text-sm font-bold mb-1">Sensi</label><textarea id="companion-senses" class="cs-textarea h-16" placeholder="Es. Percezione Passiva 13, Scurovisione 18m..."></textarea></div><div><label class="block text-sm font-bold mb-1">Azioni</label><textarea id="companion-actions" class="cs-textarea h-24" placeholder="Es. Morso. Attacco con arma da mischia: +4 per colpire, portata 1,5m, un bersaglio. Colpito: 5 (1d6 + 2) danni perforanti."></textarea></div><div><label class="block text-sm font-bold mb-1">Privilegi, Tratti e Infusioni</label><textarea id="companion-features" class="cs-textarea h-24" placeholder="Es. Tattiche del Branco. Il compagno ha vantaggio al tiro per colpire contro una creatura se almeno uno degli alleati del compagno si trova entro 1,5m dalla creatura e non √® incapacitato."></textarea></div><div><label class="block text-sm font-bold mb-1">Note</label><textarea id="companion-notes" class="cs-textarea h-20"></textarea></div></form><div class="flex gap-2 mt-4 flex-shrink-0"><button type="submit" form="companion-form" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva</button><button type="button" id="companion-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyABn9aXZ5jOj2mVftCqiKL2TDZe9cY50dY",
        authDomain: "avventure-dnd.firebaseapp.com",
        projectId: "avventure-dnd",
        storageBucket: "avventure-dnd.appspot.com",
        messagingSenderId: "943269894603",
        appId: "1:943269894603:web:b8851c9862d76486603e4e"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- STATO GLOBALE ---
    let currentUserId = null;
    let currentAdventureId = null;
    let currentAdventureData = {};
    let currentAdventureUnsubscribe = null;
    let characterSheetUpdateTimeout = null;
    let encounterBuilder = { monsters: [] };
    const urlParams = new URLSearchParams(window.location.search);
    const playerViewId = urlParams.get('player_view');
    const playerToken = urlParams.get('token');
    let playerViewInitialized = false;

    // --- GESTIONE AUTENTICAZIONE E VISTE ---
    onAuthStateChanged(auth, user => {
        document.getElementById('initial-loader').style.display = 'none';
        if (playerViewId && playerToken) {
            if (playerViewInitialized) return;
            playerViewInitialized = true;
            (async () => {
                try {
                    if (!auth.currentUser) { await signInAnonymously(auth); }
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'none';
                    document.getElementById('player-view-container').classList.add('active');
                    loadPlayerView(playerViewId, playerToken);
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    const container = document.getElementById('player-view-container');
                    container.innerHTML = `<div class="text-center p-8"><p class="text-red-500 text-2xl">Impossibile connettersi.</p><p class="text-gray-400 mt-4 font-sans">Controlla la tua connessione a internet.</p></div>`;
                    container.classList.add('active');
                }
            })();
        } else if (user) { 
            document.getElementById('auth-container').classList.remove('active');
            document.getElementById('app-container').classList.add('active');
            document.getElementById('player-view-container').style.display = 'none';
            document.getElementById('user-email').textContent = user.email;
            currentUserId = user.uid;
            loadAdventures(user.uid);
        } else {
            document.getElementById('app-container').classList.remove('active');
            document.getElementById('player-view-container').style.display = 'none';
            document.getElementById('auth-container').classList.add('active');
            currentUserId = null;
        }
    });

    // --- FUNZIONI VISTA GIOCATORE ---
    function loadPlayerView(adventureId, token) {
        const publicAdventureRef = doc(db, 'publicAdventures', adventureId);
        onSnapshot(publicAdventureRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                currentAdventureData = data; 
                const currentPlayer = (data.players || []).find(p => p.token === token);
                if (!currentPlayer) { /* Gestione accesso negato */ return; }
                document.getElementById('player-adventure-title').textContent = data.title || "Avventura";
                document.getElementById('player-open-sheet-btn').addEventListener('click', () => { openCharacterSheetModal(token, true); });
                renderDiceLog(document.getElementById('player-dice-log'), data.diceRolls);
                
                const container = document.getElementById('player-shared-items');
                container.innerHTML = '';
                const visibleItems = (data.sharedItems || []).filter(item => item.sharedWith && (item.sharedWith.includes(token) || item.sharedWith.includes('all')));
                if (visibleItems.length > 0) {
                    visibleItems.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'bg-gray-800 rounded-lg shadow-lg p-6';
                        const imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" class="mb-4 rounded-lg w-full h-auto object-cover" onerror="this.style.display='none'"/>` : '';
                        itemEl.innerHTML = `<h3 class="text-2xl font-bold text-red-400 mb-2">${item.title}</h3>${imageHtml}<p class="text-gray-300 font-sans">${(item.publicContent || '').replace(/\n/g, '<br>')}</p>`;
                        container.appendChild(itemEl);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center col-span-full">Il Master non ha ancora condiviso nulla con te.</p>';
                }
            } else { /* Gestione avventura non trovata */ }
        });
    }

    document.getElementById('player-view-container').addEventListener('click', async (e) => {
        if (!e.target.classList.contains('player-dice-btn')) return;
        e.preventDefault();
        const currentPlayer = currentAdventureData.players.find(p => p.token === playerToken);
        if (!currentPlayer) return;
        const sides = parseInt(e.target.dataset.sides);
        const modifier = parseInt(document.getElementById('player-dice-modifier').value) || 0;
        const rollResult = Math.floor(Math.random() * sides) + 1;
        const total = rollResult + modifier;
        const rollData = { id: crypto.randomUUID(), playerName: currentPlayer.name, rollNotation: `1d${sides}${modifier !== 0 ? (modifier > 0 ? `+${modifier}` : modifier) : ''}`, result: total, details: `[${rollResult}]${modifier !== 0 ? (modifier > 0 ? ` + ${modifier}` : ` - ${Math.abs(modifier)}`) : ''}`, timestamp: Date.now() };
        await addAndTrimDiceRoll(playerViewId, rollData);
    });

    // --- FUNZIONI DI BASE APP (LOGIN, TABS, DICE ROLLER) ---
    document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').style.display = 'none'; document.getElementById('register-form').style.display = 'block'; });
    document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; });
    document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; createUserWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
    document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; signInWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
    document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-red-400', 'border-red-400'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            button.classList.add('active', 'text-red-400', 'border-red-400');
            document.getElementById(button.dataset.tab).classList.add('active');
        });
    });

    document.querySelectorAll('.dice-btn').forEach(button => {
        button.addEventListener('click', () => {
            const sides = parseInt(button.dataset.sides);
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            let total = 0;
            let rolls = [];
            for (let i = 0; i < count; i++) { const result = Math.floor(Math.random() * sides) + 1; rolls.push(result); total += result; }
            const finalTotal = total + modifier;
            document.getElementById('dice-results-container').innerHTML = `<p class="text-4xl font-bold">${finalTotal}</p><p class="text-sm text-gray-400">Tiri: [${rolls.join(', ')}] Mod: ${modifier > 0 ? '+' : ''}${modifier}</p>`;
        });
    });

    // --- GENERATORE AI ---
    const GEMINI_API_KEY = "AIzaSyCT74c7GLPJA2E8MsB26s68XgdSosC3bcw";
    document.getElementById('generate-btn').addEventListener('click', async () => {
        const type = document.getElementById('generator-type').value;
        const prompt = document.getElementById('generator-prompt').value.trim();
        if (!prompt) return;
        const resultContainer = document.getElementById('generator-result-container');
        resultContainer.innerHTML = '<div class="loader"></div>';
        let fullPrompt = `Sei un DM di D&D 5e. Rispondi SOLO con la descrizione del ${type}. Inizia la risposta direttamente con il nome in grassetto. Basati su questa idea: "${prompt}". Crea prima una descrizione pubblica. Poi, aggiungi una sezione separata per le note del master che inizia ESATTAMENTE con "---NOTE MASTER---". Non aggiungere introduzioni o testo extra. Formatta in markdown.`;
        try {
            const payload = { contents: [{ role: "user", parts: [{ text: fullPrompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            resultContainer.innerHTML = `<textarea class="w-full h-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white font-sans">${text}</textarea>`;
            document.getElementById('save-to-adventure-btn').style.display = 'block';
        } catch (error) {
            console.error("AI Generation Error:", error);
            resultContainer.innerHTML = `<p class="text-red-500">Errore.</p>`;
        }
    });

    // --- GESTIONE AVVENTURE ---
    function loadAdventures(userId) {
        const q = query(collection(db, `users/${userId}/adventures`));
        onSnapshot(q, snapshot => {
            const adventuresList = document.getElementById('adventures-list');
            adventuresList.innerHTML = '';
            if (snapshot.empty) { adventuresList.innerHTML = '<p class="text-gray-500 text-center font-sans">Nessuna avventura.</p>'; return; }
            snapshot.forEach(doc => {
                const adventure = doc.data();
                const el = document.createElement('div');
                el.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                el.innerHTML = `<button data-id="${doc.id}" class="adventure-link text-left text-xl flex-grow">${adventure.title}</button><button data-id="${doc.id}" class="delete-btn text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>`;
                adventuresList.appendChild(el);
            });
        });
    }

    document.getElementById('add-adventure-form').addEventListener('submit', async e => {
        e.preventDefault();
        const title = document.getElementById('adventure-title-input').value.trim();
        if (title && currentUserId) {
            const newAdvRef = doc(collection(db, `users/${currentUserId}/adventures`));
            const newAdventureData = {
                title, ownerId: currentUserId, background: [], environments: [], pngs: [], maps: [], treasures: [], monsters: [], images: [], players: [], sharedItems: [],
                combatState: { isActive: false, round: 1, turnIndex: 0, combatants: [], notes: "" }, // Aggiunto stato combattimento
                createdAt: serverTimestamp()
            };
            await setDoc(newAdvRef, newAdventureData);
            await setDoc(doc(db, 'publicAdventures', newAdvRef.id), { title, ownerId: currentUserId, players: [], sharedItems: [], diceRolls: [] });
            document.getElementById('adventure-title-input').value = '';
        }
    });

    document.getElementById('adventures-list').addEventListener('click', async e => {
        const btn = e.target.closest('button[data-id]');
        if (!btn) return;
        const docId = btn.dataset.id;
        if (btn.classList.contains('adventure-link')) {
            openAdventureDetail(currentUserId, docId);
        } else if (btn.classList.contains('delete-btn')) {
            if (confirm('Sei sicuro di voler eliminare questa avventura?')) {
                await deleteDoc(doc(db, `users/${currentUserId}/adventures`, docId));
                await deleteDoc(doc(db, 'publicAdventures', docId));
            }
        }
    });
    
    function openAdventureDetail(userId, docId) {
        document.getElementById('adventure-list-view').style.display = 'none';
        document.getElementById('adventure-detail-view').style.display = 'block';
        currentAdventureId = docId;
        encounterBuilder = { monsters: [] }; // Reset encounter builder

        if (currentAdventureUnsubscribe) currentAdventureUnsubscribe();

        const adventureRef = doc(db, `users/${userId}/adventures`, docId);
        currentAdventureUnsubscribe = onSnapshot(adventureRef, (doc) => {
            if (!doc.exists()) { backToListBtn.click(); return; }
            currentAdventureData = doc.data();
            document.getElementById('adventure-detail-title').textContent = currentAdventureData.title;
            renderChaptersUI(currentAdventureData.background || []);
            renderGroupedNodes('environments', currentAdventureData.environments || []);
            renderGroupedNodes('pngs', currentAdventureData.pngs || []);
            renderGroupedNodes('maps', currentAdventureData.maps || []);
            renderGroupedNodes('treasures', currentAdventureData.treasures || []);
            renderGroupedNodes('monsters', currentAdventureData.monsters || []);
            renderGroupedNodes('images', currentAdventureData.images || []);
            renderPlayerManagementUI(docId, currentAdventureData.players || []);
            renderDmDashboard(currentAdventureData.combatState);
        });
        
        const publicAdventureRef = doc(db, 'publicAdventures', docId);
        onSnapshot(publicAdventureRef, (publicDoc) => {
            if (!publicDoc.exists()) return;
            const publicData = publicDoc.data();
            document.getElementById('master-dice-log-container').style.display = 'block';
            renderDiceLog(document.getElementById('master-dice-log'), publicData.diceRolls);
        });
    }

    document.getElementById('back-to-list-btn').addEventListener('click', () => { 
        document.getElementById('adventure-detail-view').style.display = 'none'; 
        document.getElementById('adventure-list-view').style.display = 'block'; 
        currentAdventureId = null; 
        if (currentAdventureUnsubscribe) { currentAdventureUnsubscribe(); currentAdventureUnsubscribe = null; } 
    });

    // --- DM DASHBOARD & COMBAT TRACKER ---
    function renderDmDashboard(combatState) {
        const dashboard = document.getElementById('dm-dashboard');
        if (!combatState || !combatState.isActive) {
            // Render setup view
            dashboard.innerHTML = `
                <div id="combat-setup-view">
                    <h3 class="text-2xl font-bold text-red-400 mb-2">Prepara Scontro</h3>
                    <div id="encounter-builder-monsters" class="bg-gray-800 p-3 rounded-lg min-h-[100px] mb-2 space-y-1">
                        <p class="text-gray-500 text-sm font-sans">Aggiungi mostri dalla lista a sinistra.</p>
                    </div>
                    <button id="start-encounter-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg text-lg" disabled>Avvia Scontro</button>
                </div>`;
            renderEncounterBuilder();
        } else {
            // Render combat tracker view
            dashboard.innerHTML = `
                <div id="combat-tracker-view">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-2xl font-bold text-red-400">Tracciatore</h3>
                        <span class="text-xl font-bold">Round: <span id="round-counter">${combatState.round}</span></span>
                    </div>
                    <div id="initiative-list" class="bg-gray-800 p-2 rounded-lg space-y-1 mb-4 max-h-[40vh] overflow-y-auto">
                        <!-- Initiative items go here -->
                    </div>
                    <div class="flex gap-2 mb-4">
                        <button id="prev-turn-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-2 rounded-lg text-base">Prec.</button>
                        <button id="next-turn-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded-lg text-base">Prossimo</button>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-gray-300 mb-2">Annotazioni</h4>
                        <textarea id="combat-notes" class="w-full h-24 bg-gray-700 border border-gray-600 rounded-lg p-2 text-white font-sans">${combatState.notes || ''}</textarea>
                    </div>
                    <button id="end-combat-btn" class="w-full mt-4 bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Termina Scontro</button>
                </div>`;
            renderInitiativeList(combatState);
        }
    }

    function renderEncounterBuilder() {
        const container = document.getElementById('encounter-builder-monsters');
        const startBtn = document.getElementById('start-encounter-btn');
        if (!container) return;
        
        if (encounterBuilder.monsters.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm font-sans">Aggiungi mostri dalla lista a sinistra.</p>';
            startBtn.disabled = true;
        } else {
            container.innerHTML = encounterBuilder.monsters.map((monster, index) => `
                <div class="flex justify-between items-center bg-gray-700 p-1 rounded">
                    <span class="text-sm font-sans">${monster.name}</span>
                    <button class="remove-from-encounter-btn text-red-400 hover:text-red-300 font-bold px-2" data-index="${index}">&times;</button>
                </div>
            `).join('');
            startBtn.disabled = false;
        }
    }

    function renderInitiativeList(combatState) {
        const container = document.getElementById('initiative-list');
        if (!container) return;
        container.innerHTML = (combatState.combatants || []).map((c, index) => {
            const isActive = index === combatState.turnIndex;
            const bgColor = isActive ? 'bg-red-900/50' : 'bg-gray-700';
            const playerLabel = c.type === 'player' ? '<span class="text-xs text-green-400">[PG]</span>' : '';
            return `
                <div class="flex items-center justify-between p-2 rounded ${bgColor}" data-id="${c.id}">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-lg w-6 text-center">${c.initiative}</span>
                        <span class="font-medium">${c.name} ${playerLabel}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" value="${c.hp.current}" class="combatant-hp-input bg-gray-600 rounded w-16 text-center p-1 text-sm font-sans">
                        <span class="text-sm text-gray-400">/ ${c.hp.max}</span>
                    </div>
                </div>`;
        }).join('');
    }

    document.getElementById('adventure-detail-view').addEventListener('click', e => {
        // Add monster to encounter builder
        if (e.target.classList.contains('add-to-encounter-btn')) {
            const monsterName = e.target.dataset.monsterName;
            const monsterData = currentAdventureData.monsters.find(m => m.title === monsterName);
            if(monsterData) {
                const monsterCount = encounterBuilder.monsters.filter(m => m.baseName === monsterName).length + 1;
                encounterBuilder.monsters.push({
                    baseName: monsterName,
                    name: `${monsterName} ${monsterCount}`,
                    ...monsterData
                });
                renderEncounterBuilder();
            }
        }
        // Remove monster from encounter builder
        if (e.target.classList.contains('remove-from-encounter-btn')) {
            const index = parseInt(e.target.dataset.index);
            encounterBuilder.monsters.splice(index, 1);
            renderEncounterBuilder();
        }
        // Open initiative modal
        if (e.target.id === 'start-encounter-btn') {
            openInitiativeModal();
        }
        // Combat tracker controls
        if (e.target.id === 'next-turn-btn') updateTurn(1);
        if (e.target.id === 'prev-turn-btn') updateTurn(-1);
        if (e.target.id === 'end-combat-btn') endCombat();
    });
    
    document.getElementById('adventure-detail-view').addEventListener('change', e => {
        if (e.target.classList.contains('combatant-hp-input')) {
            const combatantId = e.target.closest('[data-id]').dataset.id;
            const newHp = parseInt(e.target.value);
            updateCombatantHP(combatantId, newHp);
        }
        if (e.target.id === 'combat-notes') {
            updateCombatNotes(e.target.value);
        }
    });

    function openInitiativeModal() {
        const modal = document.getElementById('initiative-modal');
        const list = document.getElementById('initiative-modal-list');
        const players = currentAdventureData.players || [];
        
        let combatantsHtml = players.map(p => `
            <div class="flex items-center gap-4" data-type="player" data-token="${p.token}" data-name="${p.name}">
                <label class="flex-grow text-lg">${p.name} <span class="text-sm text-green-400">[PG]</span></label>
                <input type="number" class="initiative-input bg-gray-700 border border-gray-600 rounded-lg p-2 w-24 text-white" placeholder="Iniziativa">
            </div>
        `).join('');

        combatantsHtml += encounterBuilder.monsters.map((m, i) => `
            <div class="flex items-center gap-4" data-type="monster" data-index="${i}" data-name="${m.name}">
                <label class="flex-grow text-lg">${m.name}</label>
                <input type="number" class="initiative-input bg-gray-700 border border-gray-600 rounded-lg p-2 w-24 text-white" placeholder="Iniziativa">
            </div>
        `).join('');

        list.innerHTML = combatantsHtml;
        modal.classList.remove('hidden');
    }

    document.getElementById('cancel-initiative-btn').addEventListener('click', () => {
        document.getElementById('initiative-modal').classList.add('hidden');
    });

    document.getElementById('confirm-initiative-btn').addEventListener('click', async () => {
        const combatants = [];
        const listItems = document.querySelectorAll('#initiative-modal-list > div');
        
        listItems.forEach(item => {
            const initiative = parseInt(item.querySelector('.initiative-input').value) || 0;
            const name = item.dataset.name;
            const type = item.dataset.type;

            if (type === 'player') {
                const token = item.dataset.token;
                const playerSheet = currentAdventureData.players.find(p => p.token === token)?.characterSheet;
                combatants.push({
                    id: token, name, type, initiative,
                    hp: { current: playerSheet?.hp?.current || 10, max: playerSheet?.hp?.max || 10 }
                });
            } else if (type === 'monster') {
                const index = parseInt(item.dataset.index);
                const monsterData = encounterBuilder.monsters[index];
                // Simple HP parsing from master notes, e.g., "HP: 15"
                const hpMatch = monsterData.masterContent?.match(/HP:\s*(\d+)/i);
                const maxHp = hpMatch ? parseInt(hpMatch[1]) : 10;
                combatants.push({
                    id: crypto.randomUUID(), name, type, initiative,
                    hp: { current: maxHp, max: maxHp }
                });
            }
        });

        combatants.sort((a, b) => b.initiative - a.initiative);

        const newCombatState = {
            isActive: true,
            round: 1,
            turnIndex: 0,
            combatants: combatants,
            notes: ""
        };

        await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), {
            combatState: newCombatState
        });
        
        document.getElementById('initiative-modal').classList.add('hidden');
        encounterBuilder = { monsters: [] }; // Clear builder after starting
    });

    async function updateTurn(direction) {
        let combatState = { ...currentAdventureData.combatState };
        let newIndex = combatState.turnIndex + direction;
        const totalCombatants = combatState.combatants.length;

        if (newIndex >= totalCombatants) {
            newIndex = 0;
            combatState.round++;
        } else if (newIndex < 0) {
            newIndex = totalCombatants - 1;
            if(combatState.round > 1) combatState.round--;
        }
        combatState.turnIndex = newIndex;
        
        await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), {
            "combatState.turnIndex": combatState.turnIndex,
            "combatState.round": combatState.round
        });
    }

    async function endCombat() {
        if (!confirm("Sei sicuro di voler terminare lo scontro? La lista di iniziativa verr√† azzerata.")) return;
        const newCombatState = { isActive: false, round: 1, turnIndex: 0, combatants: [], notes: "" };
        await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), {
            combatState: newCombatState
        });
    }

    async function updateCombatantHP(combatantId, newHp) {
        let combatState = { ...currentAdventureData.combatState };
        const combatantIndex = combatState.combatants.findIndex(c => c.id === combatantId);
        if (combatantIndex > -1) {
            combatState.combatants[combatantIndex].hp.current = newHp;
            // This is a bit tricky with Firestore, updating an array element requires rewriting the array
            await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), {
                "combatState.combatants": combatState.combatants
            });
        }
    }
    
    let notesUpdateTimeout;
    function updateCombatNotes(notes) {
        clearTimeout(notesUpdateTimeout);
        notesUpdateTimeout = setTimeout(async () => {
            await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), {
                "combatState.notes": notes
            });
        }, 500); // Debounce to avoid too many writes
    }

    // --- RENDER NODI E CAPITOLI (con modifiche per combat) ---
    function renderGroupedNodes(type, nodes) {
        const listEl = document.getElementById(`${type}-list`);
        listEl.innerHTML = '';
        if (!nodes || nodes.length === 0) { /* ... */ return; }
        const groups = nodes.reduce((acc, node) => { (acc[node.group || 'Senza Gruppo'] = acc[node.group || 'Senza Gruppo'] || []).push(node); return acc; }, {});
        
        for (const groupName in groups) {
            const groupDetails = document.createElement('details');
            groupDetails.className = 'bg-gray-700 rounded-lg';
            let nodesHtml = groups[groupName].map(node => {
                const addEncounterBtn = type === 'monsters' ? `<button class="add-to-encounter-btn w-full mt-2 p-1 rounded-lg text-sm bg-yellow-600 hover:bg-yellow-700 text-black" data-monster-name="${node.title}">+ Scontro</button>` : '';
                const masterNotesHtml = node.masterContent ? `<div class="mt-2 pt-2 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-sm">Note Master</h4><div class="text-gray-400 font-sans text-sm">${(node.masterContent).replace(/\n/g, '<br>')}</div></div>` : '';
                return `<div class="p-2 border-t border-gray-600 node-container" data-node-id="${node.title}" data-node-type="${type}">
                            <div class="node-view-mode">
                                <details>
                                    <summary class="cursor-pointer text-base flex justify-between items-center"><span>${node.title}</span><div class="flex-shrink-0"><button class="edit-node-btn text-gray-400 hover:text-green-500 font-bold px-1">‚úé</button><button class="delete-node-btn text-gray-400 hover:text-red-500 font-bold px-1">&times;</button></div></summary>
                                    <div class="node-content-view p-2 mt-2 border-t border-gray-500 font-sans text-sm">
                                        <div>${(node.publicContent || '').replace(/\n/g, '<br>')}</div>
                                        ${masterNotesHtml}
                                        <button class="open-share-modal-btn w-full mt-2 p-1 rounded-lg text-sm bg-blue-600 hover:bg-blue-700">Condividi</button>
                                        ${addEncounterBtn}
                                    </div>
                                </details>
                            </div>
                            <!-- Edit mode HTML... -->
                        </div>`;
            }).join('');
            groupDetails.innerHTML = `<summary class="p-2 cursor-pointer text-lg">${groupName}</summary>${nodesHtml}`;
            listEl.appendChild(groupDetails);
        }
    }
    
    // Il resto delle funzioni (renderChaptersUI, gestione nodi, modali, scheda personaggio, etc.) rimane per lo pi√π invariato
    // ma non viene riportato qui per brevit√†. Si assume che il codice precedente sia presente.
    // ... (incollare qui il resto del codice JS dalla richiesta precedente, dalla funzione renderChaptersUI in poi)
    // NOTA: Le funzioni per la scheda personaggio (openCharacterSheetModal, etc.) sono state omesse
    // per concentrarsi sulla nuova funzionalit√†, ma dovrebbero essere incluse nel file completo.
    
    // --- GESTIONE GIOCATORI E CONDIVISIONE ---
    function renderPlayerManagementUI(adventureId, players = []) {
        const shareContainer = document.getElementById('player-share-content');
        const baseUrl = window.location.href.split('?')[0];
        let playerListHtml = players.map(player => `
            <div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg">
                <span class="font-sans font-medium text-gray-200">${player.name}</span>
                <div class="flex items-center gap-2">
                    <button class="view-sheet-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm" data-token="${player.token}">Vedi Scheda</button>
                    <input type="text" value="${baseUrl}?player_view=${adventureId}&token=${player.token}" class="bg-gray-600 border border-gray-500 rounded-lg p-1 text-sm w-40 md:w-56 font-sans" readonly>
                    <button class="copy-player-link-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm" data-link="${baseUrl}?player_view=${adventureId}&token=${player.token}">Copia</button>
                    <button class="delete-player-btn text-red-400 hover:text-red-300 font-bold text-xl" data-token="${player.token}">&times;</button>
                </div>
            </div>`).join('');
        shareContainer.innerHTML = `
            <h3 class="text-2xl font-bold mb-4 text-gray-300">Gestisci Giocatori</h3>
            <form id="add-player-form" class="flex gap-2 mb-4">
                <input type="text" id="player-name-input" placeholder="Nome del giocatore" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans" required>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Aggiungi</button>
            </form>
            <div id="player-links-list" class="space-y-2">${playerListHtml || '<p class="text-gray-500 font-sans">Nessun giocatore aggiunto.</p>'}</div>`;
    }

    // --- FUNZIONI UTILITY ---
    function renderDiceLog(containerEl, rolls = []) {
        if (!containerEl) return;
        containerEl.innerHTML = '';
        if (!rolls || rolls.length === 0) {
            containerEl.innerHTML = `<span class="text-gray-500">Nessun tiro ancora effettuato.</span>`;
            return;
        }
        [...rolls].sort((a, b) => b.timestamp - a.timestamp).forEach(roll => {
            const rollEl = document.createElement('div');
            rollEl.className = 'p-2 border-b border-gray-700';
            rollEl.innerHTML = `<p class="text-lg"><span class="font-bold text-red-400">${roll.playerName}</span> ha tirato ${roll.rollNotation}: <span class="font-bold text-2xl text-white">${roll.result}</span></p><p class="text-sm text-gray-400">${roll.details}</p>`;
            containerEl.appendChild(rollEl); 
        });
    }

    async function addAndTrimDiceRoll(adventureId, rollData) {
        const adventureRef = doc(db, 'publicAdventures', adventureId);
        try {
            const adventureSnap = await getDoc(adventureRef);
            if (adventureSnap.exists()) {
                let diceRolls = adventureSnap.data().diceRolls || [];
                diceRolls.push(rollData);
                if (diceRolls.length > 30) {
                    diceRolls = diceRolls.slice(-30);
                }
                await updateDoc(adventureRef, { diceRolls });
            }
        } catch (error) {
            console.error("Errore nell'invio del tiro al log:", error);
        }
    }
    
    // --- Inserire qui il resto del codice JS dalla versione precedente (scheda personaggio, etc.) ---
    // Il codice per la scheda personaggio √® stato omesso per brevit√†, ma va incluso per la piena funzionalit√†.

</script>

</body>
</html>
