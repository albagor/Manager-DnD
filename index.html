<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Adventure Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, .tab-btn, .dice-btn, button {
             font-family: 'MedievalSharp', cursive;
        }
        #app-container, #adventure-detail-view, #player-view-container, #auth-container, .tab-content { display: none; }
        #app-container.active, #adventure-detail-view.active, #player-view-container.active, .tab-content.active { display: block; }
        #auth-container.active { display: flex; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .node-link {
            color: #f87171; /* text-red-400 */
            cursor: pointer;
            text-decoration: underline;
        }
        .node-link:hover {
            color: #fca5a5; /* text-red-300 */
        }
        /* Stili per la scheda del personaggio */
        #character-sheet-modal .cs-main-container {
            background-color: #f5f5dc; /* Beige */
            color: #000000; /* Nero */
        }
        .cs-box {
            background-color: rgba(0,0,0,0.05);
            @apply border border-gray-400 rounded-lg p-2;
        }
        .cs-label {
            @apply block text-xs text-gray-600 uppercase tracking-wider font-bold mb-1;
        }
        .cs-input, .cs-select {
            @apply bg-white w-full text-black text-lg focus:outline-none rounded px-2 py-1 border border-gray-300;
        }
        .cs-stat-box {
            @apply text-white;
            background-color: #d6b885; /* beige naturale per contrasto */
        }
        .cs-stat-input {
            @apply bg-transparent w-full text-white text-4xl text-center font-bold focus:outline-none;
        }
        .cs-stat-mod {
            @apply bg-gray-800 rounded-md w-12 h-8 flex items-center justify-center text-lg mx-auto;
        }
        .cs-textarea {
            @apply bg-white w-full h-full text-black text-sm focus:outline-none p-2 rounded-md border border-gray-300;
        }
        details > summary {
            cursor: pointer;
        }
        #character-sheet-modal details > summary {
            color: #991b1b; /* text-red-800 */
        }
        #nodes-panel, #combat-tracker-panel {
    position: sticky;
    top: 1.5rem; /* 6 in tailwind */
    align-self: start;
    /* Imposta un'altezza massima e abilita lo scroll verticale se necessario */
    max-height: calc(100vh - 3rem); /* Altezza schermo meno un po' di margine */
    overflow-y: auto;
}
        
        /* Stili per il Combat Tracker */
       /*  #combat-tracker-panel {
            position: sticky;
            top: 1.5rem; /* 6 in tailwind */
          /*  align-self: start;
        }
        */
        
        .combatant-item.current-turn {
            background-color: #7f1d1d; /* red-900 */
            border-left: 4px solid #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Initial Loading Indicator -->
    <div id="initial-loader" class="min-h-screen flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <!-- Contenitore Autenticazione -->
    <div id="auth-container" class="min-h-screen items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-gray-800 shadow-lg rounded-lg p-8">
                <h1 class="text-3xl font-bold text-center text-red-500 mb-6 tracking-wider">D&D Adventure Manager</h1>
                <form id="login-form">
                    <h2 class="text-2xl text-center mb-4">Accedi</h2>
                    <div class="mb-4"><label for="login-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label><input type="email" id="login-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <div class="mb-6"><label for="login-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label><input type="password" id="login-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Accedi</button>
                    <p class="text-center text-gray-500 text-xs mt-4 font-sans">Non hai un account? <a href="#" id="show-register" class="text-red-400 hover:text-red-300">Registrati</a></p>
                </form>
                <form id="register-form" style="display: none;">
                    <h2 class="text-2xl text-center mb-4">Crea un Account</h2>
                    <div class="mb-4"><label for="register-email" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Email</label><input type="email" id="register-email" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <div class="mb-6"><label for="register-password" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Password</label><input type="password" id="register-password" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required></div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline text-lg">Registrati</button>
                    <p class="text-center text-gray-500 text-xs mt-4 font-sans">Hai già un account? <a href="#" id="show-login" class="text-red-400 hover:text-red-300">Accedi</a></p>
                </form>
                <p id="auth-error" class="text-red-500 text-center text-sm mt-4 font-sans"></p>
            </div>
        </div>
    </div>

    <!-- Contenitore App Principale (per il Master) -->
    <div id="app-container">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex justify-between items-center mb-8">
                <div><h1 class="text-4xl md:text-5xl font-bold text-red-500 tracking-wider">D&D Adventure Manager</h1><p class="text-gray-400 mt-2 font-sans">Il tuo compagno digitale per avventure indimenticabili.</p></div>
                <div id="user-info" class="text-right"><p id="user-email" class="text-gray-300 font-sans"></p><button id="logout-btn" class="text-lg text-red-400 hover:text-red-300">Logout</button></div>
            </header>
            <div class="mb-8"><div class="border-b border-gray-700"><nav class="flex flex-wrap -mb-px" aria-label="Tabs"><button class="tab-btn active text-red-400 border-red-400 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="dice-roller">Tira Dadi</button><button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="ai-generator">Generatore AI</button><button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="adventures">Le Mie Avventure</button><button class="tab-btn text-gray-400 hover:text-white hover:border-gray-300 whitespace-nowrap py-4 px-3 border-b-2 font-medium text-xl" data-tab="player-view-master">Vista Giocatore</button></nav></div></div>
            <main>
                <div id="dice-roller" class="tab-content active"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Lancia i Dadi</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6"><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="4">d4</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="6">d6</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="8">d8</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="10">d10</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="12">d12</button><button type="button" class="dice-btn bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold text-2xl" data-sides="20">d20</button></div><div class="flex flex-wrap items-center gap-4 mb-6 font-sans"><div class="flex items-center gap-2"><label for="dice-count">Numero dadi:</label><input type="number" id="dice-count" value="1" min="1" max="100" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24"></div><div class="flex items-center gap-2"><label for="dice-modifier">Modificatore:</label><input type="number" id="dice-modifier" value="0" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24"></div></div><div id="dice-results-container" class="mt-4 p-4 bg-gray-900 rounded-lg min-h-[100px] flex items-center justify-center font-sans"><span class="text-gray-500">I risultati appariranno qui...</span></div></div></div>
                <div id="ai-generator" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Generatore di Contenuti AI</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><div class="mb-4"><label for="generator-type" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Cosa vuoi generare?</label><select id="generator-type" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans"><option value="PNG">PNG</option><option value="Mostro">Mostro</option><option value="Ambientazione">Ambientazione</option><option value="Mappa">Mappa</option><option value="Tesoro">Tesoro</option></select></div><div class="mb-4"><label for="generator-prompt" class="block text-gray-300 text-sm font-bold mb-2 font-sans">Descrivi la tua idea</label><textarea id="generator-prompt" rows="4" class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" placeholder="es. un oste nano brontolone..."></textarea></div><button id="generate-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Genera</button></div><div class="bg-gray-900 p-4 rounded-lg min-h-[250px] flex flex-col items-center justify-center"><div id="generator-result-container" class="flex-grow overflow-y-auto font-sans w-full flex items-center justify-center"><p class="text-gray-500 text-center">I contenuti generati appariranno qui.</p></div><button id="save-to-adventure-btn" class="hidden mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Salva in Avventura</button></div></div></div></div>
                <div id="adventures" class="tab-content"><div id="adventure-list-view" class="active"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Le Mie Avventure</h2><form id="add-adventure-form" class="flex gap-4 mb-6"><input type="text" id="adventure-title-input" placeholder="Titolo della nuova avventura" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500 font-sans" required><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi</button></form><div id="adventures-list" class="space-y-3"></div></div></div><div id="adventure-detail-view" style="display: none;"><button id="back-to-list-btn" class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-lg">&larr; Torna alla lista</button><div class="grid grid-cols-1 md:grid-cols-5 gap-6"><aside id="nodes-panel" class="md:col-span-1 bg-gray-800 p-4 rounded-lg space-y-4 h-fit"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Ambienti</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="environments">Nuovo Ambiente</button><div id="environments-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">PNG</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="pngs">Nuovo PNG</button><div id="pngs-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Mappe</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="maps">Nuova Mappa</button><div id="maps-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Tesori</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="treasures">Nuovo Tesoro</button><div id="treasures-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Mostri</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="monsters">Nuovo Mostro</button><div id="monsters-list" class="space-y-2"></div></div><hr class="border-gray-600"><div><h3 class="text-2xl font-bold text-red-400 mb-2">Immagini</h3><button class="node-add-btn w-full mb-2 bg-green-700 hover:bg-green-800 text-white font-bold py-1 px-2 rounded-lg text-base" data-type="images">Nuova Immagine</button><div id="images-list" class="space-y-2"></div></div></aside><section class="md:col-span-2 bg-gray-800 p-6 rounded-lg"><h2 id="adventure-detail-title" class="text-3xl font-bold text-red-400 mb-4"></h2><h3 class="text-2xl font-bold text-gray-300 mb-4">Background / Capitoli</h3><div id="chapters-container" class="space-y-4"></div><button id="add-chapter-btn" class="mt-6 w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg text-lg">Aggiungi Capitolo</button></section><aside id="combat-tracker-panel" class="md:col-span-2 bg-gray-800 p-4 rounded-lg"><h2 class="text-3xl font-bold text-red-400 mb-4">Tracciatore Combattimento</h2><div id="combat-tracker-content"></div></aside></div></div></div>
                <div id="player-view-master" class="tab-content"><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4 text-red-400">Condividi con i Giocatori</h2><div id="player-share-content"><p class="text-gray-400 font-sans mb-4">Apri un'avventura per gestire i giocatori.</p></div><div id="master-dice-log-container" class="mt-8 hidden"><h3 class="text-2xl font-bold mb-4 text-gray-300">Registro Tiri in Tempo Reale</h3><div id="master-dice-log" class="p-4 bg-gray-900 rounded-lg min-h-[200px] max-h-[400px] overflow-y-auto font-sans"><span class="text-gray-500">I tiri dei giocatori appariranno qui...</span></div></div></div></div>
            </main>
        </div>
    </div>
    
    <!-- Contenitore Vista Giocatore -->
    <div id="player-view-container" class="p-4 md:p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 id="player-adventure-title" class="text-4xl md:text-5xl font-bold text-red-500 tracking-wider"></h1>
            <button id="player-open-sheet-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-lg">La Mia Scheda</button>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-8"><h2 class="text-3xl font-bold mb-4 text-red-400">Lancia i Dadi</h2><div class="grid grid-cols-3 sm:grid-cols-6 gap-4 mb-4"><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="4">d4</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="6">d6</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="8">d8</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="10">d10</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="12">d12</button><button type="button" class="player-dice-btn bg-red-600 hover:bg-red-700 p-3 rounded-lg font-bold text-xl" data-sides="20">d20</button></div><div class="flex items-center gap-2 mb-4 font-sans"><label for="player-dice-modifier">Modificatore:</label><input type="number" id="player-dice-modifier" value="0" class="bg-gray-700 border border-gray-600 rounded-lg p-2 w-24 text-white"></div><div id="player-dice-log" class="mt-4 p-4 bg-gray-900 rounded-lg min-h-[150px] max-h-[300px] overflow-y-auto font-sans"><span class="text-gray-500">I tiri dei dadi appariranno qui...</span></div></div>
        <div id="player-shared-items" class="space-y-8"></div>
    </div>

    <!-- Finestra Modale per i Nodi -->
    <div id="node-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl border border-red-500"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-3xl font-bold text-red-400"></h2><button id="modal-close-btn" class="text-3xl text-gray-400 hover:text-white">&times;</button></div><div id="modal-content" class="font-sans text-gray-300 max-h-[70vh] overflow-y-auto"></div></div></div>

    <!-- Finestra Modale per la Condivisione -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md border border-red-500"><h2 id="share-modal-title" class="text-3xl font-bold text-red-400 mb-4">Condividi Contenuto</h2><div id="share-player-list" class="space-y-2 mb-6 font-sans"></div><div class="flex gap-4"><button id="share-modal-save" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-lg">Salva</button><button id="share-modal-cancel" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-lg">Annulla</button></div></div></div>

    <!-- Finestra Modale Scheda Personaggio -->
    <div id="character-sheet-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-50">
        <div class="cs-main-container rounded-lg shadow-xl w-full max-w-6xl h-[95vh] border-2 border-red-800 flex flex-col">
            <div class="flex justify-between items-center p-3 border-b border-gray-400 flex-shrink-0">
                <h2 id="cs-modal-title" class="text-2xl font-bold text-red-800">Scheda Personaggio</h2>
                <button id="cs-modal-close-btn" class="text-3xl text-gray-600 hover:text-black">&times;</button>
            </div>
            <div id="cs-modal-content" class="p-2 sm:p-4 overflow-y-auto flex-grow font-sans">
                
                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400" open>
                    <summary class="text-2xl text-red-800 font-bold">Anagrafica & Background</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400">
                        <div class="grid grid-cols-1 md:grid-cols-10 gap-2 mb-2">
                            <div class="cs-box md:col-span-4"><label class="cs-label">Nome Personaggio</label><input type="text" class="cs-input text-2xl" data-field="characterName"></div>
                            <div class="cs-box md:col-span-2" id="cs-race-container"><label class="cs-label">Razza</label></div>
                            <div class="cs-box md:col-span-2"><label class="cs-label">Background</label><input type="text" class="cs-input" data-field="background"></div>
                            <div class="cs-box md:col-span-2 text-center"><label class="cs-label">Livello Totale</label><input type="number" id="cs-total-level" class="cs-input text-3xl text-center max-w-[80px] mx-auto" readonly></div>
                        </div>
                        <div class="cs-box mb-2"><label class="cs-label">Classi & Livelli</label><div id="cs-classes-list" class="space-y-1 mt-1"></div><button id="cs-add-class-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Classe</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                            <div class="cs-box h-32"><label class="cs-label">Tratti Personali</label><textarea class="cs-textarea" data-field="personalityTraits"></textarea></div>
                            <div class="cs-box h-32"><label class="cs-label">Ideali</label><textarea class="cs-textarea" data-field="ideals"></textarea></div>
                            <div class="cs-box h-32"><label class="cs-label">Legami</label><textarea class="cs-textarea" data-field="bonds"></textarea></div>
                            <div class="cs-box h-32"><label class="cs-label">Difetti</label><textarea class="cs-textarea" data-field="flaws"></textarea></div>
                        </div>
                    </div>
                </details>

                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400" open>
                    <summary class="text-2xl text-red-800 font-bold">Caratteristiche & Combattimento</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400 grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                <div class="cs-stat-box"><label class="cs-label">Forza</label><input type="number" class="cs-stat-input" data-field="stats.strength"><div class="cs-stat-mod" data-mod="strength">+0</div></div>
                                <div class="cs-stat-box"><label class="cs-label">Destrezza</label><input type="number" class="cs-stat-input" data-field="stats.dexterity"><div class="cs-stat-mod" data-mod="dexterity">+0</div></div>
                                <div class="cs-stat-box"><label class="cs-label">Costituzione</label><input type="number" class="cs-stat-input" data-field="stats.constitution"><div class="cs-stat-mod" data-mod="constitution">+0</div></div>
                                <div class="cs-stat-box"><label class="cs-label">Intelligenza</label><input type="number" class="cs-stat-input" data-field="stats.intelligence"><div class="cs-stat-mod" data-mod="intelligence">+0</div></div>
                                <div class="cs-stat-box"><label class="cs-label">Saggezza</label><input type="number" class="cs-stat-input" data-field="stats.wisdom"><div class="cs-stat-mod" data-mod="wisdom">+0</div></div>
                                <div class="cs-stat-box"><label class="cs-label">Carisma</label><input type="number" class="cs-stat-input" data-field="stats.charisma"><div class="cs-stat-mod" data-mod="charisma">+0</div></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="cs-box"><label class="cs-label">Bonus Competenza</label><input type="text" class="cs-input text-center" data-field="proficiencyBonus" readonly></div>
                                <div class="cs-box"><label class="cs-label">Percezione Passiva</label><input type="text" class="cs-input text-center" data-field="senses.passivePerception" readonly></div>
                            </div>
                            <div class="cs-box mt-2" id="saving-throws-list"></div><div class="cs-box mt-2" id="skills-list"></div>
                        </div>
                        <div class="space-y-2">
                             <div class="grid grid-cols-2 gap-2">
                                <div class="cs-box text-center"><label class="cs-label">Classe Armatura</label><input type="number" class="cs-input text-3xl text-center max-w-[90px]" data-field="armorClass" readonly></div>
                               <div class="cs-box text-center"><label class="cs-label">Iniziativa</label><div class="flex items-center justify-center"><input type="text" id="cs-initiative-total" class="cs-input text-3xl text-center max-w-[80px] mx-auto" readonly><input type="number" data-field="initiativeBonus" class="cs-input text-sm w-20 ml-2 max-w-[70px]" placeholder="Bonus"></div></div>
                            </div>
                            <div class="cs-box"><label class="cs-label">Velocità</label><div class="flex gap-2 items-center"><input type="text" id="cs-speed-auto" class="cs-input text-center max-w-[80px]" readonly><input type="text" data-field="speedModifier" id="cs-speed-modifier" class="cs-input text-center max-w-[100px]" placeholder="Bonus/Malus"></div><small class="text-xs text-gray-500 font-sans">Velocità base calcolata da razza/classe.</small></div>
                            <div class="cs-box"><label class="cs-label">Punti Ferita</label><div class="grid grid-cols-2 gap-2"><div><label class="text-xs">Massimi</label><input type="number" class="cs-input" data-field="hp.max"></div><div><label class="text-xs">Attuali</label><input type="number" class="cs-input" data-field="hp.current"></div></div></div>
                            <div class="cs-box"><label class="cs-label">Dadi Vita</label><input type="text" class="cs-input" data-field="hitDice"></div>
                            <div class="cs-box" id="cs-death-saves">
                                <label class="cs-label">Tiri Salvezza contro Morte</label>
                                <div class="flex justify-around items-center mt-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm">Successi</span>
                                        <input type="checkbox" data-death-save-success="0" class="w-5 h-5">
                                        <input type="checkbox" data-death-save-success="1" class="w-5 h-5">
                                        <input type="checkbox" data-death-save-success="2" class="w-5 h-5">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm">Fallimenti</span>
                                        <input type="checkbox" data-death-save-failure="0" class="w-5 h-5">
                                        <input type="checkbox" data-death-save-failure="1" class="w-5 h-5">
                                        <input type="checkbox" data-death-save-failure="2" class="w-5 h-5">
                                    </div>
                                </div>
                            </div>
                            <div class="cs-box"><label class="cs-label mb-2">Difese</label><div id="cs-defenses-list" class="space-y-1"></div><button id="cs-add-defense-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Difesa</button></div>
                        </div>
                    </div>
                </details>

                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400" open>
                  <summary class="text-2xl text-red-800 font-bold">Armi & Attacchi</summary>
                  <div class="mt-2 pt-2 border-t border-gray-400"><div id="weapons-list-container" class="space-y-2"></div><button id="add-weapon-btn" class="mt-2 bg-green-700 hover:bg-green-800 rounded p-2 text-white">Aggiungi Arma</button></div>
                </details>
                
                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                    <summary class="text-2xl text-red-800 font-bold">Privilegi & Tratti</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400">
                        <div class="cs-box h-[32rem] flex flex-col">
                            <div id="cs-features-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
                            <button id="cs-add-feature-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Privilegio / Tratto</button>
                        </div>
                    </div>
                </details>

                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                    <summary class="text-2xl text-red-800 font-bold">Altre Competenze & Linguaggi</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="cs-box h-48"><label class="cs-label">Competenze (Armature, Armi, Strumenti)</label><textarea class="cs-textarea" data-field="otherProficiencies"></textarea></div>
                        <div class="cs-box h-48"><label class="cs-label">Linguaggi</label><textarea class="cs-textarea" data-field="languages"></textarea></div>
                    </div>
                </details>

                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                    <summary class="text-2xl text-red-800 font-bold">Equipaggiamento & Tesoro</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="cs-box h-96 flex flex-col"><label class="cs-label">Equipaggiamento</label><div id="cs-equipment-list" class="flex-grow overflow-y-auto pr-2 space-y-1"></div><button id="cs-add-equipment-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Oggetto</button></div>
                        </div>
                        <div>
                            <div class="flex gap-4 h-full">
                                <div class="cs-box w-32 flex-shrink-0">
                                    <div class="space-y-3">
                                        <div class="text-center"><label class="cs-label">MR</label><input type="number" class="cs-input text-center" data-field="treasure.cp"></div>
                                        <div class="text-center"><label class="cs-label">MA</label><input type="number" class="cs-input text-center" data-field="treasure.sp"></div>
                                        <div class="text-center"><label class="cs-label">MO</label><input type="number" class="cs-input text-center" data-field="treasure.gp"></div>
                                        <div class="text-center"><label class="cs-label">MP</label><input type="number" class="cs-input text-center" data-field="treasure.pp"></div>
                                    </div>
                                </div>
                                <div class="cs-box flex-grow h-[384px] flex flex-col">
                                    <label class="cs-label">Altri Tesori</label>
                                    <div id="cs-other-treasures-list" class="flex-grow overflow-y-auto pr-2 space-y-1"></div>
                                    <button id="cs-add-treasure-btn" class="mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Tesoro</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                    <summary class="text-2xl text-red-800 font-bold">Compagni & Gregari</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400">
                        <div id="cs-companions-list" class="space-y-3"></div>
                        <button id="cs-add-companion-btn" class="mt-3 w-full bg-green-700 hover:bg-green-800 rounded p-2 text-white">Aggiungi Compagno / Gregario</button>
                    </div>
                </details>

                <details class="bg-white/60 rounded-lg p-3 mb-2 border border-gray-400">
                    <summary class="text-2xl text-red-800 font-bold">Incantesimi</summary>
                    <div class="mt-2 pt-2 border-t border-gray-400">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
                            <div class="cs-box"><label class="cs-label">Classe da Incantatore</label><input type="text" class="cs-input" data-field="spellcasting.class"></div>
                            <div class="cs-box"><label class="cs-label">Caratteristica</label><select class="cs-select" data-field="spellcasting.ability"><option value="strength">Forza</option><option value="dexterity">Destrezza</option><option value="constitution">Costituzione</option><option value="intelligence">Intelligenza</option><option value="wisdom">Saggezza</option><option value="charisma">Carisma</option></select></div>
                            <div class="cs-box"><label class="cs-label">CD Tiro Salvezza</label><input type="number" class="cs-input text-center" data-field="spellcasting.saveDC" readonly></div>
                            <div class="cs-box"><label class="cs-label">Bonus Attacco Inc.</label><input type="text" class="cs-input text-center" data-field="spellcasting.attackBonus" readonly></div>
                        </div>
                        <div id="cs-spell-levels-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                    </div>
                </details>

            </div>
        </div>
    </div>
    
    <!-- === MODALI SCHEDA PERSONAGGIO === -->
    <div id="weapon-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-2" id="weapon-modal-title">Aggiungi/Modifica Arma</h3><form id="weapon-form" class="space-y-2"><input type="hidden" id="weapon-index" value=""><div><label class="block text-xs font-bold mb-1">Nome Arma</label><input type="text" id="weapon-name" class="cs-input" required></div><div><label class="block text-xs font-bold mb-1">Tipo</label><select id="weapon-type" class="cs-select"><option value="mischia">Mischia</option><option value="distanza">Distanza</option><option value="altro">Altro</option></select></div><div id="weapon-ammo-container" class="hidden"><label class="block text-xs font-bold mb-1">Tipo Munizione (es. Frecce)</label><input type="text" id="weapon-ammunition-type" class="cs-input"></div><div><label class="block text-xs font-bold mb-1">Caratteristica per l'Attacco (Override)</label><select id="weapon-override-stat" class="cs-select"><option value="default">Default</option><option value="strength">Forza</option><option value="dexterity">Destrezza</option><option value="constitution">Costituzione</option><option value="intelligence">Intelligenza</option><option value="wisdom">Saggezza</option><option value="charisma">Carisma</option></select></div><div><label class="block text-xs font-bold mb-1">Danno (es: 1d8)</label><input type="text" id="weapon-damage" class="cs-input" required></div><div class="flex items-center gap-2 mt-1"><input type="checkbox" id="weapon-versatile-checkbox"><label for="weapon-versatile-checkbox" class="text-xs font-bold">Versatile?</label></div><div id="weapon-versatile-container" class="hidden"><label class="block text-xs font-bold mb-1">Danno Versatile (es: 1d10)</label><input type="text" id="weapon-versatile-damage" class="cs-input"></div><div><label class="block text-xs font-bold mb-1">Tipo Danno</label><input type="text" id="weapon-damage-type" class="cs-input" placeholder="tagliente, contundente..."></div><div><label class="block text-xs font-bold mb-1">Proprietà (es. accurata)</label><input type="text" id="weapon-properties" class="cs-input" placeholder="leggera, versatile, accurata..."></div><div><label class="block text-xs font-bold mb-1">Competenza?</label><input type="checkbox" id="weapon-proficient"></div><div><label class="block text-xs font-bold mb-1">Bonus/Malus Attacco</label><input type="number" id="weapon-attack-bonus" class="cs-input" value="0"></div><div><label class="block text-xs font-bold mb-1">Bonus/Malus Danni</label><input type="number" id="weapon-damage-bonus" class="cs-input" value="0"></div><div class="flex gap-2 mt-2"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base text-white">Salva</button><button type="button" id="weapon-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-1 text-base text-white">Annulla</button></div></form></div></div>
    <div id="equipment-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4" id="equipment-modal-title">Oggetto</h3><form id="equipment-form" class="space-y-3"><input type="hidden" id="equipment-id"><div><label class="block text-sm font-bold mb-1">Nome Oggetto</label><input type="text" id="equipment-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Quantità</label><input type="number" id="equipment-quantity" class="cs-input" value="1"></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="equipment-description" class="cs-textarea h-24"></textarea></div><div class="flex items-center gap-2 mt-1"><input type="checkbox" id="equipment-is-ammo"><label for="equipment-is-ammo" class="text-sm font-bold">Questo è un tipo di munizione?</label></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva Oggetto</button><button type="button" id="equipment-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
    <div id="spell-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-lg w-full"><h3 class="text-xl font-bold mb-4" id="spell-modal-title">Incantesimo</h3><form id="spell-form" class="space-y-3"><input type="hidden" id="spell-id"><input type="hidden" id="spell-level"><div><label class="block text-sm font-bold mb-1">Nome Incantesimo</label><input type="text" id="spell-name" class="cs-input" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-1">Tempo di Lancio</label><input type="text" id="spell-casting-time" class="cs-input text-sm"></div><div><label class="block text-sm font-bold mb-1">Gittata</label><input type="text" id="spell-range" class="cs-input text-sm"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-1">Durata</label><input type="text" id="spell-duration" class="cs-input text-sm"></div><div class="flex items-center gap-2 pt-6"><input type="checkbox" id="spell-concentration" class="w-4 h-4"><label for="spell-concentration" class="text-sm font-bold">Concentrazione?</label></div></div><div><label class="block text-sm font-bold mb-1">Componenti</label><div class="flex items-center gap-4" id="spell-components"><label><input type="checkbox" id="spell-comp-v" class="w-4 h-4"> V</label><label><input type="checkbox" id="spell-comp-s" class="w-4 h-4"> S</label><label><input type="checkbox" id="spell-comp-m" class="w-4 h-4"> M</label></div></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="spell-description" class="cs-textarea h-24"></textarea></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva Incantesimo</button><button type="button" id="spell-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
    <div id="feature-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4" id="feature-modal-title">Privilegio / Tratto</h3><form id="feature-form" class="space-y-3"><input type="hidden" id="feature-id"><div><label class="block text-sm font-bold mb-1">Nome</label><input type="text" id="feature-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Tipo</label><select id="feature-type" class="cs-select"><option value="Razziale">Razziale</option><option value="Classe">Classe</option><option value="Background">Background</option><option value="Privilegio">Privilegio</option><option value="Altro">Altro</option></select></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="feature-description" class="cs-textarea h-32"></textarea></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva</button><button type="button" id="feature-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
    <div id="treasure-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4" id="treasure-modal-title">Tesoro</h3><form id="treasure-form" class="space-y-3"><input type="hidden" id="treasure-id"><div><label class="block text-sm font-bold mb-1">Nome</label><input type="text" id="treasure-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Valore (es. 100 MO)</label><input type="text" id="treasure-value" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">Descrizione</label><textarea id="treasure-description" class="cs-textarea h-32"></textarea></div><div class="flex gap-2 mt-4"><button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva</button><button type="button" id="treasure-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></form></div></div>
    <div id="companion-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"><div class="bg-gray-200 text-black rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] flex flex-col"><h3 class="text-xl font-bold mb-4 flex-shrink-0" id="companion-modal-title">Compagno / Gregario</h3><form id="companion-form" class="space-y-3 overflow-y-auto pr-2 flex-grow"><input type="hidden" id="companion-id"><div class="grid grid-cols-1 md:grid-cols-3 gap-2"><div class="md:col-span-2"><label class="block text-sm font-bold mb-1">Nome</label><input type="text" id="companion-name" class="cs-input" required></div><div><label class="block text-sm font-bold mb-1">Tipo</label><select id="companion-type" class="cs-select"><option value="Famiglio">Famiglio</option><option value="Compagno Animale">Compagno Animale</option><option value="Costrutto">Costrutto</option><option value="Gregario">Gregario</option><option value="Altro">Altro</option></select></div></div><div><label class="block text-sm font-bold mb-1">Tipo di Creatura / Razza</label><input type="text" id="companion-creature-type" class="cs-input" placeholder="Es. Bestia, Costrutto, Mastino Infernale..."></div><div class="grid grid-cols-2 md:grid-cols-4 gap-2"><div><label class="block text-sm font-bold mb-1">CA</label><input type="number" id="companion-ac" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">PF Massimi</label><input type="number" id="companion-hp-max" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">PF Attuali</label><input type="number" id="companion-hp-current" class="cs-input"></div><div><label class="block text-sm font-bold mb-1">Velocità</label><input type="text" id="companion-speed" class="cs-input" placeholder="9m, 12m volo"></div></div><div class="grid grid-cols-3 md:grid-cols-6 gap-2"><div class="text-center"><label class="block text-sm font-bold mb-1">FOR</label><input type="number" id="companion-stat-str" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">DES</label><input type="number" id="companion-stat-dex" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">COS</label><input type="number" id="companion-stat-con" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">INT</label><input type="number" id="companion-stat-int" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">SAG</label><input type="number" id="companion-stat-wis" class="cs-input text-center"></div><div class="text-center"><label class="block text-sm font-bold mb-1">CAR</label><input type="number" id="companion-stat-cha" class="cs-input text-center"></div></div><div><label class="block text-sm font-bold mb-1">Abilità e Tiri Salvezza</label><textarea id="companion-skills" class="cs-textarea h-20" placeholder="Es. Furtività +4, Percezione +3, TS DES +4..."></textarea></div><div><label class="block text-sm font-bold mb-1">Sensi</label><textarea id="companion-senses" class="cs-textarea h-16" placeholder="Es. Percezione Passiva 13, Scurovisione 18m..."></textarea></div><div><label class="block text-sm font-bold mb-1">Azioni</label><textarea id="companion-actions" class="cs-textarea h-24" placeholder="Es. Morso. Attacco con arma da mischia: +4 per colpire, portata 1,5m, un bersaglio. Colpito: 5 (1d6 + 2) danni perforanti."></textarea></div><div><label class="block text-sm font-bold mb-1">Privilegi, Tratti e Infusioni</label><textarea id="companion-features" class="cs-textarea h-24" placeholder="Es. Tattiche del Branco. Il compagno ha vantaggio al tiro per colpire contro una creatura se almeno uno degli alleati del compagno si trova entro 1,5m dalla creatura e non è incapacitato."></textarea></div><div><label class="block text-sm font-bold mb-1">Note</label><textarea id="companion-notes" class="cs-textarea h-20"></textarea></div></form><div class="flex gap-2 mt-4 flex-shrink-0"><button type="submit" form="companion-form" class="flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base text-white">Salva</button><button type="button" id="companion-cancel-btn" class="flex-grow bg-gray-500 hover:bg-gray-700 rounded-lg p-2 text-base text-white">Annulla</button></div></div></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABn9aXZ5jOj2mVftCqiKL2TDZe9cY50dY",
            authDomain: "avventure-dnd.firebaseapp.com",
            projectId: "avventure-dnd",
            storageBucket: "avventure-dnd.appspot.com",
            messagingSenderId: "943269894603",
            appId: "1:943269894603:web:b8851c9862d76486603e4e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let currentAdventureId = null;
        let currentAdventureData = {};
        let currentAdventureUnsubscribe = null;
        let characterSheetUpdateTimeout = null;
        let combatTrackerUpdateTimeout = null;

        const urlParams = new URLSearchParams(window.location.search);
        const playerViewId = urlParams.get('player_view');
        const playerToken = urlParams.get('token');
        let playerViewInitialized = false;

        onAuthStateChanged(auth, user => {
            document.getElementById('initial-loader').style.display = 'none';

            if (playerViewId && playerToken) {
                if (playerViewInitialized) return;
                playerViewInitialized = true;

                (async () => {
                    try {
                        if (!auth.currentUser) {
                            await signInAnonymously(auth);
                        }
                        document.getElementById('auth-container').style.display = 'none';
                        document.getElementById('app-container').style.display = 'none';
                        document.getElementById('player-view-container').classList.add('active');
                        loadPlayerView(playerViewId, playerToken);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        const container = document.getElementById('player-view-container');
                        container.innerHTML = `<div class="text-center p-8"><p class="text-red-500 text-2xl">Impossibile connettersi.</p><p class="text-gray-400 mt-4 font-sans">Controlla la tua connessione a internet. Se il problema persiste, il DM deve assicurarsi che l'autenticazione anonima sia abilitata nelle impostazioni del progetto Firebase.</p></div>`;
                        container.classList.add('active');
                        document.getElementById('auth-container').style.display = 'none';
                        document.getElementById('app-container').style.display = 'none';
                    }
                })();
            } else if (user) { 
                document.getElementById('auth-container').classList.remove('active');
                document.getElementById('app-container').classList.add('active');
                document.getElementById('player-view-container').style.display = 'none';
                document.getElementById('user-email').textContent = user.email;
                currentUserId = user.uid;
                loadAdventures(user.uid);
            } else {
                document.getElementById('app-container').classList.remove('active');
                document.getElementById('player-view-container').style.display = 'none';
                document.getElementById('auth-container').classList.add('active');
                currentUserId = null;
            }
        });

        function renderDiceLog(containerEl, rolls = []) {
            if (!containerEl) return;
            containerEl.innerHTML = '';
            if (!rolls || rolls.length === 0) {
                containerEl.innerHTML = `<span class="text-gray-500">Nessun tiro ancora effettuato.</span>`;
                return;
            }
            const sortedRolls = [...rolls].sort((a, b) => b.timestamp - a.timestamp);
            sortedRolls.forEach(roll => {
                const rollEl = document.createElement('div');
                rollEl.className = 'p-2 border-b border-gray-700';
                rollEl.innerHTML = `<p class="text-lg"><span class="font-bold text-red-400">${roll.playerName}</span> ha tirato ${roll.rollNotation}: <span class="font-bold text-2xl text-white">${roll.result}</span></p><p class="text-sm text-gray-400">${roll.details}</p>`;
                containerEl.appendChild(rollEl); 
            });
        }
        
        document.getElementById('player-view-container').addEventListener('click', async (e) => {
            if (!e.target.classList.contains('player-dice-btn')) return;
            e.preventDefault();
            if (!playerViewId || !playerToken || !currentAdventureData.players) return;
            const btn = e.target;
            const currentPlayer = currentAdventureData.players.find(p => p.token === playerToken);
            if (!currentPlayer) return;
            const sides = parseInt(btn.dataset.sides);
            const modifier = parseInt(document.getElementById('player-dice-modifier').value) || 0;
            const rollResult = Math.floor(Math.random() * sides) + 1;
            const total = rollResult + modifier;
            const rollData = { id: crypto.randomUUID(), playerName: currentPlayer.name, rollNotation: `1d${sides}${modifier !== 0 ? (modifier > 0 ? `+${modifier}` : modifier) : ''}`, result: total, details: `[${rollResult}]${modifier !== 0 ? (modifier > 0 ? ` + ${modifier}` : ` - ${Math.abs(modifier)}`) : ''}`, timestamp: Date.now() };
            
            await addAndTrimDiceRoll(playerViewId, rollData);
        });

        function loadPlayerView(adventureId, token) {
            const publicAdventureRef = doc(db, 'publicAdventures', adventureId);
            onSnapshot(publicAdventureRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    currentAdventureData = data; 
                    const players = data.players || [];
                    const currentPlayer = players.find(p => p.token === token);
                    if (!currentPlayer) { document.getElementById('player-adventure-title').textContent = "Accesso Negato"; document.getElementById('player-shared-items').innerHTML = '<p class="text-red-500 text-center col-span-full">Questo link non è valido o è scaduto.</p>'; return; }
                    document.getElementById('player-adventure-title').textContent = data.title || "Avventura";
                    document.getElementById('player-open-sheet-btn').addEventListener('click', () => { openCharacterSheetModal(token, true); });
                    
                    const diceLogContainer = document.getElementById('player-dice-log');
                    renderDiceLog(diceLogContainer, data.diceRolls);

                    const container = document.getElementById('player-shared-items');
                    container.innerHTML = '';
                    const allSharedItems = data.sharedItems || [];
                    const visibleItems = allSharedItems.filter(item => item.sharedWith && (item.sharedWith.includes(token) || item.sharedWith.includes('all')));
                    const sharedChapters = visibleItems.filter(item => item.isChapter).sort((a, b) => a.order - b.order);
                    const otherItems = visibleItems.filter(item => !item.isChapter);
                    if (sharedChapters.length > 0) { sharedChapters.forEach(chapter => { const chapterEl = document.createElement('div'); chapterEl.className = 'bg-gray-800 rounded-lg shadow-lg p-6'; chapterEl.innerHTML = `<h3 class="text-2xl font-bold text-red-400 mb-4">${chapter.title}</h3><p class="text-gray-300 font-sans leading-relaxed">${(chapter.publicContent || '').replace(/\n/g, '<br>')}</p>`; container.appendChild(chapterEl); }); }
                    if (otherItems.length > 0) { const otherItemsContainer = document.createElement('div'); otherItemsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8'; otherItems.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'bg-gray-800 rounded-lg shadow-lg p-6'; const imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" class="mb-4 rounded-lg w-full h-auto object-cover" onerror="this.style.display='none'"/>` : ''; itemEl.innerHTML = `<h3 class="text-2xl font-bold text-red-400 mb-2">${item.title}</h3>${imageHtml}<p class="text-gray-300 font-sans">${(item.publicContent || '').replace(/\n/g, '<br>')}</p>`; otherItemsContainer.appendChild(itemEl); }); container.appendChild(otherItemsContainer); }
                    if (visibleItems.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center col-span-full">Il Master non ha ancora condiviso nulla con te.</p>'; }
                } else { document.getElementById('player-adventure-title').textContent = "Avventura non trovata"; document.getElementById('player-shared-items').innerHTML = '<p class="text-red-500 text-center col-span-full">Questo link non è valido.</p>'; }
            });
        }
        
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').style.display = 'none'; document.getElementById('register-form').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
        document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; createUserWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; signInWithEmailAndPassword(auth, email, password).catch(error => { document.getElementById('auth-error').textContent = error.message; }); });
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const diceButtons = document.querySelectorAll('.dice-btn');
        const resultsContainer = document.getElementById('dice-results-container');
        const diceCountInput = document.getElementById('dice-count');
        const diceModifierInput = document.getElementById('dice-modifier');

        tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => { btn.classList.remove('active', 'text-red-400', 'border-red-400'); btn.classList.add('text-gray-400', 'hover:text-white', 'hover:border-gray-300'); }); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active', 'text-red-400', 'border-red-400'); button.classList.remove('text-gray-400'); document.getElementById(button.dataset.tab).classList.add('active'); }); });

        diceButtons.forEach(button => button.addEventListener('click', () => { const sides = parseInt(button.dataset.sides); const count = parseInt(diceCountInput.value) || 1; rollDice(sides, count); }));
        function rollDice(sides, count) { const modifier = parseInt(diceModifierInput.value) || 0; resultsContainer.innerHTML = ''; let total = 0; let rolls = []; for (let i = 0; i < count; i++) { const result = Math.floor(Math.random() * sides) + 1; rolls.push(result); total += result; } const finalTotal = total + modifier; const resultWrapper = document.createElement('div'); resultWrapper.className = 'text-center'; if (count > 1) { resultWrapper.innerHTML += `<p class="text-lg text-gray-300">Tiri: [${rolls.join(', ')}]</p>`; } const totalText = document.createElement('p'); totalText.className = 'text-4xl font-bold mt-2'; if (modifier !== 0) { const sign = modifier > 0 ? '+' : '-'; totalText.innerHTML = `${total} <span class="text-2xl text-red-400">${sign} ${Math.abs(modifier)}</span> = ${finalTotal}`; } else { totalText.textContent = finalTotal; } resultWrapper.appendChild(totalText); resultsContainer.appendChild(resultWrapper); }

        const GEMINI_API_KEY = "AIzaSyCT74c7GLPJA2E8MsB26s68XgdSosC3bcw";
        const generateBtn = document.getElementById('generate-btn');
        const generatorType = document.getElementById('generator-type');
        const generatorPrompt = document.getElementById('generator-prompt');
        const resultContainer = document.getElementById('generator-result-container');
        const saveToAdventureBtn = document.getElementById('save-to-adventure-btn');
        
        generateBtn.addEventListener('click', async () => {
            const type = generatorType.value;
            const prompt = generatorPrompt.value.trim();
            if (!prompt) { resultContainer.innerHTML = '<p class="text-yellow-400 text-center">Inserisci una descrizione.</p>'; return; }
            resultContainer.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
            saveToAdventureBtn.style.display = 'none';
            await generateText(type, prompt);
        });

        async function generateText(type, prompt) {
            let fullPrompt = '';
            if (type === 'Mappa') {
                fullPrompt = `Sei un DM di D&D 5e. Genera la descrizione testuale per un dungeon o una mappa basandoti su questa idea: "${prompt}". Rispondi SOLO con la descrizione. Inizia la risposta direttamente con il nome del luogo in grassetto. Descrivi l'aspetto generale e poi elenca le stanze o le aree principali con un titolo (es. **1. Ingresso**, **2. Sala del Trono**, ecc.) e una breve descrizione per ciascuna. Questa è la parte pubblica. Poi, aggiungi una sezione separata per le note del master che inizia ESATTAMENTE con "---NOTE MASTER---" e che include segreti, trappole, tesori o mostri. Non aggiungere introduzioni o testo extra. Formatta tutto in markdown.`;
            } else {
                fullPrompt = `Sei un DM di D&D 5e. Rispondi SOLO con la descrizione del ${type}. Inizia la risposta direttamente con il nome in grassetto. Basati su questa idea: "${prompt}". Crea prima una descrizione pubblica (aspetto, personalità, ecc.). Poi, aggiungi una sezione separata per le note del master che inizia ESATTAMENTE con "---NOTE MASTER---" e che include segreti, statistiche o spunti di trama. Non aggiungere introduzioni o testo extra. Formatta tutto in markdown.`;
            }
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: fullPrompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Errore API Testo: ${response.statusText}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultContainer.innerHTML = `<textarea class="w-full h-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 font-sans">${text}</textarea>`;
                    saveToAdventureBtn.dataset.type = type;
                    saveToAdventureBtn.style.display = 'block';
                } else { throw new Error("Nessun contenuto valido ricevuto dall'API."); }
            } catch (error) { console.error("Errore generazione testo:", error); resultContainer.innerHTML = `<p class="text-red-500 text-center">Si è verificato un errore. Riprova.</p>`; }
        }

        saveToAdventureBtn.addEventListener('click', async () => {
            if (!currentAdventureId) { alert("Devi prima aprire un'avventura per poter salvare un contenuto."); return; }
            const editTextArea = resultContainer.querySelector('textarea');
            if (!editTextArea) { alert("Nessun contenuto da salvare."); return; }
            const fullContent = editTextArea.value;
            const separator = '---NOTE MASTER---';
            let publicContent = fullContent;
            let masterContent = '';
            if (fullContent.includes(separator)) { const parts = fullContent.split(separator); publicContent = parts[0].trim(); masterContent = parts[1].trim(); }
            const title = (publicContent.split('\n')[0] || "Nuovo Contenuto").replace(/\*|#/g, '').trim();
            const group = prompt(`In quale gruppo vuoi salvare "${title}"?`, "Senza Gruppo");
            if (group === null) return;
            const imageUrl = prompt("URL dell'immagine (opzionale):");
            const newNode = { title, publicContent, masterContent, group, imageUrl: imageUrl || "" };
            const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
            try {
                const type = saveToAdventureBtn.dataset.type;
                const fieldMap = { 'Ambientazione': 'environments', 'Tesoro': 'treasures', 'Mappa': 'maps', 'PNG': 'pngs', 'Mostro': 'monsters' };
                const field = fieldMap[type] || 'environments';
                await updateDoc(adventureRef, { [field]: arrayUnion(newNode) });
                saveToAdventureBtn.textContent = 'Salvato!';
                setTimeout(() => { saveToAdventureBtn.textContent = 'Salva in Avventura'; }, 2000);
            } catch (error) { console.error("Errore salvataggio:", error); alert("Errore durante il salvataggio."); }
        });

        const addAdventureForm = document.getElementById('add-adventure-form');
        const adventureTitleInput = document.getElementById('adventure-title-input');
        const adventuresList = document.getElementById('adventures-list');
        const adventureListView = document.getElementById('adventure-list-view');

        adventuresList.addEventListener('click', async e => {
            const btn = e.target.closest('button[data-id]');
            if (!btn || !btn.dataset.id || !currentUserId) return;
            const docId = btn.dataset.id;

            if (btn.classList.contains('adventure-link')) {
                openAdventureDetail(currentUserId, docId);
            } else if (btn.classList.contains('delete-btn')) {
                if (confirm('Sei sicuro di voler eliminare questa avventura?')) {
                    try {
                        await deleteDoc(doc(db, `users/${currentUserId}/adventures`, docId));
                        await deleteDoc(doc(db, 'publicAdventures', docId));
                    } catch (error) {
                        console.error("Errore eliminazione: ", error);
                    }
                }
            }
        });
        
        const adventureDetailView = document.getElementById('adventure-detail-view');
        const backToListBtn = document.getElementById('back-to-list-btn');
        addAdventureForm.addEventListener('submit', async e => { e.preventDefault(); const title = adventureTitleInput.value.trim(); if (title && currentUserId) { const newAdvRef = doc(collection(db, `users/${currentUserId}/adventures`)); await setDoc(newAdvRef, { title, ownerId: currentUserId, background: [], environments: [], pngs: [], maps: [], treasures: [], monsters: [], images: [], players: [], sharedItems: [], combatState: createEmptyCombatState(), createdAt: serverTimestamp() }); await setDoc(doc(db, 'publicAdventures', newAdvRef.id), { title, ownerId: currentUserId, players: [], sharedItems: [], diceRolls: [] }); adventureTitleInput.value = ''; } });
        function loadAdventures(userId) { const q = query(collection(db, `users/${userId}/adventures`)); onSnapshot(q, snapshot => { adventuresList.innerHTML = ''; if (snapshot.empty) { adventuresList.innerHTML = '<p class="text-gray-500 text-center font-sans">Nessuna avventura.</p>'; return; } snapshot.forEach(doc => { const adventure = doc.data(); const el = document.createElement('div'); el.className = 'adventure-item bg-gray-700 p-3 rounded-lg flex justify-between items-center'; el.innerHTML = `<button data-id="${doc.id}" class="adventure-link text-left text-xl flex-grow">${adventure.title}</button><button data-id="${doc.id}" class="delete-btn text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>`; adventuresList.appendChild(el); }); }); }
        
        function openAdventureDetail(userId, docId) {
            adventureListView.style.display = 'none';
            adventureDetailView.style.display = 'block';
            currentAdventureId = docId;
            if (currentAdventureUnsubscribe) currentAdventureUnsubscribe();

            const adventureRef = doc(db, `users/${userId}/adventures`, docId);
            const publicAdventureRef = doc(db, 'publicAdventures', docId);

            let privateDataCache = {}; 

            const privateUnsubscribe = onSnapshot(adventureRef, (doc) => {
                if (!doc.exists()) {
                    backToListBtn.click();
                    return;
                }
                privateDataCache = doc.data();
                currentAdventureData = { ...privateDataCache, ...currentAdventureData };
                document.getElementById('adventure-detail-title').textContent = currentAdventureData.title;
                renderChaptersUI(currentAdventureData.background || []);
                renderGroupedNodes('environments', currentAdventureData.environments || []);
                renderGroupedNodes('pngs', currentAdventureData.pngs || []);
                renderGroupedNodes('maps', currentAdventureData.maps || []);
                renderGroupedNodes('treasures', currentAdventureData.treasures || []);
                renderGroupedNodes('monsters', currentAdventureData.monsters || []);
                renderGroupedNodes('images', currentAdventureData.images || []);
                renderCombatTrackerUI(currentAdventureData.combatState || createEmptyCombatState());
            });

            const publicUnsubscribe = onSnapshot(publicAdventureRef, (publicDoc) => {
                if (!publicDoc.exists()) return;
                
                const publicData = publicDoc.data();
                currentAdventureData.players = publicData.players || [];
                currentAdventureData.diceRolls = publicData.diceRolls || [];

                if (JSON.stringify(privateDataCache.players) !== JSON.stringify(publicData.players)) {
                    updateDoc(adventureRef, { players: publicData.players || [] }).catch(err => console.error("Failed to sync players back to master doc:", err));
                }

                renderPlayerManagementUI(docId, currentAdventureData.players);
                document.getElementById('master-dice-log-container').style.display = 'block';
                renderDiceLog(document.getElementById('master-dice-log'), currentAdventureData.diceRolls);
            });

            currentAdventureUnsubscribe = () => {
                privateUnsubscribe();
                publicUnsubscribe();
            };
        }

        function renderGroupedNodes(type, nodes) {
            const listEl = document.getElementById(`${type}-list`);
            listEl.innerHTML = '';
            const typeNameMap = { pngs: 'PNG', maps: 'mappa', environments: 'ambiente', treasures: 'tesoro', monsters: 'mostro', images: 'immagine' };
            const typeName = typeNameMap[type] || 'elemento';
            if (!nodes || nodes.length === 0) { listEl.innerHTML = `<p class="text-gray-500 text-sm font-sans">Nessun ${typeName}.</p>`; return; }
            const groups = nodes.reduce((acc, node) => { (acc[node.group || 'Senza Gruppo'] = acc[node.group || 'Senza Gruppo'] || []).push(node); return acc; }, {});
            for (const groupName in groups) {
                const groupDetails = document.createElement('details');
                groupDetails.className = 'bg-gray-700 rounded-lg';
                let nodesHtml = groups[groupName].map(node => {
                    const sharedWith = currentAdventureData.sharedItems?.find(item => item.id === node.title)?.sharedWith || [];
                    const shareStatus = sharedWith.length === 0 ? 'Condividi' : (sharedWith.includes('all') ? 'Condiviso con tutti' : `Condiviso con ${sharedWith.length}`);
                    const imageHtml = node.imageUrl ? `<img src="${node.imageUrl}" class="my-2 rounded-lg max-w-full h-auto" onerror="this.style.display='none'"/>` : '';
                    const masterNotesHtml = node.masterContent ? `<div class="mt-2 pt-2 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-sm">Note Master</h4><div class="text-gray-400 font-sans text-sm">${(node.masterContent).replace(/\n/g, '<br>')}</div></div>` : '';
                    return `<div class="p-2 border-t border-gray-600 node-container" data-node-id="${node.title}" data-node-type="${type}"><div class="node-view-mode"><details><summary class="cursor-pointer text-base flex justify-between items-center"><span>${node.title}</span><div class="flex-shrink-0"><button class="edit-node-btn text-gray-400 hover:text-green-500 font-bold px-1">✎</button><button class="delete-node-btn text-gray-400 hover:text-red-500 font-bold px-1">&times;</button></div></summary><div class="node-content-view p-2 mt-2 border-t border-gray-500 font-sans text-sm">${imageHtml}<div>${(node.publicContent || '').replace(/\n/g, '<br>')}</div>${masterNotesHtml}<button class="open-share-modal-btn w-full mt-2 p-1 rounded-lg text-sm bg-blue-600 hover:bg-blue-700">${shareStatus}</button></div></details></div><div class="node-edit-mode hidden p-2 space-y-2"><input type="text" class="node-image-url-edit w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" value="${node.imageUrl || ''}" placeholder="URL Immagine (opzionale)"><div><label class="font-bold text-xs text-gray-400">Descrizione Pubblica</label><textarea class="node-public-content-edit w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans">${node.publicContent || ''}</textarea></div><div><label class="font-bold text-xs text-yellow-400">Note Master (Private)</label><textarea class="node-master-content-edit w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans">${node.masterContent || ''}</textarea></div><div class="flex gap-2 mt-2"><button class="save-node-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base">Salva</button><button class="cancel-edit-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-1 text-base">Annulla</button></div></div></div>`;
                }).join('');
                groupDetails.innerHTML = `<summary class="p-2 cursor-pointer text-lg flex justify-between items-center"><span>${groupName}</span>${groupName !== 'Senza Gruppo' ? `<button class="delete-group-btn text-gray-500 hover:text-red-500 font-bold text-xl px-2" data-group-name="${groupName}" data-node-type="${type}">&times;</button>` : ''}</summary>${nodesHtml}`;
                listEl.appendChild(groupDetails);
            }
        }
        
        function renderTextWithLinks(text) {
            const allNodes = [...(currentAdventureData.environments || []), ...(currentAdventureData.pngs || []), ...(currentAdventureData.maps || []), ...(currentAdventureData.treasures || []), ...(currentAdventureData.monsters || []), ...(currentAdventureData.images || [])];
            return (text || '').replace(/\[\[(.*?)\]\]/g, (match, nodeName) => { const nodeExists = allNodes.some(node => node.title.toLowerCase() === nodeName.toLowerCase()); return nodeExists ? `<a href="#" class="node-link" data-node-name="${nodeName}">${nodeName}</a>` : `[[${nodeName}]]`; }).replace(/\n/g, '<br>');
        }

        const nodeModal = document.getElementById('node-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        document.getElementById('adventure-detail-view').addEventListener('click', e => {
             if (e.target.classList.contains('node-link')) {
                e.preventDefault();
                const nodeName = e.target.dataset.nodeName;
                const allNodes = [...(currentAdventureData.environments || []), ...(currentAdventureData.pngs || []), ...(currentAdventureData.maps || []), ...(currentAdventureData.treasures || []), ...(currentAdventureData.monsters || []), ...(currentAdventureData.images || [])];
                const nodeData = allNodes.find(node => node.title.toLowerCase() === nodeName.toLowerCase());
                if (nodeData) {
                    modalTitle.textContent = nodeData.title;
                    const imageHtml = nodeData.imageUrl ? `<img src="${nodeData.imageUrl}" class="mb-4 rounded-lg max-w-full h-auto" onerror="this.style.display='none'"/>` : ''
                    const masterNotesHtml = nodeData.masterContent ? `<div class="mt-4 pt-4 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-lg">Note Master</h4><div class="text-gray-300">${(nodeData.masterContent).replace(/\n/g, '<br>')}</div></div>` : '';
                    modalContent.innerHTML = `${imageHtml}${(nodeData.publicContent || '').replace(/\n/g, '<br>')}${masterNotesHtml}`;
                    nodeModal.classList.remove('hidden');
                }
            }
        });
        modalCloseBtn.addEventListener('click', () => nodeModal.classList.add('hidden'));
        nodeModal.addEventListener('click', (e) => { if (e.target === nodeModal) nodeModal.classList.add('hidden'); });

        backToListBtn.addEventListener('click', () => { 
            adventureDetailView.style.display = 'none'; 
            adventureListView.style.display = 'block'; 
            currentAdventureId = null; 
            if (currentAdventureUnsubscribe) { currentAdventureUnsubscribe(); currentAdventureUnsubscribe = null; } 
            document.getElementById('player-share-content').innerHTML = '<p class="text-gray-400 font-sans mb-4">Apri un\'avventura per gestire i giocatori.</p>';
            document.getElementById('master-dice-log-container').style.display = 'none';
        });
        
        document.getElementById('adventure-detail-view').addEventListener('click', (e) => {
            if (e.target.classList.contains('node-add-btn')) {
                if (!currentAdventureId) return;
                const type = e.target.dataset.type;
                const typeNameMap = { pngs: 'PNG', maps: 'Mappa', environments: 'Ambiente', treasures: 'Tesoro', monsters: 'Mostro', images: 'Immagine' };
                const typeName = typeNameMap[type];
                if (document.querySelector('.new-node-form-container')) return;
                const listEl = document.getElementById(`${type}-list`);
                const formContainer = document.createElement('div');
                formContainer.className = 'p-2 mb-2 new-node-form-container';
                let formHtml = `<div class="p-3 space-y-2 bg-gray-700 rounded-lg border border-green-500"><h4 class="text-lg text-green-400">Nuovo ${typeName}</h4><input type="text" class="new-node-title w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Titolo" required><input type="text" class="new-node-group w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Gruppo (opzionale)" value="Senza Gruppo"><div class="flex gap-2 mt-2"><button class="save-new-node-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base">Salva</button><button class="cancel-new-node-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-1 text-base">Annulla</button></div></div>`;
                if (type === 'maps' || type === 'images') { formHtml = `<div class="p-3 space-y-2 bg-gray-700 rounded-lg border border-green-500"><h4 class="text-lg text-green-400">Nuova ${typeName}</h4><input type="text" class="new-node-title w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Titolo" required><input type="text" class="new-node-image-url w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="URL Immagine"><textarea class="new-node-public-content w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Descrizione pubblica..."></textarea><textarea class="new-node-master-content w-full h-24 bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Note master..."></textarea><input type="text" class="new-node-group w-full bg-gray-600 rounded-lg p-2 text-sm font-sans" placeholder="Gruppo" value="Senza Gruppo"><div class="flex gap-2 mt-2"><button class="save-new-node-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-1 text-base">Salva ${typeName}</button><button class="cancel-new-node-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-1 text-base">Annulla</button></div></div>`; }
                formContainer.innerHTML = formHtml;
                listEl.prepend(formContainer);
                formContainer.querySelector('.cancel-new-node-btn').addEventListener('click', () => formContainer.remove());
                formContainer.querySelector('.save-new-node-btn').addEventListener('click', async () => {
                    const title = formContainer.querySelector('.new-node-title').value.trim();
                    if (!title) { alert('Il titolo è obbligatorio.'); return; }
                    let newNode = { title, group: formContainer.querySelector('.new-node-group').value.trim() || "Senza Gruppo", publicContent: "", masterContent: "", imageUrl: "" };
                    if (type === 'maps' || type === 'images') { newNode.imageUrl = formContainer.querySelector('.new-node-image-url')?.value.trim() || ""; newNode.publicContent = formContainer.querySelector('.new-node-public-content')?.value.trim() || ""; newNode.masterContent = formContainer.querySelector('.new-node-master-content')?.value.trim() || ""; }
                    try { await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), { [type]: arrayUnion(newNode) }); formContainer.remove(); } catch (error) { console.error(`Errore aggiunta ${typeName}:`, error); }
                });
            }
        });

        document.getElementById('adventure-detail-view').addEventListener('click', async (e) => {
            const target = e.target;
            const container = target.closest('.node-container');
            const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
            if (target.classList.contains('delete-group-btn')) {
                const groupName = target.dataset.groupName;
                const type = target.dataset.nodeType;
                if (!confirm(`Sei sicuro di voler eliminare il gruppo "${groupName}" e tutti i suoi contenuti?`)) return;
                const adventureSnap = await getDoc(adventureRef);
                if (adventureSnap.exists()) {
                    const adventureData = adventureSnap.data();
                    const nodes = adventureData[type] || [];
                    const nodesToDelete = nodes.filter(n => n.group === groupName);
                    const nodesToKeep = nodes.filter(n => n.group !== groupName);
                    const titlesToDelete = nodesToDelete.map(n => n.title);
                    const sharedItemsToKeep = (adventureData.sharedItems || []).filter(item => !titlesToDelete.includes(item.id));
                    await updateDoc(adventureRef, { [type]: nodesToKeep, sharedItems: sharedItemsToKeep });
                }
            } else if (container) {
                const nodeId = container.dataset.nodeId;
                const type = container.dataset.nodeType;
                if (target.classList.contains('delete-node-btn')) {
                    e.preventDefault();
                    if (!confirm(`Sei sicuro di voler eliminare "${nodeId}"?`)) return;
                    const adventureSnap = await getDoc(adventureRef);
                    if (adventureSnap.exists()) {
                        const nodes = adventureSnap.data()[type] || [];
                        const nodeToDelete = nodes.find(n => n.title === nodeId);
                        const sharedItems = adventureSnap.data().sharedItems || [];
                        const sharedItemToDelete = sharedItems.find(item => item.id === nodeId);
                        const updatePayload = { [type]: arrayRemove(nodeToDelete) };
                        if (sharedItemToDelete) updatePayload.sharedItems = arrayRemove(sharedItemToDelete);
                        await updateDoc(adventureRef, updatePayload);
                    }
                } else if (target.classList.contains('edit-node-btn')) {
                    e.preventDefault();
                    container.querySelector('.node-view-mode').classList.add('hidden');
                    container.querySelector('.node-edit-mode').classList.remove('hidden');
                } else if (target.classList.contains('cancel-edit-btn')) {
                    container.querySelector('.node-view-mode').classList.remove('hidden');
                    container.querySelector('.node-edit-mode').classList.add('hidden');
                } else if (target.classList.contains('save-node-btn')) {
                    const adventureSnap = await getDoc(adventureRef);
                    if (adventureSnap.exists()) {
                        const nodes = adventureSnap.data()[type] || [];
                        const nodeIndex = nodes.findIndex(n => n.title === nodeId);
                        if (nodeIndex !== -1) {
                            const updatedNodes = [...nodes];
                            const newNodeData = { ...updatedNodes[nodeIndex], publicContent: container.querySelector('.node-public-content-edit').value, masterContent: container.querySelector('.node-master-content-edit').value, imageUrl: container.querySelector('.node-image-url-edit').value };
                            updatedNodes[nodeIndex] = newNodeData;
                            const sharedItems = adventureSnap.data().sharedItems || [];
                            const sharedItemIndex = sharedItems.findIndex(item => item.id === nodeId);
                            const updatePayload = { [type]: updatedNodes };
                            if (sharedItemIndex > -1) { const updatedSharedItems = [...sharedItems]; updatedSharedItems[sharedItemIndex] = { ...updatedSharedItems[sharedItemIndex], ...newNodeData }; updatePayload.sharedItems = updatedSharedItems; }
                            await updateDoc(adventureRef, updatePayload);
                        }
                    }
                }
            }
        });

        function renderChaptersUI(chapters = []) {
            const container = document.getElementById('chapters-container');
            container.innerHTML = '';
            if (chapters.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center font-sans p-4">Nessun capitolo. Aggiungine uno!</p>'; return; }
            chapters.forEach(chapter => {
                const sharedWith = currentAdventureData.sharedItems?.find(item => item.id === chapter.id)?.sharedWith || [];
                const shareStatus = sharedWith.length === 0 ? 'Condividi' : (sharedWith.includes('all') ? 'Condiviso con tutti' : `Condiviso con ${sharedWith.length}`);
                const chapterEl = document.createElement('div');
                chapterEl.className = 'chapter-container bg-gray-700 rounded-lg';
                chapterEl.dataset.chapterId = chapter.id;
                chapterEl.innerHTML = `<div class="chapter-view-mode p-4"><div class="flex justify-between items-center mb-2"><h4 class="text-2xl font-bold text-red-400">${chapter.title}</h4><div class="flex items-center gap-2"><button class="open-share-modal-btn text-sm font-bold py-1 px-3 rounded-lg bg-blue-600 hover:bg-blue-700">${shareStatus}</button><button class="edit-chapter-btn text-gray-400 hover:text-green-500 font-bold p-1 text-lg">✎</button><button class="delete-chapter-btn text-gray-400 hover:text-red-500 font-bold p-1 text-xl">&times;</button></div></div><div class="font-sans text-gray-300 border-t border-gray-600 pt-2">${renderTextWithLinks(chapter.publicContent)}</div><div class="mt-2 pt-2 border-t border-dashed border-yellow-500"><h4 class="text-yellow-400 font-bold text-sm">Note Master</h4><div class="text-gray-400 font-sans text-sm">${renderTextWithLinks(chapter.masterContent)}</div></div></div><div class="chapter-edit-mode hidden p-4 space-y-2"><label class="font-bold text-sm text-gray-400">Titolo Capitolo</label><input type="text" class="chapter-title-edit w-full bg-gray-600 rounded-lg p-2 font-sans" value="${chapter.title}"><label class="font-bold text-sm text-gray-400">Contenuto Pubblico (per i giocatori)</label><textarea class="chapter-public-content-edit w-full h-32 bg-gray-600 rounded-lg p-2 font-sans">${chapter.publicContent || ''}</textarea><label class="font-bold text-sm text-yellow-400">Note Master (private)</label><textarea class="chapter-master-content-edit w-full h-32 bg-gray-600 rounded-lg p-2 font-sans">${chapter.masterContent || ''}</textarea><div class="flex gap-2 mt-2"><button class="save-chapter-btn flex-grow bg-blue-600 hover:bg-blue-700 rounded-lg p-2 text-base">Salva</button><button class="cancel-edit-chapter-btn flex-grow bg-gray-600 hover:bg-gray-500 rounded-lg p-2 text-base">Annulla</button></div></div>`;
                container.appendChild(chapterEl);
            });
        }

        document.getElementById('add-chapter-btn').addEventListener('click', async () => { if (!currentAdventureId) return; const title = prompt("Titolo del nuovo capitolo:", "Nuovo Capitolo"); if (!title) return; const newChapter = { id: crypto.randomUUID(), title, publicContent: "", masterContent: "", order: (currentAdventureData.background?.length || 0) }; await updateDoc(doc(db, `users/${currentUserId}/adventures`, currentAdventureId), { background: arrayUnion(newChapter) }); });

        document.getElementById('chapters-container').addEventListener('click', async e => {
            const container = e.target.closest('.chapter-container');
            if (!container) return;
            const chapterId = container.dataset.chapterId;
            const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
            if (e.target.classList.contains('edit-chapter-btn')) { container.querySelector('.chapter-view-mode').classList.add('hidden'); container.querySelector('.chapter-edit-mode').classList.remove('hidden'); } 
            else if (e.target.classList.contains('cancel-edit-chapter-btn')) { container.querySelector('.chapter-view-mode').classList.remove('hidden'); container.querySelector('.chapter-edit-mode').classList.add('hidden'); } 
            else if (e.target.classList.contains('delete-chapter-btn')) { if (!confirm("Sei sicuro di voler eliminare questo capitolo?")) return; const chapterToDelete = currentAdventureData.background.find(c => c.id === chapterId); const sharedItemToDelete = currentAdventureData.sharedItems.find(item => item.id === chapterId); const updatePayload = { background: arrayRemove(chapterToDelete) }; if (sharedItemToDelete) updatePayload.sharedItems = arrayRemove(sharedItemToDelete); await updateDoc(adventureRef, updatePayload); } 
            else if (e.target.classList.contains('save-chapter-btn')) { const newTitle = container.querySelector('.chapter-title-edit').value; const newPublicContent = container.querySelector('.chapter-public-content-edit').value; const newMasterContent = container.querySelector('.chapter-master-content-edit').value; const updatedChapters = currentAdventureData.background.map(c => c.id === chapterId ? { ...c, title: newTitle, publicContent: newPublicContent, masterContent: newMasterContent } : c); const updatedSharedItems = currentAdventureData.sharedItems.map(item => item.id === chapterId ? { ...item, title: newTitle, publicContent: newPublicContent } : item); await updateDoc(adventureRef, { background: updatedChapters, sharedItems: updatedSharedItems }); }
        });

        function renderPlayerManagementUI(adventureId, players = []) {
            const shareContainer = document.getElementById('player-share-content');
            const baseUrl = window.location.href.split('?')[0];
            let playerListHtml = players.map(player => `<div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg"><span class="font-sans font-medium text-gray-200">${player.name}</span><div class="flex items-center gap-2"><button class="view-sheet-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm" data-token="${player.token}">Vedi Scheda</button><input type="text" value="${baseUrl}?player_view=${adventureId}&token=${player.token}" class="bg-gray-600 border border-gray-500 rounded-lg p-1 text-sm w-40 md:w-56 font-sans" readonly><button class="copy-player-link-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm" data-link="${baseUrl}?player_view=${adventureId}&token=${player.token}">Copia</button><button class="delete-player-btn text-red-400 hover:text-red-300 font-bold text-xl" data-token="${player.token}">&times;</button></div></div>`).join('');
            shareContainer.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-gray-300">Gestisci Giocatori</h3><form id="add-player-form" class="flex gap-2 mb-4"><input type="text" id="player-name-input" placeholder="Nome del giocatore" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans" required><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Aggiungi</button></form><div id="player-links-list" class="space-y-2">${playerListHtml || '<p class="text-gray-500 font-sans">Nessun giocatore aggiunto.</p>'}</div>`;
            document.getElementById('add-player-form').addEventListener('submit', handleAddPlayer);
            shareContainer.addEventListener('click', (e) => { if (e.target.classList.contains('copy-player-link-btn')) handleCopyLink(e); if (e.target.classList.contains('delete-player-btn')) handleDeletePlayer(e); if (e.target.classList.contains('view-sheet-btn')) openCharacterSheetModal(e.target.dataset.token); });
        }

        const DND_RACE_SPEEDS = { "Umano": 9, "Umano (Variant)": 9, "Nano (Delle Colline)": 7.5, "Nano (Delle Montagne)": 7.5, "Nano (Duergar)": 7.5, "Elfo (Alto)": 9, "Elfo (Dei Boschi)": 10.5, "Elfo (Drow)": 9, "Elfo (Shadar-kai)": 9, "Mezzelfo": 9, "Mezzorco": 9, "Halfling (Piedelesto)": 7.5, "Halfling (Tozzo)": 7.5, "Dragonide": 9, "Tiefling": 9, "Gnomo (Delle Foreste)": 7.5, "Gnomo (Delle Rocce)": 7.5, "Goblin": 9, "Hobgoblin": 9, "Bugbear": 9, "Goliath": 9, "Lizardfolk": 9, "Tabaxi": 12, "Tritone": 9, "Leonin": 12, "Minotauro": 9, "Satiro": 10.5, "Warforged": 9, "Firbolg": 9, "Kenku": 9, "Koboldo": 9, "Orco": 9, "Shifter": 9, "Yuan-ti": 9, "Vedalken": 9, "Loxodon": 9, "Simic Hybrid": 9, "Genasi (Acqua)": 9, "Genasi (Aria)": 9, "Genasi (Fuoco)": 9, "Genasi (Terra)": 9, "Cangiante": 9, "Centauro": 12, "Aasimar (Protettore)": 9, "Aasimar (Flagello)": 9, "Aasimar (Caduto)": 9, "Kalashtar": 9, "default": 9 };
        function getMonkBonusSpeed(level) { if (level >= 18) return 15; if (level >= 14) return 12; if (level >= 10) return 9; if (level >= 6) return 6; if (level >= 2) return 3; return 0; }
        function getBarbarianBonusSpeed(level, heavyArmor) { if (level >= 5 && !heavyArmor) return 3; return 0; }
        function calcBaseSpeed(race, classes, heavyArmor = false) { let speed = DND_RACE_SPEEDS[race] || DND_RACE_SPEEDS["default"]; const monkClass = classes.find(c => c.name === "Monaco"); if (monkClass) speed += getMonkBonusSpeed(parseInt(monkClass.level)); const barbarianClass = classes.find(c => c.name === "Barbaro"); if (barbarianClass) speed += getBarbarianBonusSpeed(parseInt(barbarianClass.level), heavyArmor); return speed; }
        function updateSpeedField(sheetData) { const race = sheetData.race || "Umano"; const classes = sheetData.classes || []; const heavyArmor = false; const baseSpeed = calcBaseSpeed(race, classes, heavyArmor); document.getElementById('cs-speed-auto').value = `${baseSpeed} m`; document.getElementById('cs-speed-modifier').value = sheetData.speedModifier || ''; }
        
        const DND_CLASSES = ["Artefice", "Barbaro", "Bardo", "Chierico", "Druido", "Guerriero", "Ladro", "Mago", "Monaco", "Paladino", "Ranger", "Stregone", "Warlock"];
        const DND_RACES = ["Aasimar (Protettore)", "Aasimar (Flagello)", "Aasimar (Caduto)", "Bugbear", "Cangiante", "Centauro", "Dragonide", "Nano (Delle Colline)", "Nano (Delle Montagne)", "Nano (Duergar)", "Elfo (Alto)", "Elfo (Dei Boschi)", "Elfo (Drow)", "Elfo (Shadar-kai)", "Firbolg", "Genasi (Acqua)", "Genasi (Aria)", "Genasi (Fuoco)", "Genasi (Terra)", "Gith (Githyanki)", "Gith (Githzerai)", "Gnomo (Delle Foreste)", "Gnomo (Delle Rocce)", "Goblin", "Goliath", "Halfling (Piedelesto)", "Halfling (Tozzo)", "Hobgoblin", "Kalashtar", "Kenku", "Koboldo", "Leonin", "Lizardfolk", "Loxodon", "Mezzelfo", "Mezzorco", "Minotauro", "Orco", "Satiro", "Shifter", "Simic Hybrid", "Tabaxi", "Tiefling", "Tritone", "Tortle", "Umano", "Umano (Variant)", "Vedalken", "Warforged", "Yuan-ti"];
        const DND_SKILLS = { "Acrobazia": "dexterity", "Addestrare Animali": "wisdom", "Arcano": "intelligence", "Atletica": "strength", "Furtività": "dexterity", "Indagare": "intelligence", "Inganno": "charisma", "Intimidire": "charisma", "Intrattenere": "charisma", "Intuizione": "wisdom", "Medicina": "wisdom", "Natura": "intelligence", "Percezione": "wisdom", "Persuasione": "charisma", "Rapidità di Mano": "dexterity", "Religione": "intelligence", "Sopravvivenza": "wisdom", "Storia": "intelligence" };
        const DND_SAVES = { "Forza": "strength", "Destrezza": "dexterity", "Costituzione": "constitution", "Intelligenza": "intelligence", "Saggezza": "wisdom", "Carisma": "charisma" };

        function createEmptyCharacterSheet() {
            return {
                characterName: "",
                classes: [{ id: crypto.randomUUID(), name: "Guerriero", level: 1 }],
                background: "", race: "Umano",
                stats: { strength: 10, dexterity: 10, constitution: 10, intelligence: 10, wisdom: 10, charisma: 10 },
                proficiencyBonus: 2, initiativeBonus: 0, speedModifier: "",
                hp: { max: 10, current: 10 }, hitDice: "",
                deathSaves: { successes: [false, false, false], failures: [false, false, false] },
                features: [],
                personalityTraits: "", ideals: "", bonds: "", flaws: "",
                proficiencies: { saves: [], skills: [] },
                defenses: [], weapons: [], equipment: [], companions: [],
                treasure: { cp: 0, sp: 0, gp: 0, pp: 0, other: [] },
                otherProficiencies: "", languages: "",
                senses: { passivePerception: 10, other: "" },
                spellcasting: {
                    class: "", ability: "intelligence", saveDC: 0, attackBonus: "+0",
                    slots: { 1: {total:0, used:0}, 2: {total:0, used:0}, 3: {total:0, used:0}, 4: {total:0, used:0}, 5: {total:0, used:0}, 6: {total:0, used:0}, 7: {total:0, used:0}, 8: {total:0, used:0}, 9: {total:0, used:0} },
                    spells: { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [] }
                }
            };
        }

        async function handleAddPlayer(e) { e.preventDefault(); if (!currentAdventureId || !currentUserId) return; const nameInput = document.getElementById('player-name-input'); const playerName = nameInput.value.trim(); if (!playerName) return; const newPlayer = { name: playerName, token: crypto.randomUUID(), characterSheet: createEmptyCharacterSheet() }; const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId); const publicAdventureRef = doc(db, 'publicAdventures', currentAdventureId); try { await updateDoc(adventureRef, { players: arrayUnion(newPlayer) }); await updateDoc(publicAdventureRef, { players: arrayUnion(newPlayer) }); nameInput.value = ''; } catch (error) { console.error("Errore aggiunta giocatore:", error); } }
        function handleCopyLink(e) { const button = e.target; const link = button.dataset.link; navigator.clipboard.writeText(link).then(() => { button.textContent = 'Copiato!'; button.classList.replace('bg-blue-600', 'bg-green-600'); setTimeout(() => { button.textContent = 'Copia'; button.classList.replace('bg-green-600', 'bg-blue-600'); }, 2000); }); }
        async function handleDeletePlayer(e) { if (!currentAdventureId || !currentUserId) return; const tokenToDelete = e.target.dataset.token; if (!confirm("Sei sicuro di voler rimuovere questo giocatore?")) return; const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId); const publicAdventureRef = doc(db, 'publicAdventures', currentAdventureId); const adventureSnap = await getDoc(adventureRef); if (adventureSnap.exists()) { const playerToDelete = (adventureSnap.data().players || []).find(p => p.token === tokenToDelete); if (playerToDelete) { try { await updateDoc(adventureRef, { players: arrayRemove(playerToDelete) }); await updateDoc(publicAdventureRef, { players: arrayRemove(playerToDelete) }); } catch (error) { console.error("Errore rimozione giocatore:", error); } } } }

        const shareModal = document.getElementById('share-modal');
        const shareModalTitle = document.getElementById('share-modal-title');
        const sharePlayerList = document.getElementById('share-player-list');
        let currentSharingItem = { id: null, type: null };

        document.getElementById('adventure-detail-view').addEventListener('click', (e) => {
            if (e.target.classList.contains('open-share-modal-btn')) {
                const chapterContainer = e.target.closest('.chapter-container');
                const nodeContainer = e.target.closest('.node-container');
                if (chapterContainer) { currentSharingItem.id = chapterContainer.dataset.chapterId; currentSharingItem.type = 'chapter'; } 
                else if (nodeContainer) { currentSharingItem.id = nodeContainer.dataset.nodeId; currentSharingItem.type = 'node'; }
                openShareModal();
            }
        });

        function openShareModal() {
            const players = currentAdventureData.players || [];
            if (players.length === 0) { alert("Aggiungi almeno un giocatore prima di poter condividere."); return; }
            const sharedItem = currentAdventureData.sharedItems?.find(item => item.id === currentSharingItem.id);
            const sharedWith = sharedItem?.sharedWith || [];
            shareModalTitle.textContent = `Condividi "${currentSharingItem.id}"`;
            sharePlayerList.innerHTML = `<div class="flex items-center"><input type="checkbox" id="share-all-players" class="w-4 h-4" ${sharedWith.includes('all') ? 'checked' : ''}><label for="share-all-players" class="ml-2">Tutti i giocatori</label></div><hr class="border-gray-600 my-2">${players.map(p => `<div class="flex items-center"><input type="checkbox" id="share-${p.token}" data-token="${p.token}" class="w-4 h-4 player-checkbox" ${sharedWith.includes(p.token) ? 'checked' : ''}><label for="share-${p.token}" class="ml-2">${p.name}</label></div>`).join('')}`;
            const allPlayersCheckbox = document.getElementById('share-all-players');
            const playerCheckboxes = sharePlayerList.querySelectorAll('.player-checkbox');
            allPlayersCheckbox.addEventListener('change', () => { playerCheckboxes.forEach(cb => { cb.checked = allPlayersCheckbox.checked; cb.disabled = allPlayersCheckbox.checked; }); });
            if (allPlayersCheckbox.checked) { playerCheckboxes.forEach(cb => { cb.disabled = true; }); }
            shareModal.classList.remove('hidden');
        }

        document.getElementById('share-modal-cancel').addEventListener('click', () => shareModal.classList.add('hidden'));
        document.getElementById('share-modal-save').addEventListener('click', async () => {
            const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
            const publicAdventureRef = doc(db, 'publicAdventures', currentAdventureId);
            let sharedWith = [];
            if (document.getElementById('share-all-players').checked) { sharedWith.push('all'); } else { sharePlayerList.querySelectorAll('.player-checkbox:checked').forEach(cb => sharedWith.push(cb.dataset.token)); }
            let sharedItems = [...(currentAdventureData.sharedItems || [])];
            let itemIndex = sharedItems.findIndex(item => item.id === currentSharingItem.id);
            if (sharedWith.length > 0) {
                if (itemIndex > -1) { sharedItems[itemIndex].sharedWith = sharedWith; } 
                else { let sourceItem; if (currentSharingItem.type === 'chapter') { sourceItem = currentAdventureData.background.find(c => c.id === currentSharingItem.id); if (sourceItem) sharedItems.push({ ...sourceItem, isChapter: true, sharedWith }); } else { const allNodes = [...currentAdventureData.environments, ...currentAdventureData.pngs, ...currentAdventureData.maps, ...currentAdventureData.treasures, ...currentAdventureData.monsters]; sourceItem = allNodes.find(n => n.title === currentSharingItem.id); if (sourceItem) sharedItems.push({ ...sourceItem, id: sourceItem.title, isChapter: false, sharedWith }); } }
            } else { if (itemIndex > -1) sharedItems.splice(itemIndex, 1); }
            try { await updateDoc(adventureRef, { sharedItems }); const publicSharedItems = sharedItems.map(item => { const { masterContent, ...publicItem } = item; return publicItem; }); await updateDoc(publicAdventureRef, { sharedItems: publicSharedItems }); shareModal.classList.add('hidden'); } 
            catch (error) { console.error("Errore durante la condivisione:", error); alert("Si è verificato un errore."); }
        });
        
        // --- LOGICA SCHEDA PERSONAGGIO ---
        const csModal = document.getElementById('character-sheet-modal');
        const csModalContent = document.getElementById('cs-modal-content');

        function getProficiencyBonusFromLevel(level) {
            if (level < 1) level = 1;
            if (level >= 17) return 6;
            if (level >= 13) return 5;
            if (level >= 9) return 4;
            if (level >= 5) return 3;
            return 2;
        }

        function openCharacterSheetModal(playerToken, isPlayerView = false) {
            const player = currentAdventureData.players.find(p => p.token === playerToken);
            if (!player) return;
            
            document.getElementById('cs-modal-title').textContent = `Scheda di ${player.name}`;
            csModal.dataset.currentToken = playerToken;
            csModal.dataset.isPlayerView = isPlayerView;

            const emptySheet = createEmptyCharacterSheet();
            let playerSheet = player.characterSheet || {};

            if (playerSheet.featuresTraits && !playerSheet.features) {
                playerSheet.features = [{ id: crypto.randomUUID(), name: "Vecchi Privilegi & Tratti", type: "Altro", description: playerSheet.featuresTraits }];
                delete playerSheet.featuresTraits;
            }
            if (typeof playerSheet.treasure?.other === 'string') {
                playerSheet.treasure.other = [{ id: crypto.randomUUID(), name: "Vecchio Tesoro", value: "", description: playerSheet.treasure.other }];
            }

            const sheetData = {
                ...emptySheet,
                ...playerSheet,
                stats: { ...emptySheet.stats, ...(playerSheet.stats || {}) },
                hp: { ...emptySheet.hp, ...(playerSheet.hp || {}) },
                treasure: { ...emptySheet.treasure, ...(playerSheet.treasure || {}) },
                proficiencies: { ...emptySheet.proficiencies, ...(playerSheet.proficiencies || {}) },
                deathSaves: { ...emptySheet.deathSaves, ...(playerSheet.deathSaves || {}) },
                features: playerSheet.features || [],
                companions: playerSheet.companions || [],
                senses: { ...emptySheet.senses, ...(playerSheet.senses || {}) },
                spellcasting: {
                    ...emptySheet.spellcasting,
                    ...(playerSheet.spellcasting || {}),
                    slots: { ...emptySheet.spellcasting.slots, ...(playerSheet.spellcasting?.slots || {}) },
                    spells: { ...emptySheet.spellcasting.spells, ...(playerSheet.spellcasting?.spells || {}) },
                }
            };

            populateCharacterSheet(sheetData);
            csModal.classList.remove('hidden');
        }

        function populateCharacterSheet(sheetData) {
            const totalLevel = (sheetData.classes || []).reduce((sum, c) => sum + parseInt(c.level || 0), 0);
            const correctProfBonus = getProficiencyBonusFromLevel(totalLevel);
            sheetData.proficiencyBonus = correctProfBonus;

            window.currentSheetData = sheetData; 
            
            csModalContent.querySelectorAll('[data-field]').forEach(el => {
                if (['armorClass', 'race', 'initiative', 'proficiencyBonus', 'senses.passivePerception'].includes(el.dataset.field) || el.dataset.field === 'featuresTraits') return;
                const fieldPath = el.dataset.field;
                const value = fieldPath.split('.').reduce((obj, key) => (obj && obj[key] !== undefined) ? obj[key] : '', sheetData);
                if (el.tagName === 'SELECT') { el.value = value || el.options[0].value; } else { el.value = value; }
            });

            const profBonusInput = csModalContent.querySelector('[data-field="proficiencyBonus"]');
            if (profBonusInput) {
                profBonusInput.value = formatModifier(sheetData.proficiencyBonus);
            }

            updateAllModifiers(sheetData);
            renderSkillsAndSaves(sheetData);
            renderDefenses(sheetData.defenses || []);
            renderClasses(sheetData.classes || [{ id: crypto.randomUUID(), name: '', level: 1 }]);
            renderRace(sheetData.race || '');
            renderEquipment(sheetData.equipment || []);
            renderSpells(sheetData.spellcasting || createEmptyCharacterSheet().spellcasting);
            renderFeatures(sheetData.features || []);
            renderOtherTreasures(sheetData.treasure.other || []);
            renderCompanions(sheetData.companions || []);
            
            const deathSaves = sheetData.deathSaves || { successes: [false, false, false], failures: [false, false, false] };
            csModalContent.querySelectorAll('[data-death-save-success]').forEach((el, index) => { el.checked = deathSaves.successes[index] || false; });
            csModalContent.querySelectorAll('[data-death-save-failure]').forEach((el, index) => { el.checked = deathSaves.failures[index] || false; });

            updateTotalLevel(sheetData);
            updateAC(sheetData);
            updateInitiative(sheetData);
            updateSpeedField(sheetData);
            updatePassivePerception(sheetData);
            renderWeaponsList(sheetData);
            updateSpellcastingCalculatedFields(sheetData);
        }
        
        function getStatMod(stat, stats) { return Math.floor(((stats[stat] || 10) - 10) / 2); }
        
        function getAttackStat(weapon, stats) {
            if (weapon.overrideStat && weapon.overrideStat !== 'default') {
                return weapon.overrideStat;
            }
            if ((weapon.properties || '').toLowerCase().includes('accurata') || (weapon.properties || '').toLowerCase().includes('finesse')) {
                return getStatMod('dexterity', stats) > getStatMod('strength', stats) ? 'dexterity' : 'strength';
            }
            if (weapon.type === 'distanza') {
                return 'dexterity';
            }
            return 'strength';
        }

        function calcAttackBonus(weapon, stats, proficiencyBonus) {
            const stat = getAttackStat(weapon, stats);
            const mod = getStatMod(stat, stats);
            let bonus = mod + (weapon.proficient ? proficiencyBonus : 0) + (parseInt(weapon.attackBonus) || 0);
            return bonus >= 0 ? `+${bonus}` : `${bonus}`;
        }
        
        function renderWeaponsList(sheetData) {
            const container = document.getElementById('weapons-list-container');
            container.innerHTML = '';
            if (!sheetData.weapons || sheetData.weapons.length === 0) { container.innerHTML = '<p class="text-gray-500 font-sans">Nessuna arma inserita.</p>'; return; }
            const types = ['mischia', 'distanza', 'altro'];
            types.forEach(type => {
                const weapons = sheetData.weapons.filter(w => w.type === type);
                if (weapons.length === 0) return;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-2';
                groupDiv.innerHTML = `<h4 class="text-red-700 text-lg font-bold mb-1 capitalize">${type}</h4><table class="w-full text-xs md:text-sm mb-2"><thead><tr class="bg-gray-300 text-black"><th class="p-1 text-left">Nome</th><th class="p-1">TxC</th><th class="p-1">Danno</th><th class="p-1"></th></tr></thead><tbody>${weapons.map(w => { const globalIndex = sheetData.weapons.indexOf(w); let damageButtonsHtml = ''; if (w.versatileDamage) { damageButtonsHtml = `<div class="flex gap-1 justify-center"><button class="roll-damage-btn bg-yellow-500 hover:bg-yellow-600 text-black text-xs rounded px-2 py-1 font-sans" data-idx="${globalIndex}" data-versatile="false">${w.damage}</button><button class="roll-damage-btn bg-orange-500 hover:bg-orange-600 text-black text-xs rounded px-2 py-1 font-sans" data-idx="${globalIndex}" data-versatile="true">${w.versatileDamage} (V)</button></div>`; } else { damageButtonsHtml = `<button class="roll-damage-btn bg-yellow-500 hover:bg-yellow-600 text-black text-sm rounded px-3 py-1 font-sans" data-idx="${globalIndex}" data-versatile="false">${w.damage}</button>`; } const ammoType = w.ammunitionType ? `<em class="text-gray-500 text-xs">(${w.properties} | ${w.ammunitionType})</em>` : `<em class="text-gray-500 text-xs">(${w.properties})</em>`; return `<tr class="border-b border-gray-200 text-center"><td class="p-1 text-left">${w.name} ${ammoType}</td><td class="p-1"><button class="roll-attack-btn bg-red-600 hover:bg-red-700 text-white text-sm rounded px-3 py-1 font-sans" data-idx="${globalIndex}">${calcAttackBonus(w, sheetData.stats, sheetData.proficiencyBonus)}</button></td><td class="p-1">${damageButtonsHtml}</td><td class="p-1"><button class="edit-weapon-btn text-blue-600 p-1" data-idx="${globalIndex}">✎</button><button class="delete-weapon-btn text-red-600 p-1" data-idx="${globalIndex}">&times;</button></td></tr>`}).join('')}</tbody></table>`;
                container.appendChild(groupDiv);
            });
        }

        document.getElementById('add-weapon-btn').addEventListener('click', () => openWeaponModal());
        function openWeaponModal(weapon = null, idx = null) {
            const weaponModal = document.getElementById('weapon-modal');
            const weaponForm = document.getElementById('weapon-form');
            const weaponTypeSelect = document.getElementById('weapon-type');
            const ammoContainer = document.getElementById('weapon-ammo-container');
            
            weaponModal.classList.remove('hidden');
            weaponForm.reset();
            document.getElementById('weapon-index').value = idx !== null ? idx : '';
            
            const versatileContainer = document.getElementById('weapon-versatile-container');
            const versatileCheckbox = document.getElementById('weapon-versatile-checkbox');
            const versatileDamageInput = document.getElementById('weapon-versatile-damage');

            if (weapon) {
                weaponTypeSelect.value = weapon.type || 'mischia';
                document.getElementById('weapon-name').value = weapon.name || '';
                document.getElementById('weapon-ammunition-type').value = weapon.ammunitionType || '';
                document.getElementById('weapon-override-stat').value = weapon.overrideStat || 'default';
                document.getElementById('weapon-damage').value = weapon.damage || '';
                document.getElementById('weapon-damage-type').value = weapon.damageType || '';
                document.getElementById('weapon-properties').value = weapon.properties || '';
                document.getElementById('weapon-proficient').checked = weapon.proficient || false;
                document.getElementById('weapon-attack-bonus').value = weapon.attackBonus || 0;
                document.getElementById('weapon-damage-bonus').value = weapon.damageBonus || 0;
                versatileCheckbox.checked = !!weapon.versatileDamage;
                versatileDamageInput.value = weapon.versatileDamage || '';
            } else {
                versatileCheckbox.checked = false;
                versatileDamageInput.value = '';
                weaponTypeSelect.value = 'mischia';
            }

            ammoContainer.classList.toggle('hidden', weaponTypeSelect.value !== 'distanza');
            versatileContainer.classList.toggle('hidden', !versatileCheckbox.checked);
        }
        document.getElementById('weapon-type').addEventListener('change', (e) => { document.getElementById('weapon-ammo-container').classList.toggle('hidden', e.target.value !== 'distanza'); });
        document.getElementById('weapon-versatile-checkbox').addEventListener('change', (e) => { document.getElementById('weapon-versatile-container').classList.toggle('hidden', !e.target.checked); });
        document.getElementById('weapon-cancel-btn').addEventListener('click', () => { document.getElementById('weapon-modal').classList.add('hidden'); });

        document.getElementById('weapon-form').addEventListener('submit', e => {
          e.preventDefault();
          const token = csModal.dataset.currentToken; if (!token) return;
          const idx = document.getElementById('weapon-index').value;
          const newWeapon = { name: document.getElementById('weapon-name').value, type: document.getElementById('weapon-type').value, ammunitionType: document.getElementById('weapon-ammunition-type').value, overrideStat: document.getElementById('weapon-override-stat').value, damage: document.getElementById('weapon-damage').value, versatileDamage: document.getElementById('weapon-versatile-checkbox').checked ? document.getElementById('weapon-versatile-damage').value : null, damageType: document.getElementById('weapon-damage-type').value, properties: document.getElementById('weapon-properties').value, proficient: document.getElementById('weapon-proficient').checked, attackBonus: document.getElementById('weapon-attack-bonus').value, damageBonus: document.getElementById('weapon-damage-bonus').value };
          let sheetData = window.currentSheetData;
          if (!sheetData.weapons) sheetData.weapons = [];
          if (idx !== '') { sheetData.weapons[parseInt(idx)] = newWeapon; } else { sheetData.weapons.push(newWeapon); }
          saveCharacterSheet(token, sheetData);
          populateCharacterSheet(sheetData);
          document.getElementById('weapon-modal').classList.add('hidden');
        });

        document.getElementById('weapons-list-container').addEventListener('click', e => {
          const token = csModal.dataset.currentToken; if (!token) return;
          const btn = e.target.closest('.edit-weapon-btn, .delete-weapon-btn'); if (!btn) return;
          const idx = btn.dataset.idx ? parseInt(btn.dataset.idx) : null; if (idx === null) return;
          let sheetData = window.currentSheetData;
          if (btn.classList.contains('edit-weapon-btn')) { openWeaponModal(sheetData.weapons[idx], idx); } 
          else if (btn.classList.contains('delete-weapon-btn')) { sheetData.weapons.splice(idx, 1); saveCharacterSheet(token, sheetData); populateCharacterSheet(sheetData); }
        });
        
        function getModifier(score) { return Math.floor((parseInt(score || 10) - 10) / 2); }
        function formatModifier(mod) { return mod >= 0 ? `+${mod}` : mod.toString(); }
        function updateAllModifiers(sheetData) { const stats = sheetData.stats || {}; for (const statName in stats) { const modEl = csModalContent.querySelector(`[data-mod="${statName}"]`); if (modEl) modEl.textContent = formatModifier(getModifier(stats[statName])); } }
        
        function renderSkillsAndSaves(sheetData) {
            const savesContainer = document.getElementById('saving-throws-list');
            const skillsContainer = document.getElementById('skills-list');
            const profs = sheetData.proficiencies || { saves: [], skills: [] };
            savesContainer.innerHTML = `<h4 class="text-lg font-bold text-red-800 mb-1">Tiri Salvezza</h4>` + Object.entries(DND_SAVES).map(([name, stat]) => `<div class="flex items-center gap-2 text-sm"><input type="checkbox" data-save-prof="${name}" ${profs.saves.includes(name) ? 'checked' : ''}><span class="w-8 text-center border-b border-gray-500">+0</span><span>${name}</span></div>`).join('');
            skillsContainer.innerHTML = `<h4 class="text-lg font-bold text-red-800 mt-2 mb-1">Abilità</h4>` + Object.entries(DND_SKILLS).map(([name, stat]) => `<div class="flex items-center gap-2 text-sm"><input type="checkbox" data-skill-prof="${name}" ${profs.skills.includes(name) ? 'checked' : ''}><span class="w-8 text-center border-b border-gray-500">+0</span><span>${name} (${stat.substring(0,3)})</span></div>`).join('');
            updateSkillAndSaveBonuses(sheetData);
        }
        
        function updateSkillAndSaveBonuses(sheetData) {
            const profBonus = sheetData.proficiencyBonus || 2;
            const stats = sheetData.stats || {};
            csModalContent.querySelectorAll('[data-save-prof]').forEach(el => { const saveName = el.dataset.saveProf; const statName = DND_SAVES[saveName]; const statMod = getModifier(stats[statName]); const bonus = statMod + (el.checked ? profBonus : 0); el.nextElementSibling.textContent = formatModifier(bonus); });
            csModalContent.querySelectorAll('[data-skill-prof]').forEach(el => { const skillName = el.dataset.skillProf; const statName = DND_SKILLS[skillName]; const statMod = getModifier(stats[statName]); const bonus = statMod + (el.checked ? profBonus : 0); el.nextElementSibling.textContent = formatModifier(bonus); });
        }
        
        function renderRace(raceName) {
            const container = document.getElementById('cs-race-container');
            const isCustom = !DND_RACES.includes(raceName) && raceName;
            let optionsHtml = DND_RACES.map(r => `<option value="${r}" ${r === raceName ? 'selected' : ''}>${r}</option>`).join('');
            container.innerHTML = `<label class="cs-label">Razza</label><select class="cs-select" id="cs-race-select">${optionsHtml}<option value="Altro..." ${isCustom ? 'selected' : ''}>Altro...</option></select><input type="text" id="cs-race-custom" class="cs-input mt-1 ${isCustom ? '' : 'hidden'}" value="${isCustom ? raceName : ''}" placeholder="Razza personalizzata">`;
        }

        function renderDefenses(defenses = []) {
            const container = document.getElementById('cs-defenses-list');
            container.innerHTML = defenses.map(item => `<div class="flex items-center gap-2 defense-item" data-id="${item.id}"><input type="checkbox" class="cs-defense-worn w-4 h-4" ${item.worn ? 'checked' : ''}><input type="text" class="cs-defense-name cs-input text-sm flex-grow" value="${item.name}" placeholder="Nome (es. Scudo)"><input type="number" class="cs-defense-value cs-input text-sm w-20" value="${item.value}" placeholder="Valore"><select class="cs-defense-type cs-select text-sm w-32"><option value="other" ${item.type === 'other' ? 'selected' : ''}>Altro</option><option value="light" ${item.type === 'light' ? 'selected' : ''}>Leggera</option><option value="medium" ${item.type === 'medium' ? 'selected' : ''}>Media</option><option value="heavy" ${item.type === 'heavy' ? 'selected' : ''}>Pesante</option><option value="shield" ${item.type === 'shield' ? 'selected' : ''}>Scudo</option></select><button class="cs-delete-defense-btn text-red-600 hover:text-red-800 font-bold">X</button></div>`).join('');
        }
        
        function renderClasses(classes = []) {
            const container = document.getElementById('cs-classes-list');
            container.innerHTML = classes.map(c => { const isCustom = !DND_CLASSES.includes(c.name) && c.name; return `<div class="flex items-center gap-2 class-item" data-id="${c.id}"><select class="cs-class-name cs-select">${DND_CLASSES.map(cn => `<option value="${cn}" ${cn === c.name ? 'selected' : ''}>${cn}</option>`).join('')}<option value="Altro..." ${isCustom ? 'selected' : ''}>Altro...</option></select><input type="text" class="cs-class-name-custom cs-input ${isCustom ? '' : 'hidden'}" value="${isCustom ? c.name : ''}" placeholder="Classe personalizzata"><input type="number" class="cs-class-level cs-input w-24" value="${c.level || 1}" placeholder="Lvl"><button class="cs-delete-class-btn text-red-600 hover:text-red-800 font-bold">X</button></div>`}).join('');
        }

        function updateTotalLevel(sheetData) { const totalLevel = (sheetData.classes || []).reduce((sum, c) => sum + parseInt(c.level || 0), 0); const totalLevelInput = document.getElementById('cs-total-level'); if (totalLevelInput) { totalLevelInput.value = totalLevel; } }
        function updateAC(sheetData) { const dexMod = getModifier(sheetData.stats.dexterity); let totalAC = 10; let armorBonus = 0; let dexBonus = dexMod; let otherBonuses = 0; const wornArmor = (sheetData.defenses || []).find(d => d.worn && ['light', 'medium', 'heavy'].includes(d.type)); if (wornArmor) { armorBonus = parseInt(wornArmor.value || 0); if (wornArmor.type === 'medium') { dexBonus = Math.min(dexMod, 2); } else if (wornArmor.type === 'heavy') { dexBonus = 0; } } (sheetData.defenses || []).forEach(item => { if (item.worn && (item.type === 'shield' || item.type === 'other')) { otherBonuses += parseInt(item.value || 0); } }); if (wornArmor) { totalAC = armorBonus + dexBonus + otherBonuses; } else { totalAC = 10 + dexBonus + otherBonuses; } csModalContent.querySelector('[data-field="armorClass"]').value = totalAC; }
        function updateInitiative(sheetData) { const dexMod = getModifier(sheetData.stats.dexterity); const bonus = parseInt(sheetData.initiativeBonus || 0); const total = dexMod + bonus; document.getElementById('cs-initiative-total').value = formatModifier(total); }
        function updatePassivePerception(sheetData) { const wisMod = getModifier(sheetData.stats.wisdom); const isProficient = (sheetData.proficiencies.skills || []).includes('Percezione'); const profBonus = sheetData.proficiencyBonus || 2; const perceptionBonus = wisMod + (isProficient ? profBonus : 0); const passivePerception = 10 + perceptionBonus; csModalContent.querySelector('[data-field="senses.passivePerception"]').value = passivePerception; }

        csModalContent.addEventListener('input', (e) => {
            const token = csModal.dataset.currentToken; if (!token) return;
            const sheetDataForUI = readSheetFromDOM();
            window.currentSheetData = sheetDataForUI;
            
            if (e.target.dataset.field && (e.target.dataset.field.startsWith('stats.') || e.target.dataset.field === 'initiativeBonus' || e.target.dataset.field === 'spellcasting.ability')) { updateAllModifiers(sheetDataForUI); updateSkillAndSaveBonuses(sheetDataForUI); updateAC(sheetDataForUI); updateInitiative(sheetDataForUI); updatePassivePerception(sheetDataForUI); updateSpellcastingCalculatedFields(sheetDataForUI); }
            if (e.target.dataset.skillProf || e.target.dataset.saveProf) { updateSkillAndSaveBonuses(sheetDataForUI); updatePassivePerception(sheetDataForUI); }
            if (e.target.closest('.defense-item')) { updateAC(sheetDataForUI); }
            if (e.target.classList.contains('cs-class-level') || e.target.classList.contains('cs-class-name')) { updateTotalLevel(sheetDataForUI); updateSpeedField(sheetDataForUI); }
            if (e.target.id === 'cs-race-select' || e.target.id === 'cs-race-custom') { updateSpeedField(sheetDataForUI); }
            
            clearTimeout(characterSheetUpdateTimeout);
            characterSheetUpdateTimeout = setTimeout(() => {
                const finalSheetData = readSheetFromDOM(); 
                populateCharacterSheet(finalSheetData); 
                saveCharacterSheet(token, window.currentSheetData);
            }, 500);
        });
        
        csModalContent.addEventListener('change', e => { 
            if (e.target.classList.contains('cs-class-name')) { const customInput = e.target.nextElementSibling; if (e.target.value === 'Altro...') { customInput.classList.remove('hidden'); } else { customInput.classList.add('hidden'); } } 
            if (e.target.id === 'cs-race-select') { const customInput = document.getElementById('cs-race-custom'); if (e.target.value === 'Altro...') { customInput.classList.remove('hidden'); } else { customInput.classList.add('hidden'); } } 
        });

        csModalContent.addEventListener('click', e => {
            const token = csModal.dataset.currentToken; if (!token) return;
            if (e.target.id === 'cs-add-defense-btn') { const newDefense = { id: crypto.randomUUID(), name: '', value: 0, type: 'other', worn: false }; const sheetData = window.currentSheetData; sheetData.defenses.push(newDefense); renderDefenses(sheetData.defenses); saveCharacterSheet(token, sheetData); }
            if (e.target.classList.contains('cs-delete-defense-btn')) { const itemEl = e.target.closest('.defense-item'); const itemId = itemEl.dataset.id; let sheetData = window.currentSheetData; sheetData.defenses = sheetData.defenses.filter(d => d.id !== itemId); renderDefenses(sheetData.defenses); updateAC(sheetData); saveCharacterSheet(token, sheetData); }
            if (e.target.id === 'cs-add-class-btn') { const newClass = { id: crypto.randomUUID(), name: 'Guerriero', level: 1 }; const sheetData = window.currentSheetData; sheetData.classes.push(newClass); renderClasses(sheetData.classes); updateTotalLevel(sheetData); saveCharacterSheet(token, sheetData); }
            if (e.target.classList.contains('cs-delete-class-btn')) { const itemEl = e.target.closest('.class-item'); const itemId = itemEl.dataset.id; let sheetData = window.currentSheetData; if (sheetData.classes.length > 1) { sheetData.classes = sheetData.classes.filter(c => c.id !== itemId); renderClasses(sheetData.classes); updateTotalLevel(sheetData); saveCharacterSheet(token, sheetData); } }
            const rollAttackBtn = e.target.closest('.roll-attack-btn'); if (rollAttackBtn) { handleWeaponRoll('attack', rollAttackBtn.dataset.idx); }
            const rollDamageBtn = e.target.closest('.roll-damage-btn'); if (rollDamageBtn) { const isVersatile = rollDamageBtn.dataset.versatile === 'true'; handleWeaponRoll('damage', rollDamageBtn.dataset.idx, isVersatile); }
            if (e.target.id === 'cs-add-companion-btn') { openCompanionModal(); }
            const editCompBtn = e.target.closest('.edit-companion-btn'); if (editCompBtn) { const idx = editCompBtn.dataset.idx; const companion = window.currentSheetData.companions[idx]; if (companion) openCompanionModal(companion, idx); }
            const deleteCompBtn = e.target.closest('.delete-companion-btn'); if (deleteCompBtn) { const idx = deleteCompBtn.dataset.idx; if (!confirm('Sei sicuro di voler eliminare questo compagno?')) return; let sheetData = window.currentSheetData; sheetData.companions.splice(idx, 1); saveCharacterSheet(token, sheetData); populateCharacterSheet(sheetData); }
        });

        const equipmentModal = document.getElementById('equipment-modal');
        function renderEquipment(equipment = []) {
            const container = document.getElementById('cs-equipment-list');
            container.innerHTML = equipment.map(item => {
                const isAmmo = item.isAmmunition ? '<span class="text-xs text-blue-600 font-bold">[Munizione]</span>' : '';
                return `<div class="p-1 border-b border-gray-300"><details><summary class="flex justify-between items-center cursor-pointer"><span>${item.quantity} x ${item.name} ${isAmmo}</span><div class="flex-shrink-0"><button class="edit-equipment-btn text-blue-600 p-1" data-id="${item.id}">✎</button><button class="delete-equipment-btn text-red-600 p-1" data-id="${item.id}">&times;</button></div></summary><p class="text-sm p-2 mt-1 border-t border-gray-200 bg-white/50 rounded">${(item.description || 'Nessuna descrizione.').replace(/\n/g, '<br>')}</p></details></div>`}).join('');
        }
        document.getElementById('cs-add-equipment-btn').addEventListener('click', () => openEquipmentModal());
        csModalContent.addEventListener('click', e => {
            if (e.target.classList.contains('edit-equipment-btn')) { const id = e.target.dataset.id; const item = window.currentSheetData.equipment.find(i => i.id === id); if(item) openEquipmentModal(item); }
            if (e.target.classList.contains('delete-equipment-btn')) { const id = e.target.dataset.id; const token = csModal.dataset.currentToken; if (!token) return; let sheetData = window.currentSheetData; sheetData.equipment = sheetData.equipment.filter(i => i.id !== id); saveCharacterSheet(token, sheetData); populateCharacterSheet(sheetData); }
        });
        function openEquipmentModal(item = null) {
            equipmentModal.classList.remove('hidden');
            document.getElementById('equipment-form').reset();
            if (item) {
                document.getElementById('equipment-modal-title').textContent = "Modifica Oggetto";
                document.getElementById('equipment-id').value = item.id;
                document.getElementById('equipment-name').value = item.name;
                document.getElementById('equipment-quantity').value = item.quantity;
                document.getElementById('equipment-description').value = item.description;
                document.getElementById('equipment-is-ammo').checked = item.isAmmunition || false;
            } else {
                document.getElementById('equipment-modal-title').textContent = "Aggiungi Oggetto";
                document.getElementById('equipment-id').value = '';
                document.getElementById('equipment-is-ammo').checked = false;
            }
        }
        document.getElementById('equipment-cancel-btn').addEventListener('click', () => equipmentModal.classList.add('hidden'));
        document.getElementById('equipment-form').addEventListener('submit', e => {
            e.preventDefault();
            const token = csModal.dataset.currentToken; if (!token) return;
            const id = document.getElementById('equipment-id').value;
            const newItem = { id: id || crypto.randomUUID(), name: document.getElementById('equipment-name').value, quantity: parseInt(document.getElementById('equipment-quantity').value), description: document.getElementById('equipment-description').value, isAmmunition: document.getElementById('equipment-is-ammo').checked };
            let sheetData = window.currentSheetData;
            if (id) { sheetData.equipment = sheetData.equipment.map(i => i.id === id ? newItem : i); } 
            else { sheetData.equipment.push(newItem); }
            saveCharacterSheet(token, sheetData);
            populateCharacterSheet(sheetData);
            equipmentModal.classList.add('hidden');
        });

        const spellModal = document.getElementById('spell-modal');
        function renderSpells(spellcasting) {
            const container = document.getElementById('cs-spell-levels-container');
            container.innerHTML = '';
            for (let level = 0; level <= 9; level++) {
                const levelData = spellcasting.spells[level] || [];
                const slotsData = spellcasting.slots ? (spellcasting.slots[level] || {total: 0, used: 0}) : {total: 0, used: 0};
                const levelEl = document.createElement('div');
                levelEl.className = 'cs-box spell-level-container';
                levelEl.dataset.level = level;
                let slotsHtml = '';
                if (level > 0) {
                    slotsHtml = `<div class="flex items-center gap-2 mb-2"><label class="text-xs">Slot Totali</label><input type="number" class="cs-input text-sm w-16 spell-slot-total" value="${slotsData.total}"><label class="text-xs">Usati</label><input type="number" class="cs-input text-sm w-16 spell-slot-used" value="${slotsData.used}"></div>`;
                }
                const spellListHtml = levelData.map(spell => {
                    const components = [];
                    if (spell.components?.v) components.push('V');
                    if (spell.components?.s) components.push('S');
                    if (spell.components?.m) components.push('M');
                    const concentration = spell.concentration ? '<span class="text-xs font-bold text-red-700">(C)</span>' : '';
                    return `<div class="p-1 border-b border-gray-300"><details><summary class="flex justify-between items-center cursor-pointer"><div class="flex items-center gap-2"><input type="checkbox" class="spell-prepared-checkbox w-4 h-4" ${spell.prepared ? 'checked' : ''} data-id="${spell.id}" data-level="${level}"><span>${spell.name} ${concentration}</span></div><div class="flex-shrink-0"><button class="edit-spell-btn text-blue-600 p-1" data-id="${spell.id}" data-level="${level}">✎</button><button class="delete-spell-btn text-red-600 p-1" data-id="${spell.id}" data-level="${level}">&times;</button></div></summary><div class="text-xs p-2 mt-1 border-t border-gray-200 bg-white/50 rounded"><p><strong>Tempo Lancio:</strong> ${spell.castingTime || 'N/A'} | <strong>Gittata:</strong> ${spell.range || 'N/A'}</p><p><strong>Componenti:</strong> ${components.join(', ') || 'Nessuna'} | <strong>Durata:</strong> ${spell.duration || 'N/A'}</p><p class="mt-2">${(spell.description || 'Nessuna descrizione.').replace(/\n/g, '<br>')}</p></div></details></div>`}).join('');
                levelEl.innerHTML = `<h4 class="text-lg font-bold text-red-800">${level === 0 ? 'Trucchetti' : `Livello ${level}`}</h4>${slotsHtml}<div class="spell-list space-y-1">${spellListHtml}</div><button class="add-spell-btn mt-2 w-full text-sm bg-green-700 hover:bg-green-800 rounded p-1 text-white">Aggiungi Incantesimo</button>`;
                container.appendChild(levelEl);
            }
        }
        function openSpellModal(level, spell = null) {
            spellModal.classList.remove('hidden');
            document.getElementById('spell-form').reset();
            document.getElementById('spell-level').value = level;
            if (spell) {
                document.getElementById('spell-modal-title').textContent = "Modifica Incantesimo";
                document.getElementById('spell-id').value = spell.id;
                document.getElementById('spell-name').value = spell.name;
                document.getElementById('spell-casting-time').value = spell.castingTime || '';
                document.getElementById('spell-range').value = spell.range || '';
                document.getElementById('spell-duration').value = spell.duration || '';
                document.getElementById('spell-concentration').checked = spell.concentration || false;
                document.getElementById('spell-comp-v').checked = spell.components?.v || false;
                document.getElementById('spell-comp-s').checked = spell.components?.s || false;
                document.getElementById('spell-comp-m').checked = spell.components?.m || false;
                document.getElementById('spell-description').value = spell.description;
            } else {
                document.getElementById('spell-modal-title').textContent = `Aggiungi Incantesimo (Liv. ${level})`;
                document.getElementById('spell-id').value = '';
            }
        }
        document.getElementById('spell-cancel-btn').addEventListener('click', () => spellModal.classList.add('hidden'));
        csModalContent.addEventListener('click', e => {
            const addBtn = e.target.closest('.add-spell-btn');
            if (addBtn) { const level = addBtn.closest('.spell-level-container').dataset.level; openSpellModal(level); }
            const editBtn = e.target.closest('.edit-spell-btn');
            if (editBtn) { const level = editBtn.dataset.level; const spellId = editBtn.dataset.id; const spell = window.currentSheetData.spellcasting.spells[level].find(s => s.id === spellId); if (spell) openSpellModal(level, spell); }
            const deleteBtn = e.target.closest('.delete-spell-btn');
            if (deleteBtn) { const token = csModal.dataset.currentToken; if (!token) return; const level = deleteBtn.dataset.level; const spellId = deleteBtn.dataset.id; let sheetData = window.currentSheetData; sheetData.spellcasting.spells[level] = sheetData.spellcasting.spells[level].filter(s => s.id !== spellId); saveCharacterSheet(token, sheetData); populateCharacterSheet(sheetData); }
        });
        document.getElementById('spell-form').addEventListener('submit', e => {
            e.preventDefault();
            const token = csModal.dataset.currentToken; if (!token) return;
            const id = document.getElementById('spell-id').value;
            const level = document.getElementById('spell-level').value;
            const newSpell = { 
                id: id || crypto.randomUUID(), 
                name: document.getElementById('spell-name').value, 
                castingTime: document.getElementById('spell-casting-time').value,
                range: document.getElementById('spell-range').value,
                duration: document.getElementById('spell-duration').value,
                concentration: document.getElementById('spell-concentration').checked,
                components: { v: document.getElementById('spell-comp-v').checked, s: document.getElementById('spell-comp-s').checked, m: document.getElementById('spell-comp-m').checked, },
                description: document.getElementById('spell-description').value, 
                prepared: false 
            };
            let sheetData = window.currentSheetData;
            if (id) { 
                const existingSpell = sheetData.spellcasting.spells[level].find(s => s.id === id);
                newSpell.prepared = existingSpell.prepared; 
                sheetData.spellcasting.spells[level] = sheetData.spellcasting.spells[level].map(s => s.id === id ? newSpell : s); 
            }
            else { 
                if (!sheetData.spellcasting.spells[level]) sheetData.spellcasting.spells[level] = []; 
                sheetData.spellcasting.spells[level].push(newSpell); 
            }
            saveCharacterSheet(token, sheetData);
            populateCharacterSheet(sheetData);
            spellModal.classList.add('hidden');
        });
        function updateSpellcastingCalculatedFields(sheetData) {
            const profBonus = sheetData.proficiencyBonus || 2;
            const spellAbility = sheetData.spellcasting.ability || 'intelligence';
            const abilityMod = getModifier(sheetData.stats[spellAbility]);
            const saveDC = 8 + profBonus + abilityMod;
            const attackBonus = profBonus + abilityMod;
            csModalContent.querySelector('[data-field="spellcasting.saveDC"]').value = saveDC;
            csModalContent.querySelector('[data-field="spellcasting.attackBonus"]').value = formatModifier(attackBonus);
        }

        const featureModal = document.getElementById('feature-modal');
        function renderFeatures(features = []) {
            const container = document.getElementById('cs-features-list');
            container.innerHTML = '';
            if (!features || features.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center p-4 font-sans">Nessun privilegio o tratto aggiunto.</p>'; return; }
            const groupedFeatures = features.reduce((acc, feature) => { const type = feature.type || 'Altro'; if (!acc[type]) { acc[type] = []; } acc[type].push(feature); return acc; }, {});
            const groupOrder = ['Razziale', 'Classe', 'Background', 'Privilegio', 'Altro'];
            groupOrder.forEach(groupName => {
                if (groupedFeatures[groupName]) {
                    const groupEl = document.createElement('div');
                    let featuresHtml = groupedFeatures[groupName].map(feature => `<div class="p-1 border-t border-gray-300"><details><summary class="flex justify-between items-center cursor-pointer"><span class="font-bold">${feature.name}</span><div class="flex-shrink-0"><button class="edit-feature-btn text-blue-600 p-1" data-id="${feature.id}">✎</button><button class="delete-feature-btn text-red-600 p-1" data-id="${feature.id}">&times;</button></div></summary><p class="text-sm p-2 mt-1 border-t border-gray-200 bg-white/50 rounded">${(feature.description || '').replace(/\n/g, '<br>')}</p></details></div>`).join('');
                    groupEl.innerHTML = `<h4 class="text-red-800 font-bold mt-2">${groupName}</h4>${featuresHtml}`;
                    container.appendChild(groupEl);
                }
            });
        }
        document.getElementById('cs-add-feature-btn').addEventListener('click', () => openFeatureModal());
        csModalContent.addEventListener('click', e => {
            if (e.target.classList.contains('edit-feature-btn')) { const id = e.target.dataset.id; const feature = window.currentSheetData.features.find(f => f.id === id); if (feature) openFeatureModal(feature); }
            if (e.target.classList.contains('delete-feature-btn')) { const id = e.target.dataset.id; const token = csModal.dataset.currentToken; if (!token) return; let sheetData = window.currentSheetData; sheetData.features = sheetData.features.filter(f => f.id !== id); saveCharacterSheet(token, sheetData); populateCharacterSheet(sheetData); }
        });
        function openFeatureModal(feature = null) {
            featureModal.classList.remove('hidden');
            document.getElementById('feature-form').reset();
            if (feature) {
                document.getElementById('feature-modal-title').textContent = "Modifica Privilegio / Tratto";
                document.getElementById('feature-id').value = feature.id;
                document.getElementById('feature-name').value = feature.name;
                document.getElementById('feature-type').value = feature.type;
                document.getElementById('feature-description').value = feature.description;
            } else {
                document.getElementById('feature-modal-title').textContent = "Aggiungi Privilegio / Tratto";
                document.getElementById('feature-id').value = '';
            }
        }
        document.getElementById('feature-cancel-btn').addEventListener('click', () => featureModal.classList.add('hidden'));
        document.getElementById('feature-form').addEventListener('submit', e => {
            e.preventDefault();
            const token = csModal.dataset.currentToken; if (!token) return;
            const id = document.getElementById('feature-id').value;
            const newFeature = { id: id || crypto.randomUUID(), name: document.getElementById('feature-name').value, type: document.getElementById('feature-type').value, description: document.getElementById('feature-description').value };
            let sheetData = window.currentSheetData;
            if (id) { sheetData.features = sheetData.features.map(f => f.id === id ? newFeature : f); } else { sheetData.features.push(newFeature); }
            saveCharacterSheet(token, sheetData);
            populateCharacterSheet(sheetData);
            featureModal.classList.add('hidden');
        });

        const treasureModal = document.getElementById('treasure-modal');
        function renderOtherTreasures(treasures = []) {
            const container = document.getElementById('cs-other-treasures-list');
            container.innerHTML = treasures.map(item => `<div class="p-1 border-b border-gray-300"><details><summary class="flex justify-between items-center cursor-pointer"><span>${item.name} <em class="text-gray-500 text-xs">(${item.value || 'N/A'})</em></span><div class="flex-shrink-0"><button class="edit-treasure-btn text-blue-600 p-1" data-id="${item.id}">✎</button><button class="delete-treasure-btn text-red-600 p-1" data-id="${item.id}">&times;</button></div></summary><p class="text-sm p-2 mt-1 border-t border-gray-200 bg-white/50 rounded">${(item.description || 'Nessuna descrizione.').replace(/\n/g, '<br>')}</p></details></div>`).join('');
        }
        document.getElementById('cs-add-treasure-btn').addEventListener('click', () => openTreasureModal());
        csModalContent.addEventListener('click', e => {
            if (e.target.classList.contains('edit-treasure-btn')) { const id = e.target.dataset.id; const item = window.currentSheetData.treasure.other.find(i => i.id === id); if (item) openTreasureModal(item); }
            if (e.target.classList.contains('delete-treasure-btn')) { const id = e.target.dataset.id; const token = csModal.dataset.currentToken; if (!token) return; let sheetData = window.currentSheetData; sheetData.treasure.other = sheetData.treasure.other.filter(i => i.id !== id); saveCharacterSheet(token, sheetData); populateCharacterSheet(sheetData); }
        });
        function openTreasureModal(item = null) {
            treasureModal.classList.remove('hidden');
            document.getElementById('treasure-form').reset();
            if (item) {
                document.getElementById('treasure-modal-title').textContent = "Modifica Tesoro";
                document.getElementById('treasure-id').value = item.id;
                document.getElementById('treasure-name').value = item.name;
                document.getElementById('treasure-value').value = item.value;
                document.getElementById('treasure-description').value = item.description;
            } else {
                document.getElementById('treasure-modal-title').textContent = "Aggiungi Tesoro";
                document.getElementById('treasure-id').value = '';
            }
        }
        document.getElementById('treasure-cancel-btn').addEventListener('click', () => treasureModal.classList.add('hidden'));
        document.getElementById('treasure-form').addEventListener('submit', e => {
            e.preventDefault();
            const token = csModal.dataset.currentToken; if (!token) return;
            const id = document.getElementById('treasure-id').value;
            const newItem = { id: id || crypto.randomUUID(), name: document.getElementById('treasure-name').value, value: document.getElementById('treasure-value').value, description: document.getElementById('treasure-description').value };
            let sheetData = window.currentSheetData;
            if (id) { sheetData.treasure.other = sheetData.treasure.other.map(i => i.id === id ? newItem : i); } else { sheetData.treasure.other.push(newItem); }
            saveCharacterSheet(token, sheetData);
            populateCharacterSheet(sheetData);
            treasureModal.classList.add('hidden');
        });

        const companionModal = document.getElementById('companion-modal');
        function renderCompanions(companions = []) {
            const container = document.getElementById('cs-companions-list');
            container.innerHTML = '';
            if (!companions || companions.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center p-2 font-sans">Nessun compagno o gregario aggiunto.</p>'; return; }
            container.innerHTML = companions.map((comp, index) => {
                const statBlock = `FOR ${comp.stats?.str || '-'} | DES ${comp.stats?.dex || '-'} | COS ${comp.stats?.con || '-'} | INT ${comp.stats?.int || '-'} | SAG ${comp.stats?.wis || '-'} | CAR ${comp.stats?.cha || '-'}`;
                return `<div class="cs-box bg-white/80" data-companion-id="${comp.id}"><details><summary class="flex justify-between items-center cursor-pointer"><div><p class="font-bold text-lg">${comp.name || 'Senza Nome'}</p><p class="text-sm text-gray-600">${comp.creatureType || comp.type || 'Compagno'}</p></div><div class="flex-shrink-0"><button class="edit-companion-btn text-blue-600 p-1" data-idx="${index}">✎</button><button class="delete-companion-btn text-red-600 p-1" data-idx="${index}">&times;</button></div></summary><div class="mt-2 pt-2 border-t border-gray-300 space-y-2 text-sm"><div class="grid grid-cols-3 gap-2 text-center"><div><strong>CA:</strong> ${comp.ac || '-'}</div><div><strong>PF:</strong> ${comp.hpCurrent || '-'}/${comp.hpMax || '-'}</div><div><strong>Vel:</strong> ${comp.speed || '-'}</div></div><p class="text-xs text-center bg-gray-200 p-1 rounded">${statBlock}</p>${comp.actions ? `<div><strong class="text-red-800">Azioni:</strong><p class="p-1 bg-gray-100 rounded">${comp.actions.replace(/\n/g, '<br>')}</p></div>` : ''}${comp.features ? `<div><strong class="text-red-800">Tratti & Infusioni:</strong><p class="p-1 bg-gray-100 rounded">${comp.features.replace(/\n/g, '<br>')}</p></div>` : ''}</div></details></div>`;
            }).join('');
        }
        function openCompanionModal(companion = null, idx = null) {
            companionModal.classList.remove('hidden');
            document.getElementById('companion-form').reset();
            document.getElementById('companion-id').value = idx !== null ? idx : '';
            if (companion) {
                document.getElementById('companion-modal-title').textContent = "Modifica Compagno";
                document.getElementById('companion-name').value = companion.name || '';
                document.getElementById('companion-type').value = companion.type || 'Altro';
                document.getElementById('companion-creature-type').value = companion.creatureType || '';
                document.getElementById('companion-ac').value = companion.ac || '';
                document.getElementById('companion-hp-max').value = companion.hpMax || '';
                document.getElementById('companion-hp-current').value = companion.hpCurrent || '';
                document.getElementById('companion-speed').value = companion.speed || '';
                document.getElementById('companion-stat-str').value = companion.stats?.str || '';
                document.getElementById('companion-stat-dex').value = companion.stats?.dex || '';
                document.getElementById('companion-stat-con').value = companion.stats?.con || '';
                document.getElementById('companion-stat-int').value = companion.stats?.int || '';
                document.getElementById('companion-stat-wis').value = companion.stats?.wis || '';
                document.getElementById('companion-stat-cha').value = companion.stats?.cha || '';
                document.getElementById('companion-skills').value = companion.skills || '';
                document.getElementById('companion-senses').value = companion.senses || '';
                document.getElementById('companion-actions').value = companion.actions || '';
                document.getElementById('companion-features').value = companion.features || '';
                document.getElementById('companion-notes').value = companion.notes || '';
            } else {
                document.getElementById('companion-modal-title').textContent = "Aggiungi Compagno / Gregario";
            }
        }
        document.getElementById('companion-cancel-btn').addEventListener('click', () => companionModal.classList.add('hidden'));
        document.getElementById('companion-form').addEventListener('submit', e => {
            e.preventDefault();
            const token = csModal.dataset.currentToken; if (!token) return;
            const idx = document.getElementById('companion-id').value;
            const newCompanion = { id: (idx !== '' && window.currentSheetData.companions[idx]?.id) ? window.currentSheetData.companions[idx].id : crypto.randomUUID(), name: document.getElementById('companion-name').value, type: document.getElementById('companion-type').value, creatureType: document.getElementById('companion-creature-type').value, ac: document.getElementById('companion-ac').value, hpMax: document.getElementById('companion-hp-max').value, hpCurrent: document.getElementById('companion-hp-current').value, speed: document.getElementById('companion-speed').value, stats: { str: document.getElementById('companion-stat-str').value, dex: document.getElementById('companion-stat-dex').value, con: document.getElementById('companion-stat-con').value, int: document.getElementById('companion-stat-int').value, wis: document.getElementById('companion-stat-wis').value, cha: document.getElementById('companion-stat-cha').value, }, skills: document.getElementById('companion-skills').value, senses: document.getElementById('companion-senses').value, actions: document.getElementById('companion-actions').value, features: document.getElementById('companion-features').value, notes: document.getElementById('companion-notes').value, };
            let sheetData = window.currentSheetData;
            if (!sheetData.companions) sheetData.companions = [];
            if (idx !== '') { sheetData.companions[parseInt(idx)] = newCompanion; } else { sheetData.companions.push(newCompanion); }
            saveCharacterSheet(token, sheetData);
            populateCharacterSheet(sheetData);
            companionModal.classList.add('hidden');
        });

       function readSheetFromDOM() {
            const sheetData = JSON.parse(JSON.stringify(window.currentSheetData || createEmptyCharacterSheet()));

            csModalContent.querySelectorAll('[data-field]').forEach(el => {
                if(el.dataset.field === 'featuresTraits' || el.dataset.field === 'armorClass' || el.dataset.field === 'race' || el.dataset.field === 'initiative' || el.dataset.field === 'proficiencyBonus' || el.dataset.field === 'senses.passivePerception') return;
                const fieldPath = el.dataset.field;
                const keys = fieldPath.split('.');
                let current = sheetData;
                keys.forEach((key, index) => { if (index === keys.length - 1) { current[key] = el.value; } else { current[key] = current[key] || {}; current = current[key]; } });
            });
            const raceSelect = document.getElementById('cs-race-select');
            sheetData.race = raceSelect.value === 'Altro...' ? document.getElementById('cs-race-custom').value : raceSelect.value;
            sheetData.proficiencies.saves = Array.from(csModalContent.querySelectorAll('[data-save-prof]:checked')).map(el => el.dataset.saveProf);
            sheetData.proficiencies.skills = Array.from(csModalContent.querySelectorAll('[data-skill-prof]:checked')).map(el => el.dataset.skillProf);
            sheetData.defenses = Array.from(document.querySelectorAll('#cs-defenses-list .defense-item')).map(itemEl => ({ id: itemEl.dataset.id, name: itemEl.querySelector('.cs-defense-name').value, value: itemEl.querySelector('.cs-defense-value').value, type: itemEl.querySelector('.cs-defense-type').value, worn: itemEl.querySelector('.cs-defense-worn').checked }));
            sheetData.classes = Array.from(document.querySelectorAll('#cs-classes-list .class-item')).map(itemEl => { const classSelect = itemEl.querySelector('.cs-class-name'); let className = classSelect.value === 'Altro...' ? itemEl.querySelector('.cs-class-name-custom').value : classSelect.value; return { id: itemEl.dataset.id, name: className, level: itemEl.querySelector('.cs-class-level').value } });
            
            sheetData.deathSaves = { successes: [], failures: [] };
            csModalContent.querySelectorAll('[data-death-save-success]').forEach(el => { sheetData.deathSaves.successes.push(el.checked); });
            csModalContent.querySelectorAll('[data-death-save-failure]').forEach(el => { sheetData.deathSaves.failures.push(el.checked); });
            
            sheetData.spellcasting.class = csModalContent.querySelector('[data-field="spellcasting.class"]').value;
            sheetData.spellcasting.ability = csModalContent.querySelector('[data-field="spellcasting.ability"]').value;
            document.querySelectorAll('.spell-level-container').forEach(container => {
                const level = container.dataset.level;
                if(level > 0) {
                    const totalEl = container.querySelector('.spell-slot-total');
                    const usedEl = container.querySelector('.spell-slot-used');
                    if (totalEl && usedEl) {
                         sheetData.spellcasting.slots[level] = { total: totalEl.value, used: usedEl.value };
                    }
                }
                const spellList = container.querySelector('.spell-list');
                if(spellList) {
                    sheetData.spellcasting.spells[level] = Array.from(spellList.querySelectorAll('details')).map(detailEl => {
                        const checkbox = detailEl.querySelector('.spell-prepared-checkbox');
                        const id = checkbox.dataset.id;
                        const existingSpell = window.currentSheetData.spellcasting.spells[level]?.find(s => s.id === id);
                        return { ...(existingSpell || {}), id: id, prepared: checkbox.checked };
                    });
                }
            });

            return sheetData;
        }

        async function saveCharacterSheet(token, sheetData) {
    window.currentSheetData = sheetData;
    const isPlayerView = csModal.dataset.isPlayerView === 'true';
    const adventureId = isPlayerView ? playerViewId : currentAdventureId;

    if (!adventureId) { console.error("Adventure ID not found for saving sheet."); return; }

    const publicAdventureRef = doc(db, 'publicAdventures', adventureId);

    try {
        const publicAdventureSnap = await getDoc(publicAdventureRef);
        if (!publicAdventureSnap.exists()) { console.error("Public adventure not found."); return; }

        let players = publicAdventureSnap.data().players || [];
        const playerIndex = players.findIndex(p => p.token === token);

        if (playerIndex > -1) {
            players[playerIndex].characterSheet = sheetData;
            if (isPlayerView) {
                await updateDoc(publicAdventureRef, { players: players });
            } else {
                const userId = currentUserId;
                if (!userId) { console.error("DM user ID not found."); return; }
                const adventureRef = doc(db, `users/${userId}/adventures`, adventureId);
                await updateDoc(adventureRef, { players: players });
                await updateDoc(publicAdventureRef, { players: players });
            }
            
            // --- INIZIO MODIFICA CHIAVE ---
            // Aggiorna manualmente lo stato locale per una reattività immediata
            if (currentAdventureData && currentAdventureData.players) {
                const localPlayerIndex = currentAdventureData.players.findIndex(p => p.token === token);
                if (localPlayerIndex > -1) {
                    currentAdventureData.players[localPlayerIndex].characterSheet = sheetData;
                }
            }
            // --- FINE MODIFICA CHIAVE ---
        }
    } catch (error) {
        console.error("Errore salvataggio scheda:", error);
    }
}

        async function addAndTrimDiceRoll(adventureId, rollData) {
            if (!adventureId) { console.error("ID Avventura non trovato per il tiro."); return; }
            const adventureRef = doc(db, 'publicAdventures', adventureId);
            try {
                const adventureSnap = await getDoc(adventureRef);
                if (adventureSnap.exists()) {
                    let diceRolls = adventureSnap.data().diceRolls || [];
                    diceRolls.push(rollData);
                    if (diceRolls.length > 30) {
                        diceRolls = diceRolls.slice(-30);
                    }
                    await updateDoc(adventureRef, { diceRolls: diceRolls });
                }
            } catch (error) {
                console.error("Errore nell'invio del tiro al log:", error);
            }
        }

        async function addRollToLog(rollData) {
            const isPlayerView = csModal.dataset.isPlayerView === 'true';
            const adventureId = isPlayerView ? playerViewId : currentAdventureId;
            await addAndTrimDiceRoll(adventureId, rollData);
        }

        function parseAndRollDamage(damageString) {
            const parts = damageString.toLowerCase().replace(/\s/g, '').split('+');
            let diceTotal = 0;
            const rolls = [];
            let flatBonus = 0;
            for (const part of parts) {
                if (part.includes('d')) {
                    const [numDiceStr, diceSidesStr] = part.split('d');
                    const numDice = parseInt(numDiceStr) || 1;
                    const diceSides = parseInt(diceSidesStr);
                    if (!isNaN(numDice) && !isNaN(diceSides)) {
                        for (let i = 0; i < numDice; i++) {
                            const roll = Math.floor(Math.random() * diceSides) + 1;
                            rolls.push(roll);
                            diceTotal += roll;
                        }
                    }
                } else {
                    const bonus = parseInt(part);
                    if (!isNaN(bonus)) flatBonus += bonus;
                }
            }
            return { diceTotal, rolls, flatBonus };
        }

        async function handleWeaponRoll(type, weaponIndex, isVersatile = false) {
            const token = csModal.dataset.currentToken;
            const player = currentAdventureData.players.find(p => p.token === token);
            if (!player) return;
            let sheetData = player.characterSheet;
            const weapon = sheetData.weapons[parseInt(weaponIndex)];
            if (!weapon) return;

            let rollData;
            let ammoConsumed = false;

            if (type === 'attack') {
                if (weapon.ammunitionType && weapon.ammunitionType.trim() !== '') {
                    const ammoIndex = sheetData.equipment.findIndex(item => item.isAmmunition && item.name?.toLowerCase() === weapon.ammunitionType.toLowerCase());
                    if (ammoIndex > -1) {
                        if (sheetData.equipment[ammoIndex].quantity > 0) {
                            sheetData.equipment[ammoIndex].quantity--;
                            ammoConsumed = true;
                        } else {
                            console.warn(`Munizioni ${sheetData.equipment[ammoIndex].name} terminate!`);
                        }
                    } else {
                        console.warn(`Munizione '${weapon.ammunitionType}' non trovata nell'equipaggiamento.`);
                    }
                }

                const d20Roll = Math.floor(Math.random() * 20) + 1;
                const attackBonusString = calcAttackBonus(weapon, sheetData.stats, sheetData.proficiencyBonus);
                const bonus = parseInt(attackBonusString);
                const total = d20Roll + bonus;
                rollData = { id: crypto.randomUUID(), playerName: player.name, rollNotation: `Attacco con ${weapon.name}`, result: total, details: `Tiro d20: [${d20Roll}] Bonus: ${formatModifier(bonus)}`, timestamp: Date.now() };
            } 
            else if (type === 'damage') {
                const damageString = isVersatile ? weapon.versatileDamage : weapon.damage;
                const { diceTotal, rolls, flatBonus } = parseAndRollDamage(damageString);
                const statForDamage = getAttackStat(weapon, sheetData.stats);
                const abilityMod = getStatMod(statForDamage, sheetData.stats);
                const customBonus = parseInt(weapon.damageBonus) || 0;
                const totalModifier = abilityMod + customBonus + flatBonus;
                const totalDamage = diceTotal + totalModifier;
                rollData = { id: crypto.randomUUID(), playerName: player.name, rollNotation: `Danno con ${weapon.name}${isVersatile ? ' (V)' : ''}`, result: totalDamage, details: `Tiro: [${rolls.join(', ')}] Modificatori: ${formatModifier(totalModifier)}`, timestamp: Date.now() };
            }

            if (rollData) {
                await addRollToLog(rollData);
            }

            if (ammoConsumed) {
                await saveCharacterSheet(token, sheetData);
                populateCharacterSheet(sheetData);
            }
        }

        document.getElementById('cs-modal-close-btn').addEventListener('click', async () => {
    clearTimeout(characterSheetUpdateTimeout);
    const token = csModal.dataset.currentToken;
    if (token) {
        const latestSheetData = readSheetFromDOM();
        await saveCharacterSheet(token, latestSheetData);
    }
    csModal.classList.add('hidden');
});
        
        // --- LOGICA COMBAT TRACKER ---
        function createEmptyCombatState() {
            return {
                isActive: false,
                round: 1,
                currentTurnIndex: 0,
                notes: "",
                combatants: []
            };
        }

        function renderCombatTrackerUI(combatState) {
            const container = document.getElementById('combat-tracker-content');
            if (!combatState.isActive) {
                container.innerHTML = `<button id="start-combat-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg text-xl">Inizia Combattimento</button>`;
                return;
            }

            const sortedCombatants = [...combatState.combatants].sort((a, b) => b.initiative - a.initiative);
            const opponentCount = sortedCombatants.filter(c => !c.isPlayer).length;

            let combatantsHtml = sortedCombatants.map((c, index) => {
                const isCurrentTurn = index === combatState.currentTurnIndex;
                const hpHtml = c.isPlayer ? '' : `<div class="flex items-center gap-1"><input type="number" value="${c.hp}" class="combatant-hp-input bg-gray-600 w-16 text-center rounded-md p-1 text-sm" data-id="${c.id}"><span>/ ${c.maxHp}</span></div>`;
                return `
                    <div class="combatant-item flex items-center justify-between p-2 rounded-lg ${isCurrentTurn ? 'current-turn' : 'bg-gray-700'}" data-id="${c.id}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl font-bold w-8 text-center">${c.initiative}</span>
                            <span class="font-semibold">${c.name}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            ${hpHtml}
                            <input type="text" value="${c.status || ''}" placeholder="Status" class="combatant-status-input bg-gray-600 w-24 rounded-md p-1 text-sm" data-id="${c.id}">
                            <button class="remove-combatant-btn text-red-400 hover:text-red-300 font-bold text-xl" data-id="${c.id}">&times;</button>
                        </div>
                    </div>`;
            }).join('');

            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl">Round <span id="round-counter" class="font-bold text-white">${combatState.round}</span></h3>
                    <h3 class="text-xl">Avversari: <span class="font-bold text-white">${opponentCount}</span></h3>
                </div>
                <div class="flex gap-2 mb-4">
                    <button id="next-turn-btn" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Turno Succ.</button>
                    <button id="end-combat-btn" class="flex-grow bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg">Termina</button>
                </div>
                <div id="initiative-list" class="space-y-2 mb-4">${combatantsHtml}</div>
                <hr class="border-gray-600 my-4">
                <div>
                    <h4 class="text-xl mb-2 text-gray-300">Aggiungi Combattente</h4>
                    <form id="add-combatant-form" class="grid grid-cols-3 gap-2 font-sans text-sm">
                        <input type="text" id="combatant-name" placeholder="Nome" class="bg-gray-700 border border-gray-600 rounded-lg p-2" required>
                        <input type="number" id="combatant-initiative" placeholder="Iniz." class="bg-gray-700 border border-gray-600 rounded-lg p-2" required>
                        <input type="number" id="combatant-hp" placeholder="PF (max)" class="bg-gray-700 border border-gray-600 rounded-lg p-2">
                        <button type="submit" class="col-span-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg mt-1 text-base">Aggiungi</button>
                    </form>
                </div>
                 <hr class="border-gray-600 my-4">
                <div>
                    <h4 class="text-xl mb-2 text-gray-300">Note di Combattimento</h4>
                    <textarea id="combat-notes" class="w-full h-24 bg-gray-700 border border-gray-600 rounded-lg p-2 font-sans text-sm">${combatState.notes || ''}</textarea>
                </div>
            `;
        }
        
        async function saveCombatState(newState) {
            if (!currentAdventureId || !currentUserId) return;
            const adventureRef = doc(db, `users/${currentUserId}/adventures`, currentAdventureId);
            await updateDoc(adventureRef, { combatState: newState });
        }

        document.getElementById('adventure-detail-view').addEventListener('click', async e => {
            if (e.target.id === 'start-combat-btn') {
                const players = currentAdventureData.players || [];
                const combatants = players.map(p => ({
                    id: p.token,
                    name: p.name,
                    initiative: parseInt(prompt(`Iniziativa per ${p.name}:`, '10')) || 10,
                    isPlayer: true,
                    status: ''
                }));
                const newState = { ...createEmptyCombatState(), isActive: true, combatants: combatants };
                await saveCombatState(newState);
            }
            // --- INIZIO CODICE MODIFICATO ---
            if (e.target.id === 'end-combat-btn') {
                // NOTA: Ho rimosso la finestra di conferma (`confirm`) che può causare problemi 
                // in alcuni browser o ambienti di esecuzione.
                // Ora il combattimento termina e si resetta immediatamente al click.
                await saveCombatState(createEmptyCombatState());
            }
            // --- FINE CODICE MODIFICATO ---
            if (e.target.id === 'next-turn-btn') {
                let combatState = currentAdventureData.combatState;
                let newIndex = combatState.currentTurnIndex + 1;
                if (newIndex >= combatState.combatants.length) {
                    newIndex = 0;
                    combatState.round++;
                }
                combatState.currentTurnIndex = newIndex;
                await saveCombatState(combatState);
            }
            const removeBtn = e.target.closest('.remove-combatant-btn');
            if(removeBtn) {
                const combatantId = removeBtn.dataset.id;
                let combatState = currentAdventureData.combatState;
                combatState.combatants = combatState.combatants.filter(c => c.id !== combatantId);
                if (combatState.currentTurnIndex >= combatState.combatants.length && combatState.combatants.length > 0) {
                    combatState.currentTurnIndex = 0;
                }
                await saveCombatState(combatState);
            }
        });

        document.getElementById('adventure-detail-view').addEventListener('submit', async e => {
            if (e.target.id === 'add-combatant-form') {
                e.preventDefault();
                const name = document.getElementById('combatant-name').value;
                const initiative = parseInt(document.getElementById('combatant-initiative').value);
                const maxHp = parseInt(document.getElementById('combatant-hp').value) || null;
                
                if (name && !isNaN(initiative)) {
                    const newCombatant = {
                        id: crypto.randomUUID(),
                        name,
                        initiative,
                        isPlayer: false,
                        hp: maxHp,
                        maxHp: maxHp,
                        status: ''
                    };
                    let combatState = currentAdventureData.combatState;
                    combatState.combatants.push(newCombatant);
                    await saveCombatState(combatState);
                    e.target.reset();
                }
            }
        });
        
        document.getElementById('adventure-detail-view').addEventListener('input', e => {
            const target = e.target;
            const isCombatInput = target.matches('.combatant-hp-input, .combatant-status-input, #combat-notes');
            if (!isCombatInput) return;

            clearTimeout(combatTrackerUpdateTimeout);
            combatTrackerUpdateTimeout = setTimeout(() => {
                let combatState = { ...currentAdventureData.combatState };
                if (target.id === 'combat-notes') {
                    combatState.notes = target.value;
                } else {
                    const combatantId = target.dataset.id;
                    const combatantIndex = combatState.combatants.findIndex(c => c.id === combatantId);
                    if (combatantIndex > -1) {
                        if (target.classList.contains('combatant-hp-input')) {
                            combatState.combatants[combatantIndex].hp = parseInt(target.value);
                        } else if (target.classList.contains('combatant-status-input')) {
                            combatState.combatants[combatantIndex].status = target.value;
                        }
                    }
                }
                saveCombatState(combatState);
            }, 500);
        });

    </script>
</body>
</html>
